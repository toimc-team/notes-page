(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{1200:function(t,s,a){"use strict";a.r(s);var n=a(11),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey},scopedSlots:t._u([{key:"auth",fn:function(){return[s("h3",{attrs:{id:"课程福利nginx配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#课程福利nginx配置"}},[t._v("#")]),t._v(" 课程福利nginx配置")]),t._v(" "),s("p",[t._v("nginx的配置文件地址："),s("a",{attrs:{href:"https://gist.github.com/toimc/24df7ea1adab57ee9560062ae9905c2a",target:"_blank",rel:"noopener noreferrer"}},[t._v("github"),s("OutboundLink")],1)]),t._v(" "),s("h3",{attrs:{id:"场景一-配置博客应用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#场景一-配置博客应用"}},[t._v("#")]),t._v(" 场景一：配置博客应用")]),t._v(" "),s("p",[t._v("添加宿主机的docker目录映射：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("web")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("latest\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"some-nginx"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/nginx/nginx.conf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/nginx/nginx.conf\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/nginx/conf.d"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/nginx/conf.d\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/keys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/home/keys\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# blog")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/blog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/www\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"80:80"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"443:443"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker network create https")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("external")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https\n")])])]),s("p",[t._v("nginx的配置文件 "),s("code",[t._v("conf.d/vhost.conf")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# listen on HTTP2/SSL")]),t._v("\nserver "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" ssl http2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server_name www.wayearn.com"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ssl certs from letsencrypt")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ssl on;")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 这里要注意目录是docker里面的目录，所以建议大家把容器里面的目录与宿主机的目录映射一致")]),t._v("\n  ssl_certificate /home/keys/certs.pem"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_certificate_key /home/keys/key.pem"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# dhparam.pem")]),t._v("\n  ssl_dhparam /home/keys/dhparam.pem"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  ssl_session_cache shared:SSL:50m"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_session_timeout 30m"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_session_tickets off"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  ssl_protocols TLSv1 TLSv1.1 TLSv1.2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ciphers chosen for forward secrecy and compatibility")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# http://blog.ivanristic.com/2013/08/configuring-apache-nginx-and-openssl-for-forward-secrecy.html")]),t._v("\n  ssl_ciphers "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  ssl_prefer_server_ciphers on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  add_header Strict-Transport-Security "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"max-age=31536000; includeSubdomains; preload"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  location / "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    root /var/www/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    index index.html"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header Host "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$server_port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header X-Real-IP "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header X-Forwarded-For "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$proxy_add_x_forwarded_for")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header X-Forwarded-Proto "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$scheme")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# redirect HTTP and handle let's encrypt requests")]),t._v("\nserver "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server_name www.wayearn.com"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  location / "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("301")]),t._v(" https://"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$request_uri")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("检测ssl网站的评级 myssl.com：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(916),alt:"image-20210810220929142"}})]),t._v(" "),s("h3",{attrs:{id:"场景二-配置小程序api接口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#场景二-配置小程序api接口"}},[t._v("#")]),t._v(" 场景二：配置小程序API接口")]),t._v(" "),s("p",[t._v("步骤：")]),t._v(" "),s("ul",[s("li",[t._v("api -> 线上 -> nginx进行代理 ；")]),t._v(" "),s("li",[t._v("api部署到线上的服务器；")]),t._v(" "),s("li",[t._v("api服务可以被nginx访问到；")]),t._v(" "),s("li",[t._v("域名 + https形式去访问 -> 提供api服务\n"),s("ul",[s("li",[t._v("配置nginx的vhost配置 + 配置域名解析dns")]),t._v(" "),s("li",[t._v("wx.yourdomain.com -> 指向服务器的IP")]),t._v(" "),s("li",[t._v("重启nginx容器让vhost的配置生效 -> 测试服务")])])])]),t._v(" "),s("p",[t._v("小程序的docker-compose文件：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("web")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("context")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" .\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dockerfile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Dockerfile\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("args")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("Version"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" api_online"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("tag"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" api_online\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# env_file: .env")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_USER=$DB_USER\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_PASS=$DB_PASS\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_HOST=$DB_HOST\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_PORT=$DB_PORT\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_NAME=$DB_NAME\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" REDIS_HOST=$REDIS_HOST\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" REDIS_PORT=$REDIS_PORT\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" REDIS_PASS=$REDIS_PASS\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${PORT}:3000"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${WS_PORT}:3001"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/imooc/online"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/app/public\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 关键就是这里，配置API项目的网络，连接到https网络")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 然后，使用vhost配置，让Nginx进行代理")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("external")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https\n")])])]),s("p",[t._v("可选方案：提供Mongo、redis环境的"),s("code",[t._v("docker-compose.yml")]),t._v("文件：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("web")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("context")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" .\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dockerfile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Dockerfile\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("args")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" api_online"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" api_online\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# env_file: .env")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_USER=toimc\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_PASS=long_random_pass_mongo\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_HOST=mongo\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_PORT=27017\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_NAME=community\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" REDIS_HOST=redis\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" REDIS_PORT=6379\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" REDIS_PASS=long_random_pass_redis\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10030:3000"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10031:3001"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/imooc/online"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/app/public\n\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mongo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mongo\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mongodb"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/imooc/db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/data/db\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/imooc/db/initdb.d"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/docker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("entrypoint"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("initdb.d/\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# .sh & .js")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"27017:27017"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MONGO_INITDB_ROOT_USERNAME")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" root\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MONGO_INITDB_ROOT_PASSWORD")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" example\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MONGO_INITDB_DATABASE")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" testdb\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MONGO_INITDB_USERNAME")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" toimc\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MONGO_INITDB_PASSWORD")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" long_random_pass_mongo\n\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("redis")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" redis\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"redis"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"6379:6379"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("requirepass long_random_pass_redis\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("external")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https\n")])])]),s("p",[t._v("MongoDB的初始化文件"),s("code",[t._v("init.d/mongo-init.sh")]),t._v("文件：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("mongo -- "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$MONGO_INITDB_DATABASE")]),t._v('"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\nvar rootUser = '"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$MONGO_INITDB_ROOT_USERNAME")]),t._v("';\nvar rootPassword = '"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$MONGO_INITDB_ROOT_PASSWORD")]),t._v("';\nvar initDB = '"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$MONGO_INITDB_DATABASE")]),t._v("'\nvar admin = db.getSiblingDB(initDB);\nadmin.auth(rootUser, rootPassword);\n\nvar user = '"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$MONGO_INITDB_USERNAME")]),t._v("';\nvar passwd = '"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$MONGO_INITDB_PASSWORD")]),t._v('\';\ndb.createUser({ user: user, pwd: passwd, roles: ["dbOwner"] });\nEOF')]),t._v("\n")])])]),s("p",[t._v("手动部署API服务：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("使用docker命令进行docker镜像的构建")])]),t._v(" "),s("li",[s("p",[t._v("推送镜像或者使用手动方式导入镜像")]),t._v(" "),s("p",[t._v("保存(Save)")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v(" # 保留原镜像的名称和标签\n docker save <IMAGE NAME>:<IMAGE TAG> > save.tar\n\n # 不保留原镜像的基本信息,加载load后需执行tag命令重命名none镜像\n docker save <IMAGE ID> > save.tar \n")])])]),s("p",[t._v("示例:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("docker save elasticsearch:7.1.1 > elasticsearch-7.1.1.tar\n# 或\ndocker save b0cb1543380d > elasticsearch-7.1.1.tar\n")])])]),s("p",[t._v("加载(Load)")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("docker load < save.tar\n")])])]),s("p",[t._v("示列:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("docker load < elasticsearch-7.1.1.tar\n")])])])]),t._v(" "),s("li",[s("p",[t._v("配置nginx文件"),s("code",[t._v("/home/nginx/conf.d/ws.conf")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("upstream target-server "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  server api_online:3001 "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("fail_timeout")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# listen on HTTP2/SSL")]),t._v("\nserver "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" ssl http2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server_name ws.wayearn.com"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ssl certs from letsencrypt")]),t._v("\n  ssl_certificate /home/acme/fullchain.pem"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_certificate_key /home/acme/key.pem"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# dhparam.pem")]),t._v("\n  ssl_dhparam /home/acme/dhparam.pem"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_session_timeout 5m"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_protocols TLSv1 TLSv1.1 TLSv1.2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_ciphers "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_prefer_server_ciphers on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  location / "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    proxy_set_header X-Forwarded-Ssl on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_redirect off"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header Host "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$server_port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header X-Real-IP "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header X-Forwarded-For "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$proxy_add_x_forwarded_for")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header X-Forwarded-Proto "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$scheme")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_pass http://target-server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header Upgrade "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$http_upgrade")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header Connection "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Upgrade'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# redirect HTTP and handle let's encrypt requests")]),t._v("\nserver "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server_name ws.wayearn.com"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# send everything else to HTTPS")]),t._v("\n  rewrite ^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(".*"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("$ https://"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$1")]),t._v(" permanent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("添加dns解析")]),t._v(" "),s("p",[s("img",{attrs:{src:a(917),alt:"image-20210810223431309"}})])]),t._v(" "),s("li",[s("p",[t._v("导入镜像，启动api服务：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(918),alt:"image-20210810223550333"}})]),t._v(" "),s("p",[t._v("使用"),s("code",[t._v("docker-compose up -d")]),t._v("启动服务：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(919),alt:"image-20210810223613863"}})])]),t._v(" "),s("li",[s("p",[t._v("重启nginx服务：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("docker restart some-nginx\n")])])]),s("p",[t._v("网络互访：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("docker network inspect https\n")])])]),s("p",[s("img",{attrs:{src:a(920),alt:"image-20210810223801721"}})])])]),t._v(" "),s("h3",{attrs:{id:"排查问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#排查问题"}},[t._v("#")]),t._v(" 排查问题")]),t._v(" "),s("ul",[s("li",[t._v("常见的防火墙问题：")])]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看防火墙的运行状态")]),t._v("\nfirewall-cmd "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--state")]),t._v("\n\nfirewall-cmd --add-port"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--permanenet")]),t._v("\n\nfirewall-cmd "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--reload")]),t._v("\n")])])]),s("ul",[s("li",[t._v("云服务商的放行策略：")])]),t._v(" "),s("p",[t._v("华为云示例：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(921),alt:"image-20210810221145314"}})]),t._v(" "),s("p",[t._v("腾讯云：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(922),alt:"image-20210810221210594"}})]),t._v(" "),s("h3",{attrs:{id:"小程序接口联调"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#小程序接口联调"}},[t._v("#")]),t._v(" 小程序接口联调")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("nginx启动之后，就可以访问"),s("code",[t._v("https://域名")]),t._v("了")])]),t._v(" "),s("li",[s("p",[t._v("导出测试数据库")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-it")]),t._v(" mongodb mongodump "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-u")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" testdb "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-o")]),t._v(" /tmp/\n")])])]),s("p",[t._v("使用docker cp命令来复制目录：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("容器id"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(":/tmp/testdb /tmp/本地目录\n")])])])]),t._v(" "),s("li",[s("p",[t._v("导入数据库")]),t._v(" "),s("p",[t._v("上传上面的本地目录的文件到线上的服务器。")]),t._v(" "),s("p",[t._v("mongodb恢复数据库的命令：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" /home/docker/testdb "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("容器id"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(":/tmp/\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-it")]),t._v(" mongodb mongorestore "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-u")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" testdb /tmp/testdb\n")])])]),s("p",[s("img",{attrs:{src:a(923),alt:"image-20210810224430465"}})])])]),t._v(" "),s("p",[t._v("请求测试：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(924),alt:"image-20210810224507919"}})]),t._v(" "),s("ul",[s("li",[s("p",[t._v("微信小程序配置安全域名")]),t._v(" "),s("p",[t._v("开发 -> 开发设置 -> 安全域名")]),t._v(" "),s("p",[s("img",{attrs:{src:a(925),alt:"image-20210810224610237"}})]),t._v(" "),s("p",[t._v("添加域名：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(926),alt:"image-20210810224636162"}})]),t._v(" "),s("p",[t._v("​")]),t._v(" "),s("p",[t._v("下面即可以在微信开发者工具中进行测试了，取消"),s("code",[t._v("不校验合法域名")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(927),alt:"image-20210810224714543"}})])])])]},proxy:!0}])},[s("h1",{attrs:{id:"安全域名相关"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安全域名相关"}},[t._v("#")]),t._v(" 安全域名相关")]),t._v(" "),s("p",[t._v("微信小程序的安全域名必须是HTTPS，同时必须是在国内ICP备案的域名，本章来介绍如何使用acme.sh+nginx配置https与申请SSL证书。")]),t._v(" "),s("h2",{attrs:{id:"ssl证书申请"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ssl证书申请"}},[t._v("#")]),t._v(" SSL证书申请")]),t._v(" "),s("h3",{attrs:{id:"前置准备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前置准备"}},[t._v("#")]),t._v(" 前置准备")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("申请域名：阿里云、腾讯云等各家云服务商；")])]),t._v(" "),s("li",[s("p",[t._v("有一台云主机，有公网的IP，最好进行过备案；如果没有国内的服务器，也可以注册一台国外的服务器，地址1："),s("a",{attrs:{href:"https://bwh81.net/aff.php?aff=6389",target:"_blank",rel:"noopener noreferrer"}},[t._v("搬瓦工"),s("OutboundLink")],1),t._v("，地址2："),s("a",{attrs:{href:"https://www.vultr.com/?ref=6862890",target:"_blank",rel:"noopener noreferrer"}},[t._v("vultr"),s("OutboundLink")],1),t._v("；")])]),t._v(" "),s("li",[s("p",[t._v("云主机的操作系统：Centos 7+（"),s("u",[t._v("以下所有演示内容，均为Centos 7")]),t._v("）或者Ubuntu 16LTS+；")])]),t._v(" "),s("li",[s("p",[t._v("DNS解析：DNSpod，cloudflare；")]),t._v(" "),s("p",[t._v("配置域名进行解析：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(928),alt:"image-20210810145545806"}})]),t._v(" "),s("p",[t._v("使用A记录，配置自己的域名 -> 自己的云主机IP")]),t._v(" "),s("p",[t._v("使用ping命令检查 是否已经网络通了：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(929),alt:"image-20210810145801200"}})])])]),t._v(" "),s("h3",{attrs:{id:"整体架构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#整体架构"}},[t._v("#")]),t._v(" 整体架构")]),t._v(" "),s("p",[t._v("配置架构图：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(930),alt:"image-20210810144327946"}})]),t._v(" "),s("h3",{attrs:{id:"基本步骤"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本步骤"}},[t._v("#")]),t._v(" 基本步骤")]),t._v(" "),s("p",[t._v("借助"),s("a",{attrs:{href:"https://github.com/acmesh-official/acme.sh/wiki/%E8%AF%B4%E6%98%8E",target:"_blank",rel:"noopener noreferrer"}},[t._v("acme.sh"),s("OutboundLink")],1),t._v("进行申请SSL证书，以便微信接口部分的使用，下面演示的是DNSpod进行证书申请的过程。")]),t._v(" "),s("p",[s("strong",[t._v("主要步骤：")])]),t._v(" "),s("p",[t._v("前置：使用ssh命令连接到服务器 ->")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("安装 "),s("strong",[t._v("acme.sh")])])]),t._v(" "),s("li",[s("p",[t._v("生成证书 ——"),s("a",{attrs:{href:"https://github.com/acmesh-official/acme.sh/wiki/dnsapi",target:"_blank",rel:"noopener noreferrer"}},[t._v("推荐DNS的方式"),s("OutboundLink")],1)]),t._v(" "),s("blockquote",[s("p",[t._v("支持的DNS列表："),s("a",{attrs:{href:"https://github.com/acmesh-official/acme.sh/tree/master/dnsapi",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/acmesh-official/acme.sh/tree/master/dnsapi"),s("OutboundLink")],1)])])]),t._v(" "),s("li",[s("p",[t._v("copy 证书到 nginx/apache 或者其他服务")])]),t._v(" "),s("li",[s("p",[t._v("更新证书")])]),t._v(" "),s("li",[s("p",[t._v("更新 "),s("strong",[t._v("acme.sh")])])])]),t._v(" "),s("h3",{attrs:{id:"acme-sh安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#acme-sh安装"}},[t._v("#")]),t._v(" acme.sh安装")]),t._v(" "),s("p",[t._v("安装很简单, 一个命令:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("curl  https://get.acme.sh | sh -s email=my@example.com\n")])])]),s("p",[s("img",{attrs:{src:a(931),alt:"image-20210810145930893"}})]),t._v(" "),s("p",[t._v("再次打开一个新的ssh终端，使用"),s("code",[t._v("crontab -e")]),t._v("(Centos)查看"),s("code",[t._v("acme.sh")]),t._v("自动创建的定时任务：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(932),alt:"image-20210810150236024"}})]),t._v(" "),s("p",[t._v("输入"),s("code",[t._v("i")]),t._v("进入编辑模式，调整如上图所示，使用"),s("code",[t._v(":wq")]),t._v("退出。")]),t._v(" "),s("blockquote",[s("p",[t._v("PS：上面的配置是每天的0点23分去执行一次脚本。")])]),t._v(" "),s("h3",{attrs:{id:"配置dns密钥"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置dns密钥"}},[t._v("#")]),t._v(" 配置DNS密钥")]),t._v(" "),s("p",[t._v("下面介绍了DNSpod、阿里云、Cloudflare的配置过程，大家可以根据自己的云服务商选择，过程类似。")]),t._v(" "),s("h4",{attrs:{id:"dnspod"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dnspod"}},[t._v("#")]),t._v(" DNSpod")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("选择密钥管理：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(933),alt:"image-20210810150640094"}})])]),t._v(" "),s("li",[s("p",[t._v("创建密钥")]),t._v(" "),s("p",[s("img",{attrs:{src:a(934),alt:"image-20210810150731394"}})])]),t._v(" "),s("li",[s("p",[t._v("记录下来，后续使用：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(935),alt:"image-20210810150751582"}})])])]),t._v(" "),s("p",[t._v("配置密钥：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DPI_Id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1234"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DPI_Key")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sADDsdasdgdsf"')]),t._v("\n")])])]),s("h4",{attrs:{id:"阿里云"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#阿里云"}},[t._v("#")]),t._v(" 阿里云")]),t._v(" "),s("p",[t._v("点击："),s("a",{attrs:{href:"https://ak-console.aliyun.com/#/accesskey",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://ak-console.aliyun.com/#/accesskey"),s("OutboundLink")],1),t._v("，申请密钥：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(936),alt:"image-20210810151001761"}})]),t._v(" "),s("p",[t._v("选择"),s("code",[t._v("编程访问")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(937),alt:"image-20210810151252035"}})]),t._v(" "),s("p",[t._v("生成accessKey与密钥：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(938),alt:"image-20210810151319187"}})]),t._v(" "),s("p",[t._v("配置过程：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("Ali_Key")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sdfsdfsdfljlbjkljlkjsdfoiwje"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("Ali_Secret")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"jlsdflanljkljlfdsaklkjflsa"')]),t._v("\n")])])]),s("h4",{attrs:{id:"cloudflare"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cloudflare"}},[t._v("#")]),t._v(" Cloudflare")]),t._v(" "),s("p",[t._v("配置"),s("a",{attrs:{href:"https://dash.cloudflare.com/profile",target:"_blank",rel:"noopener noreferrer"}},[t._v("页面"),s("OutboundLink")],1),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(939),alt:"image-20210810151518194"}})]),t._v(" "),s("p",[t._v("配置过程：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("CF_Key")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sdfsdfsdfljlbjkljlkjsdfoiwje"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("CF_Email")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxx@sss.com"')]),t._v("\n")])])]),s("h3",{attrs:{id:"产生证书"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#产生证书"}},[t._v("#")]),t._v(" 产生证书")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("Dnspod:")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("acme.sh "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--issue")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--dns")]),t._v(" dns_dpi "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" example.com "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" www.example.com\n")])])])]),t._v(" "),s("li",[s("p",[t._v("阿里云：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("acme.sh "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--issue")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--dns")]),t._v(" dns_ali "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" example.com "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" www.example.com\n")])])])]),t._v(" "),s("li",[s("p",[t._v("Cloudflare：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("acme.sh "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--issue")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--dns")]),t._v(" dns_cf "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" example.com "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" www.example.com\n")])])])])]),t._v(" "),s("blockquote",[s("p",[t._v("推荐域名通配符的写法：example.com 与 *.example.com，那么二级子域名，全部都可以使用https。")])]),t._v(" "),s("p",[t._v("过程1：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(940),alt:"image-20210810152354761"}})]),t._v(" "),s("p",[t._v("上面的图片是展示出在对域名进行校验。")]),t._v(" "),s("p",[t._v("过程2：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(941),alt:"image-20210810152415177"}})]),t._v(" "),s("p",[t._v("证书申请成功，证书所在位置。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("cer 自签\nkey 密钥\nCA 中间证书\n把CA与cert链接到一起的证书，这个是后续放在nginx上的，用于服务器之间的协商\n")])])]),s("h2",{attrs:{id:"nginx配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx配置"}},[t._v("#")]),t._v(" Nginx配置")]),t._v(" "),s("h3",{attrs:{id:"前置准备-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前置准备-2"}},[t._v("#")]),t._v(" 前置准备")]),t._v(" "),s("p",[s("img",{attrs:{src:a(942),alt:"image-20210810205823556"}})]),t._v(" "),s("p",[t._v("步骤：")]),t._v(" "),s("ul",[s("li",[t._v("安装docker,docker-compose -> nginx")]),t._v(" "),s("li",[t._v("docker-compose来启动nginx")]),t._v(" "),s("li",[t._v("创建一个https docker网络 -> 共享给github, jenkins 等需要https的服务")]),t._v(" "),s("li",[t._v("配置"),s("code",[t._v("nginx.conf")]),t._v("配置文件，创建"),s("code",[t._v("conf.d")]),t._v("文件目录，可以创建虚拟域名"),s("code",[t._v("vhost.conf")]),t._v("文件")]),t._v(" "),s("li",[t._v("使用证书安装命令安装ssl证书  -> 到指定的目录")]),t._v(" "),s("li",[s("code",[t._v("docker-compose up -d")]),t._v("运行nginx容器 -> 测试cron定时任务脚本")])]),t._v(" "),s("h3",{attrs:{id:"证书安装命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#证书安装命令"}},[t._v("#")]),t._v(" 证书安装命令")]),t._v(" "),s("p",[t._v("Apache配置:")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("acme.sh --install-cert "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" example.com "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--cert-file      /path/to/certfile/in/apache/cert.pem  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--key-file       /path/to/keyfile/in/apache/key.pem  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--fullchain-file /path/to/fullchain/certfile/apache/fullchain.pem "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--reloadcmd")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"service apache2 force-reload"')]),t._v("\n")])])]),s("p",[t._v("Nginx配置:")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("acme.sh --install-cert "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" example.com "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--key-file       /path/to/keyfile/in/nginx/key.pem  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--fullchain-file /path/to/fullchain/nginx/cert.pem "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--reloadcmd")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"service nginx force-reload"')]),t._v("\n")])])]),s("blockquote",[s("p",[s("code",[t._v("--reloadcmd")]),t._v("可以指定docker容器进行重启，或者是指定运行shell脚本。")]),t._v(" "),s("p",[t._v("比如：")]),t._v(" "),s("p",[s("code",[t._v('--reloadcmd "docker restart some-nginx"')])])]),t._v(" "),s("h3",{attrs:{id:"dhparam-pem证书"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dhparam-pem证书"}},[t._v("#")]),t._v(" dhparam.pem证书")]),t._v(" "),s("p",[t._v("创建一个目录："),s("code",[t._v("/home/keys")])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("# 生成 dhparam.pem 文件, 在命令行执行任一方法:\n\n# 方法1: 很慢\nopenssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048\n\n# 方法2: 较快\n# 与方法1无明显区别. 2048位也足够用, 4096更强\nopenssl dhparam -dsaparam -out /etc/nginx/ssl/dhparam.pem 4096\n")])])]),s("p",[t._v("把dhparam.pem复制到个人SSL证书安装相同的目录"),s("code",[t._v("/home/keys")]),t._v("。")]),t._v(" "),s("h3",{attrs:{id:"docker配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker配置"}},[t._v("#")]),t._v(" docker配置")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("手动创建网络")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("docker network create https\n")])])]),s("p",[s("img",{attrs:{src:a(943),alt:"image-20210810210138510"}})]),t._v(" "),s("blockquote",[s("p",[t._v("查看网络 "),s("code",[t._v("docker network ls")])]),t._v(" "),s("p",[t._v("检查网络的信息 "),s("code",[t._v("docker network inspect https")])])])]),t._v(" "),s("li",[s("p",[t._v("创建"),s("code",[t._v("docker-compose.yml")]),t._v("文件")])])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("web")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("latest\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"some-nginx"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/nginx/nginx.conf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/nginx/nginx.conf\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/nginx/conf.d"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/nginx/conf.d\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/keys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/home/keys\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# blog")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - /home/blog:/var/www")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"80:80"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"443:443"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker network create https")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("external")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https\n")])])]),s("h3",{attrs:{id:"nginx-conf配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-conf配置"}},[t._v("#")]),t._v(" nginx.conf配置")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("user nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nworker_processes auto"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\npid /run/nginx.pid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nworker_rlimit_nofile "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("65535")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nevents "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置事件驱动模型，是内核2.6以上支持")]),t._v("\n\tuse epoll"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tworker_connections "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("65535")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\taccept_mutex off"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tmulti_accept off"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nhttp "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Basic Settings")]),t._v("\n\tsendfile on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ttcp_nopush on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ttcp_nodelay on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tsend_timeout "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("120")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tkeepalive_timeout "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("300")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tclient_body_timeout "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("300")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tclient_header_timeout "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("120")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\tproxy_read_timeout "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("300")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tproxy_send_timeout "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("300")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#tcp_nopush on;")]),t._v("\n\ttypes_hash_max_size "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4096")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tclient_header_buffer_size 16m"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tclient_max_body_size 4096m"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加nginx的配置文件目录 -> 用户后期添加vhost文件")]),t._v("\n\tinclude /etc/nginx/mime.types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tinclude /etc/nginx/conf.d/*.conf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\tdefault_type application/octet-stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Logging Settings")]),t._v("\n\taccess_log /var/log/nginx/access.log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\terror_log /var/log/nginx/error.log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tlog_format main "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'$remote_addr - $remote_user [$time_local] \"$request\" '")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'$status $body_bytes_sent \"$http_referer\" '")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'"$http_user_agent" "$http_x_forwarded_for"\'')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 开启gzip")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("gzip")]),t._v(" on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启用gzip压缩的最小文件，小于设置值的文件将不会压缩")]),t._v("\n\tgzip_min_length 1k"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# gzip 压缩级别，1-10，数字越大压缩的越好，也越占用CPU时间，后面会有详细说明")]),t._v("\n\tgzip_comp_level "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 进行压缩的文件类型。javascript有多种形式。其中的值可以在 mime.types 文件中找到。")]),t._v("\n\tgzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png font/ttf font/otf image/svg+xml"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 是否在http header中添加Vary: Accept-Encoding，建议开启")]),t._v("\n\tgzip_vary on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 禁用IE 6 gzip")]),t._v("\n\tgzip_disable "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MSIE [1-6]\\."')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"安装证书启动nginx"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装证书启动nginx"}},[t._v("#")]),t._v(" 安装证书启动nginx")]),t._v(" "),s("p",[s("img",{attrs:{src:a(944),alt:"image-20210810211832312"}})]),t._v(" "),s("p",[t._v("测试Nignx的配置文件：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("docker exec -it some-nginx nginx -t\n")])])]),s("p",[s("img",{attrs:{src:a(945),alt:"image-20210810220403001"}})])])}),[],!1,null,null,null);s.default=e.exports},916:function(t,s,a){t.exports=a.p+"assets/img/image-20210810220929142.1537ad70.png"},917:function(t,s,a){t.exports=a.p+"assets/img/image-20210810223431309.368c5c94.png"},918:function(t,s,a){t.exports=a.p+"assets/img/image-20210810223550333.d0fedae0.png"},919:function(t,s,a){t.exports=a.p+"assets/img/image-20210810223613863.5fbb1359.png"},920:function(t,s,a){t.exports=a.p+"assets/img/image-20210810223801721.cc7b1e2f.png"},921:function(t,s,a){t.exports=a.p+"assets/img/image-20210810221145314.e34347c6.png"},922:function(t,s,a){t.exports=a.p+"assets/img/image-20210810221210594.0b72c5d5.png"},923:function(t,s,a){t.exports=a.p+"assets/img/image-20210810224430465.e62eb13b.png"},924:function(t,s,a){t.exports=a.p+"assets/img/image-20210810224507919.89fa22dc.png"},925:function(t,s,a){t.exports=a.p+"assets/img/image-20210810224610237.4224a675.png"},926:function(t,s,a){t.exports=a.p+"assets/img/image-20210810224636162.9792e446.png"},927:function(t,s,a){t.exports=a.p+"assets/img/image-20210810224714543.439e8328.png"},928:function(t,s,a){t.exports=a.p+"assets/img/image-20210810145545806.a0e07748.png"},929:function(t,s,a){t.exports=a.p+"assets/img/image-20210810145801200.cc140063.png"},930:function(t,s,a){t.exports=a.p+"assets/img/image-20210810144327946.bbb98c11.png"},931:function(t,s,a){t.exports=a.p+"assets/img/image-20210810145930893.237427d0.png"},932:function(t,s,a){t.exports=a.p+"assets/img/image-20210810150236024.e82227d2.png"},933:function(t,s,a){t.exports=a.p+"assets/img/image-20210810150640094.3d656e26.png"},934:function(t,s,a){t.exports=a.p+"assets/img/image-20210810150731394.b27888e3.png"},935:function(t,s,a){t.exports=a.p+"assets/img/image-20210810150751582.43ca872b.png"},936:function(t,s,a){t.exports=a.p+"assets/img/image-20210810151001761.9040174d.png"},937:function(t,s,a){t.exports=a.p+"assets/img/image-20210810151252035.d404c680.png"},938:function(t,s,a){t.exports=a.p+"assets/img/image-20210810151319187.d113629f.png"},939:function(t,s,a){t.exports=a.p+"assets/img/image-20210810151518194.3045c842.png"},940:function(t,s,a){t.exports=a.p+"assets/img/image-20210810152354761.b8f93ecb.png"},941:function(t,s,a){t.exports=a.p+"assets/img/image-20210810152415177.a8f72743.png"},942:function(t,s,a){t.exports=a.p+"assets/img/image-20210810205823556.b18f986b.png"},943:function(t,s,a){t.exports=a.p+"assets/img/image-20210810210138510.dce600c7.png"},944:function(t,s,a){t.exports=a.p+"assets/img/image-20210810211832312.c848f3ae.png"},945:function(t,s,a){t.exports=a.p+"assets/img/image-20210810220403001.ba89c359.png"}}]);