(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{1207:function(t,s,a){"use strict";a.r(s);var n=a(11),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey},scopedSlots:t._u([{key:"auth",fn:function(){return[s("h3",{attrs:{id:"注册企业流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注册企业流程"}},[t._v("#")]),t._v(" 注册企业流程")]),t._v(" "),s("p",[t._v("![图片 1](./assets/图片 1.png)")]),t._v(" "),s("p",[t._v("企业注册流程中，需要注意的点：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("准备工作（场地、人员、名称）")]),t._v(" "),s("p",[t._v("公司查名各地有各地的查询网址或者在工商管理部门办事大厅进行现场查重（因为可能会重名，所以需要多准备几个）")]),t._v(" "),s("p",[t._v("湖北企业查名查重：http://scjg.hubei.gov.cn/ICPSP/newNamecheck/nameCheck.action")]),t._v(" "),s("p",[t._v("企业经营范围查询网址：https://jyfwyun.com/")])]),t._v(" "),s("li",[s("p",[t._v("提交资料（章程、住所证明）")]),t._v(" "),s("p",[t._v("可以在当地的区（县）政务中心领取材料 或者在其网站上下载对应的模板文件，自行打印与复印。")])]),t._v(" "),s("li",[s("p",[t._v("办理税务+银行开户")]),t._v(" "),s("p",[t._v("当办理完企业登记，并核发营业执照之后，可以输税务与企业银行开户。")]),t._v(" "),s("p",[t._v("各家银行的开户费用大体相同，只是服务可能不一样，大家可以选择几家对比一下。推荐：招商与中兴。")]),t._v(" "),s("p",[t._v("选择银行需要注意：")]),t._v(" "),s("ul",[s("li",[t._v("服务问题；")]),t._v(" "),s("li",[t._v("便利性——不要选择一家离自己办公点或者家很远的地方；")])])])]),t._v(" "),s("h3",{attrs:{id:"个人工商户与企业区别"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#个人工商户与企业区别"}},[t._v("#")]),t._v(" 个人工商户与企业区别")]),t._v(" "),s("p",[t._v("共同点：")]),t._v(" "),s("ul",[s("li",[t._v("流程：个体要记账、交税、年检、审批，也会被抽查")]),t._v(" "),s("li",[t._v("税费：与小微企业无异")])]),t._v(" "),s("p",[t._v("不同点：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("债务：个体负责到底-无限，公司申请破产保护-有限责任")])]),t._v(" "),s("li",[s("p",[t._v("规模：个体8人不能上市，公司可以设立分机构、上市")])]),t._v(" "),s("li",[s("p",[t._v("业务：个体不能做进出口业务")])]),t._v(" "),s("li",[s("p",[t._v("经营 ：个体限制经营范围")])]),t._v(" "),s("li",[s("p",[t._v("税费：税种不一样，征收方式不一样")])])]),t._v(" "),s("h3",{attrs:{id:"自己注册vs代注册"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#自己注册vs代注册"}},[t._v("#")]),t._v(" 自己注册vs代注册")]),t._v(" "),s("p",[s("strong",[t._v("自己注册：")])]),t._v(" "),s("p",[t._v("优点：")]),t._v(" "),s("ul",[s("li",[t._v("没有费用")])]),t._v(" "),s("p",[t._v("缺点：")]),t._v(" "),s("ul",[s("li",[t._v("需要花时间")]),t._v(" "),s("li",[t._v("需要了解整体流程")]),t._v(" "),s("li",[t._v("需要去税务、银行")])]),t._v(" "),s("p",[s("strong",[t._v("代注册：")])]),t._v(" "),s("p",[t._v("优点：")]),t._v(" "),s("ul",[s("li",[t._v("省时间")]),t._v(" "),s("li",[t._v("省事（办证、税务、企业银行、注册地、资料准备一条龙）")])]),t._v(" "),s("p",[t._v("缺点：")]),t._v(" "),s("ul",[s("li",[t._v("费用不等，从3000-6000，甚至更多；")]),t._v(" "),s("li",[t._v("后续可能会有代账、年租费用等；")]),t._v(" "),s("li",[t._v("开票&办税也会收费；")])]),t._v(" "),s("h3",{attrs:{id:"报税-开票"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#报税-开票"}},[t._v("#")]),t._v(" 报税&开票")]),t._v(" "),s("p",[t._v("大多数企业会找一个代账会计或者找一个代账公司，而企业前期是无需会计的，完全可以零报税，操作流程非常的简单。")]),t._v(" "),s("p",[t._v("如果不清楚报税的流程，可以在税务机关处进行现场报税。")]),t._v(" "),s("p",[t._v("代账费用：从200元到300元/月不等。")]),t._v(" "),s("p",[t._v("找了代账的企业需要会看如下的几个表格，了解概念：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("利润表：你赚了多少钱！")])]),t._v(" "),s("li",[s("p",[t._v("资产负债表：有没有欠你的钱、你欠的钱，余下的钱")])])]),t._v(" "),s("p",[t._v("除了找代账公司以外，Brain更推荐自己在前期进行记账与报税，流程不复杂，而且软件非常的智能，只用填入自己的收入与支出，财务软件可以自动形成报表。")]),t._v(" "),s("p",[t._v("财务软件推荐：")]),t._v(" "),s("ul",[s("li",[t._v("金碟")]),t._v(" "),s("li",[t._v("用友")])]),t._v(" "),s("p",[t._v("云平台推荐：")]),t._v(" "),s("ul",[s("li",[t._v("柠檬云")])]),t._v(" "),s("blockquote",[s("p",[t._v("季度+年度报税：3个月报季报，照着软件填")])]),t._v(" "),s("h3",{attrs:{id:"企业日常的开销"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#企业日常的开销"}},[t._v("#")]),t._v(" 企业日常的开销")]),t._v(" "),s("p",[t._v("主要分为如下几类：")]),t._v(" "),s("ul",[s("li",[t._v("资产：办公设备如打印机、办公桌椅、空调等")]),t._v(" "),s("li",[t._v("费用：租赁场地、水+电+网")]),t._v(" "),s("li",[t._v("费用：人员（会计、开发、产品等）")]),t._v(" "),s("li",[t._v("...")])]),t._v(" "),s("p",[t._v("从上面的分类来看，注册企业没有什么费用，反而是维持一个企业的运转是需要大量费用的。大家在准备企业开办之前，需要有一定的准备。")]),t._v(" "),s("blockquote",[s("p",[t._v("不打没有准备的仗，也不要什么都准备好了，才开始！！")])]),t._v(" "),s("h2",{attrs:{id:"支付前置必要条件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#支付前置必要条件"}},[t._v("#")]),t._v(" 支付前置必要条件")]),t._v(" "),s("p",[t._v("下面以微信支付为例，来介绍，开发支付功能需要准备的前置条件：")]),t._v(" "),s("ul",[s("li",[t._v("选择合适的主体&场景（企业服务号）微信（支付宝）认证；")]),t._v(" "),s("li",[t._v("域名+公网IP+HTTPS；")]),t._v(" "),s("li",[t._v("云服务器ICP备案；")])]),t._v(" "),s("p",[t._v("微信支付：")]),t._v(" "),s("ul",[s("li",[t._v("主体问题：订阅号非媒体号无法支付，推荐企业服务号；")]),t._v(" "),s("li",[t._v("小程序：必须HTTPS + ICP备案；")]),t._v(" "),s("li",[t._v("开通商户号，也需要企业主体，与公众号&小程序同一主体；")])]),t._v(" "),s("p",[t._v("支付宝支付：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("主体问题：企业主体；")])]),t._v(" "),s("li",[s("p",[t._v("行业类目及资质要求，"),s("a",{attrs:{href:"https://opendocs.alipay.com/iot/multi-platform/material",target:"_blank",rel:"noopener noreferrer"}},[t._v("文档"),s("OutboundLink")],1),t._v("；")]),t._v(" "),s("p",[t._v("而且对于实体店铺审核要严格一些。")])])]),t._v(" "),s("p",[s("img",{attrs:{src:a(976),alt:"image-20210830134004706"}})]),t._v(" "),s("p",[t._v("说明：")]),t._v(" "),s("ul",[s("li",[t._v("关于ICP备案，可以参考："),s("a",{attrs:{href:"https://beian.aliyun.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("阿里云"),s("OutboundLink")],1),t._v("、"),s("a",{attrs:{href:"https://cloud.tencent.com/product/ba",target:"_blank",rel:"noopener noreferrer"}},[t._v("腾讯云"),s("OutboundLink")],1),t._v("（前置条件：域名、云服务器）；")]),t._v(" "),s("li",[t._v("HTTPS：必须要有域名，必须要有一台云服务器；")]),t._v(" "),s("li",[t._v("微信商户号，对应的网址：https://pay.weixin.qq.com/")])]),t._v(" "),s("h2",{attrs:{id:"小程序支付流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#小程序支付流程"}},[t._v("#")]),t._v(" 小程序支付流程")]),t._v(" "),s("h3",{attrs:{id:"开发技巧"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开发技巧"}},[t._v("#")]),t._v(" 开发技巧")]),t._v(" "),s("ul",[s("li",[t._v("技术问题，先读文档，查找官方的社区；")]),t._v(" "),s("li",[t._v("比较主流的支付方案，可以搜索一下有没有Node.js侧的npm包，例如："),s("a",{attrs:{href:"https://www.npmjs.com/package/wechatpay-axios-plugin",target:"_blank",rel:"noopener noreferrer"}},[t._v("wechatpay-axios-plugin"),s("OutboundLink")],1),t._v("是一个非常不错的支持v2/v3的npm包，ts风格；")]),t._v(" "),s("li",[t._v("问stackoverflow、知乎、csdn等；")]),t._v(" "),s("li",[t._v("最后，才考虑自己开发轮子；")])]),t._v(" "),s("p",[t._v("如果是学习，也可以从0到1的开发，了解整个支付的流程。")]),t._v(" "),s("h3",{attrs:{id:"流程图"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#流程图"}},[t._v("#")]),t._v(" 流程图")]),t._v(" "),s("p",[t._v("学会看时序图：")]),t._v(" "),s("ul",[s("li",[t._v("最上面的是角色")]),t._v(" "),s("li",[t._v("从左往右看，按照箭头的方向走")]),t._v(" "),s("li",[t._v("从上往下看，是时间关系流程的流转")])]),t._v(" "),s("p",[s("img",{attrs:{src:a(977),alt:"img"}})]),t._v(" "),s("p",[t._v("重点步骤说明：")]),t._v(" "),s("p",[t._v("步骤3：用户下单发起支付，商户可通过"),s("a",{attrs:{href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_1.shtml",target:"_blank",rel:"noopener noreferrer"}},[t._v("JSAPI下单"),s("OutboundLink")],1),t._v("创建支付订单。")]),t._v(" "),s("p",[t._v("步骤8： 用户可通过"),s("a",{attrs:{href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_4.shtml",target:"_blank",rel:"noopener noreferrer"}},[t._v("小程序调起支付API"),s("OutboundLink")],1),t._v("调起微信支付，发起支付请求。")]),t._v(" "),s("p",[t._v("步骤15：用户支付成功后，商户可接收到微信支付支付结果通知"),s("a",{attrs:{href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_5.shtml",target:"_blank",rel:"noopener noreferrer"}},[t._v("支付通知API"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("p",[t._v("步骤20：商户在没有接收到微信支付结果通知的情况下需要主动调用"),s("a",{attrs:{href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_2.shtml",target:"_blank",rel:"noopener noreferrer"}},[t._v("查询订单API"),s("OutboundLink")],1),t._v("查询支付结果。")]),t._v(" "),s("h2",{attrs:{id:"搭建开发环境"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#搭建开发环境"}},[t._v("#")]),t._v(" 搭建开发环境")]),t._v(" "),s("h3",{attrs:{id:"支付准备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#支付准备"}},[t._v("#")]),t._v(" 支付准备")]),t._v(" "),s("p",[s("img",{attrs:{src:a(978),alt:"image-20210830135731466"}})]),t._v(" "),s("p",[t._v("按照上面的流程，准备相关的开发环境，参考指引："),s("a",{attrs:{href:"https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_8_1.shtml",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方链接"),s("OutboundLink")],1)]),t._v(" "),s("h3",{attrs:{id:"配置https-域名解析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置https-域名解析"}},[t._v("#")]),t._v(" 配置Https+域名解析")]),t._v(" "),s("p",[t._v("说明：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("前置的章节有介绍HTTPS介绍，"),s("RouterLink",{attrs:{to:"/project/community-miniapp/07-安全域名相关.html#ssl证书申请"}},[t._v("文章")])],1)]),t._v(" "),s("li",[s("p",[t._v("域名解析以阿里云为例：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(979),alt:"image-20210830140428900"}})])])]),t._v(" "),s("h3",{attrs:{id:"配置api密钥"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置api密钥"}},[t._v("#")]),t._v(" 配置API密钥")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://pay.weixin.qq.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("商户平台"),s("OutboundLink")],1),t._v(" -> 账户中心 -> API安全，分别配置API商户证书 + APIv3密钥")]),t._v(" "),s("p",[s("img",{attrs:{src:a(980),alt:"image-20210830140522534"}})]),t._v(" "),s("h3",{attrs:{id:"配置frp内网穿透"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置frp内网穿透"}},[t._v("#")]),t._v(" 配置frp内网穿透")]),t._v(" "),s("p",[t._v("为了方便测试微信支付通知，有两种方案：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("上传API服务到测试服务器：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(981),alt:"image-20210830140648414"}})])]),t._v(" "),s("li",[s("p",[t._v("使用本地的API服务，需要使用frp工具把远程的通知转发到本地：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(982),alt:"image-20210830140722039"}})])])]),t._v(" "),s("p",[t._v("配置过程如下：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("下载frp包到本地，见"),s("a",{attrs:{href:"https://github.com/fatedier/frp/releases",target:"_blank",rel:"noopener noreferrer"}},[t._v("release"),s("OutboundLink")],1),t._v("（darwin是mac系统、windows、Linux要分arm与amd）；")])]),t._v(" "),s("li",[s("p",[t._v("SSH到远程服务端，新建配置文件"),s("code",[t._v("/home/frp/frps.ini")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[t._v("[common]\nbind_port = 10010\nvhost_https_port = 443\n")])])])]),t._v(" "),s("li",[s("p",[t._v("在服务器上运行frps，使用docker镜像：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("docker run --restart=always --network host -d -v /home/frp/frps.ini:/etc/frp/frps.ini --name frps snowdreamtech/frps\n")])])])]),t._v(" "),s("li",[s("p",[t._v("下载let's encrypt创建的SSL证书 -> 一般在acme生成的目录中->放置到本地解压的frp目录中；")]),t._v(" "),s("p",[s("img",{attrs:{src:a(983),alt:"image-20210830141415349"}})])]),t._v(" "),s("li",[s("p",[t._v("在本地创建"),s("code",[t._v("frpc.ini")]),t._v("文件")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[t._v("[common]\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_addr")]),t._v(" = 121.36.194.226\nserver_port = "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10010")]),t._v("\n\n[test_htts2http]\ntype = https\ncustom_domains = test1.toimc.com\n\nplugin = https2http\nplugin_local_addr = 127.0.0.1:3000\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# HTTPS 证书相关的配置")]),t._v("\nplugin_crt_path = ./fullchain.pem\nplugin_key_path = ./key.pem\nplugin_host_header_rewrite = 127.0.0.1\nplugin_header_X-From-Where = frp")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("test1.toimc.com")]),t._v(" -> vhost_https_port "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" test1.toimc.com:443 -> frp -> 127.0.0.1:3000\n")])])])]),t._v(" "),s("li",[s("p",[t._v("使用frpc运行该配置文件：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("chmod +x frpc\n./frpc -c ./frpc.ini\n")])])]),s("p",[t._v("运行成功的提示：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(984),alt:"image-20210830141622200"}})])])]),t._v(" "),s("p",[t._v("如果运行失败，可以在"),s("a",{attrs:{href:"https://gofrp.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方网站"),s("OutboundLink")],1),t._v("上查询失败的原因：")]),t._v(" "),s("ul",[s("li",[t._v("官方FAQ：https://gofrp.org/docs/faq/")]),t._v(" "),s("li",[t._v("官方Issues：https://github.com/fatedier/frp/issues")])]),t._v(" "),s("h2",{attrs:{id:"apiv3-vs-apiv2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#apiv3-vs-apiv2"}},[t._v("#")]),t._v(" APIv3 vs APIv2")]),t._v(" "),s("p",[t._v("为了在 保证支付 安全的前提下，带给商户 简单、一致且易用的开发体验，我们推出了全新的微信支付API v3。")]),t._v(" "),s("p",[t._v("相较于之前的微信支付API，主要区别是：")]),t._v(" "),s("ul",[s("li",[t._v("遵循统一的REST 的设计风格")]),t._v(" "),s("li",[t._v("使用JSON作为数据交互的格式，不再使用XML")]),t._v(" "),s("li",[t._v("使用基于非对称密钥的SHA256-RSA的数字签名算法，不再使用MD5或HMAC-SHA256")]),t._v(" "),s("li",[t._v("不再要求HTTPS客户端证书")]),t._v(" "),s("li",[t._v("使用AES-256-GCM，对回调中的关键信息进行加密保护")])]),t._v(" "),s("p",[t._v("APIv3的文档："),s("a",{attrs:{href:"https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay-1.shtml",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方链接"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("两个接口的对接图：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[s("strong",[t._v("V3")])]),t._v(" "),s("th",[s("strong",[t._v("规则差异")])]),t._v(" "),s("th",[s("strong",[t._v("V2")])])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("JSON")]),t._v(" "),s("td",[t._v("参数格式")]),t._v(" "),s("td",[t._v("XML")])]),t._v(" "),s("tr",[s("td",[t._v("POST、GET  或 DELETE")]),t._v(" "),s("td",[t._v("提交方式")]),t._v(" "),s("td",[t._v("POST")])]),t._v(" "),s("tr",[s("td",[t._v("AES-256-GCM加密")]),t._v(" "),s("td",[t._v("回调加密")]),t._v(" "),s("td",[t._v("无需加密")])]),t._v(" "),s("tr",[s("td",[t._v("RSA  加密")]),t._v(" "),s("td",[t._v("敏感加密")]),t._v(" "),s("td",[t._v("无需加密")])]),t._v(" "),s("tr",[s("td",[t._v("UTF-8")]),t._v(" "),s("td",[t._v("编码方式")]),t._v(" "),s("td",[t._v("UTF-8")])]),t._v(" "),s("tr",[s("td",[t._v("非对称密钥SHA256-RSA")]),t._v(" "),s("td",[t._v("签名方式")]),t._v(" "),s("td",[t._v("MD5  或 HMAC-SHA256")])])])]),t._v(" "),s("p",[s("strong",[t._v("推荐：在没有接触v2的情况下，直接上手v3；如果有老旧业务，也可以对接到v3，或者不动原有的业务，直至v2的证书快过期，需要更换时，再切换到v3。")])]),t._v(" "),s("h2",{attrs:{id:"jsapi统一下单"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#jsapi统一下单"}},[t._v("#")]),t._v(" JSAPI统一下单")]),t._v(" "),s("h3",{attrs:{id:"签名生成"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#签名生成"}},[t._v("#")]),t._v(" 签名生成")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay4_0.shtml",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方文档"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("商户可以按照下述步骤生成请求的签名，微信支付API v3 要求商户对请求进行签名，微信支付会在收到请求后进行签名的验证。")]),t._v(" "),s("p",[s("strong",[t._v("如果签名验证不通过，微信支付API v3将会拒绝处理请求，并返回"),s("code",[t._v("401 Unauthorized")]),t._v("。")])]),t._v(" "),s("p",[t._v("签名生成的步骤有：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("构造签名串")]),t._v(" "),s("p",[t._v("签名串一共有五行，每一行为一个参数。行尾以 "),s("code",[t._v("\\n")]),t._v("（换行符，ASCII编码值为0x0A）结束，包括最后一行。如果参数本身以"),s("code",[t._v("\\n")]),t._v("结束，也需要附加一个"),s("code",[t._v("\\n")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("HTTP")]),t._v("请求方法\\n\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("URL")]),t._v("\\n\n请求时间戳\\n\n请求随机串\\n\n请求报文主体\\n \n")])])])]),t._v(" "),s("li",[s("p",[t._v("计算签名值")]),t._v(" "),s("p",[t._v("使用商户私钥对待签名串进行SHA256 with RSA签名，并对签名结果进行Base64编码得到签名值，示例：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-n")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET'),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("/v3/certificates"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("1554208460"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("593BEC0C930BF1AFEB40B4A08C8FB242"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" openssl dgst "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-sha256")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-sign")]),t._v(" apiclient_key.pem "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" openssl base64 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-A")]),t._v("\n  uOVRnA4qG/MNnYzdQxJanN+zU+lTgIcnU9BxGw5dKjK+VdEUz2FeIoC+D5sB/LN+nGzX3hfZg6r5wT1pl2ZobmIc6p0ldN7J6yDgUzbX8Uk3sD4a4eZVPTBvqNDoUqcYMlZ9uuDdCvNv4TM3c1WzsXUrExwVkI1XO5jCNbgDJ25nkT/c1gIFvqoogl7MdSFGc4W4xZsqCItnqbypR3RuGIlR9h9vlRsy7zJR9PBI83X8alLDIfR1ukt1P7tMnmogZ0cuDY8cZsd8ZlCgLadmvej58SLsIkVxFJ8XyUgx9FmutKSYTmYtWBZ0+tNvfGmbXU7cob8H/4nLBiCwIUFluw"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v("\n")])])])])]),t._v(" "),s("p",[t._v("第一步比较好实现：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// HTTP请求方法\\n")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// URL\\n  https://www.imooc.com/path1/path2/?query1=value")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求时间戳\\n")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求随机串\\n")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求报文主体\\n")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" tmpUrl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("URL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" nonceStr "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" rand"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("generate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" pathname "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token regex"}},[s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[t._v("http")]),s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" tmpUrl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pathname "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" url\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" timestamp "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("floor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" message "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("method"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toUpperCase")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("pathname "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" tmpUrl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("search\n  "),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("timestamp"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("nonceStr"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("body "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("stringify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("body"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n")])])]),s("p",[t._v("第二步的RSA的算法实现思路：")]),t._v(" "),s("ul",[s("li",[t._v("找一下微信社区有没有类似实现")]),t._v(" "),s("li",[t._v("找一下网上有没有类似实现")]),t._v(" "),s("li",[t._v("找一下有没有npm开源包")]),t._v(" "),s("li",[t._v("找一下stackoverflow或者百度")]),t._v(" "),s("li",[t._v("...")])]),t._v(" "),s("p",[t._v("如果 以上都没有，那么就要自己造轮子了。但是这样的场景少之有少，哈哈，还轮不上大家自己上。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("rsaSign")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("message")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" keyPem "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFileSync")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__dirname"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'keys/apiclient_key.pem'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'utf-8'")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" signature "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" crypto\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createSign")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'RSA-SHA256'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("update")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("message"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'utf-8'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sign")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("keyPem"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'base64'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" signature\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("然后使用上面合成的message进行签名即可：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" signature "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("rsaSign")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("message"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[s("strong",[t._v("如何验证呢？")])]),t._v(" "),s("p",[t._v("方案一：")]),t._v(" "),s("p",[t._v("Linux或者mac直接使用openssl来进行验证")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('echo -n -e \\\n"GET\\n/v3/certificates\\n1554208460\\n593BEC0C930BF1AFEB40B4A08C8FB242\\n\\n" \\\n  | openssl dgst -sha256 -sign apiclient_key.pem \\\n  | openssl base64 -A\n')])])]),s("p",[t._v("方案二：")]),t._v(" "),s("p",[t._v("使用老师给大家准备的docker镜像进行验证"),s("code",[t._v("lw96/libressl")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1.创建容器")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-itd")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" ssl lw96/libressl\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2.拷贝证书")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" 证书目录 容器id:/tmp\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3.进入容器")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-it")]),t._v(" ssl "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sh")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 4.使用上面的一样的命令")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-n")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET'),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("/v3/certificates"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("1554208460"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("593BEC0C930BF1AFEB40B4A08C8FB242"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" openssl dgst "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-sha256")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-sign")]),t._v(" /tmp/apiclient_key.pem "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" openssl base64 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-A")]),t._v("\n")])])]),s("h3",{attrs:{id:"authentication头部密钥串"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#authentication头部密钥串"}},[t._v("#")]),t._v(" Authentication头部密钥串")]),t._v(" "),s("p",[t._v("微信支付商户API v3要求请求通过"),s("code",[t._v("HTTP Authorization")]),t._v("头来传递签名。"),s("code",[t._v("Authorization")]),t._v("由"),s("em",[t._v("认证类型")]),t._v("和"),s("em",[t._v("签名信息")]),t._v("两个部分组成。")]),t._v(" "),s("p",[t._v("下面我们使用命令行演示如何生成签名。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Authorization: 认证类型 签名信息\n")])])]),s("p",[t._v("具体组成为：")]),t._v(" "),s("p",[t._v("1.认证类型，目前为WECHATPAY2-SHA256-RSA2048")]),t._v(" "),s("p",[t._v("2.签名信息")]),t._v(" "),s("ul",[s("li",[t._v("发起请求的商户（包括直连商户、服务商或渠道商）的商户号"),s("code",[t._v("mchid")])]),t._v(" "),s("li",[s("a",{attrs:{href:"https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay3_1.shtml",target:"_blank",rel:"noopener noreferrer"}},[t._v("商户API证书"),s("OutboundLink")],1),s("code",[t._v("serial_no")]),t._v("，用于"),s("a",{attrs:{href:"https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay3_1.shtml#part-3",target:"_blank",rel:"noopener noreferrer"}},[t._v("声明所使用的证书"),s("OutboundLink")],1),t._v("（管理员账号登录微信商户管理后台，在API安全里面点击查看证书可以获取。）")]),t._v(" "),s("li",[t._v("请求随机串"),s("code",[t._v("nonce_str")])]),t._v(" "),s("li",[t._v("时间戳"),s("code",[t._v("timestamp")])]),t._v(" "),s("li",[t._v("签名值"),s("code",[t._v("signature")])]),t._v(" "),s("li",[t._v("注：以上五项签名信息，无顺序要求。")])]),t._v(" "),s("p",[s("code",[t._v("Authorization")]),t._v(" 头的示例如下：（注意，示例因为排版可能存在换行，实际数据应在一行）")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("Authorization: WECHATPAY2-SHA256-RSA2048 "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("mchid")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1900009191"')]),t._v(",nonce_str"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v('"593BEC0C930B\n')])])]),s("p",[t._v("最终我们可以组一个包含了签名的HTTP请求了。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" https://api.mch.weixin.qq.com/v3/certificates "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-H")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'Authorization: WECHATPAY2-SHA256-RSA2048 mchid="1900009191",nonce_str="593BEC0C930BF1AFEB40B4A08C8FB242",signature="uOVRnA4qG/MNnYzdQxJanN+zU+lTgIcnU9BxGw5dKjK+VdEUz2FeIoC+D5sB/LN+nGzX3hfZg6r5wT1pl2ZobmIc6p0ldN7J6yDgUzbX8Uk3sD4a4eZVPTBvqNDoUqcYMlZ9uuDdCvNv4TM3c1WzsXUrExwVkI1XO5jCNbgDJ25nkT/c1gIFvqoogl7MdSFGc4W4xZsqCItnqbypR3RuGIlR9h9vlRsy7zJR9PBI83X8alLDIfR1ukt1P7tMnmogZ0cuDY8cZsd8ZlCgLadmvej58SLsIkVxFJ8XyUgx9FmutKSYTmYtWBZ0+tNvfGmbXU7cob8H/4nLBiCwIUFluw==",timestamp="1554208460",serial_no="1DDE55AD98ED71D6EDD4A4A16996DE7B47773A8C"\'')]),t._v("\n")])])]),s("p",[t._v("代码示例：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// config.js")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" mchid "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'xxxxx'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" serialNo "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'xxxxx'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  mchid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  serialNo\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// WxPay.js")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("getSignHeaders")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" method"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" body")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// HTTP请求方法\\n")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// URL\\n  https://www.imooc.com/path1/path2/?query1=value")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求时间戳\\n")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求随机串\\n")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求报文主体\\n")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" tmpUrl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("URL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" nonceStr "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" rand"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("generate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" pathname "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token regex"}},[s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[t._v("http")]),s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" tmpUrl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pathname "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" url\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" timestamp "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("floor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" message "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("method"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toUpperCase")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("pathname "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" tmpUrl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("search\n    "),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("timestamp"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("nonceStr"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("body "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("stringify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("body"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// const keyPem = fs.readFileSync(path.join(__dirname, 'keys/apiclient_key.pem'), 'utf-8')")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// const signature = crypto.createSign('RSA-SHA256').update(message, 'utf-8').sign(keyPem, 'base64')")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" signature "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("rsaSign")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("message"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1.解决问题：windows上无openssl -> lw96/libressl")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2.需要传递apiclient_key.pem给镜像 -> 因为只有在容器里面才能执行openssl")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3.method1: docker cp  method2: -v")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 4.使用openssl进行签名 -> 对比crypto产生的base64串")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("headers")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('WECHATPAY2-SHA256-RSA2048 mchid="')]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mchid"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('",nonce_str="')]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("nonceStr"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('",signature="')]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("signature"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('",timestamp="')]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("timestamp"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('",serial_no="')]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serialNo"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"'")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    nonceStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    timestamp\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"接口说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#接口说明"}},[t._v("#")]),t._v(" 接口说明")]),t._v(" "),s("p",[t._v("接口文档："),s("a",{attrs:{href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_1.shtml",target:"_blank",rel:"noopener noreferrer"}},[t._v("JSAPI"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("**请求URL：**https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi")]),t._v(" "),s("p",[t._v("**请求方式：**POST")]),t._v(" "),s("p",[t._v("形成随机的商户订单号：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("getTradeNo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 服务端侧：out_trade_no -> 订单号 -> timestamp + type + id")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1.Date.now()  2.Moment/dayjs")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 01-小程序")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("dayjs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("format")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'YYYYMMDDHHmmssSSS'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'01'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n    Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("random")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toString")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("substr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("最终，统一订单的接口：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("wxJSPAY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("params")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    description"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    goodsTag"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    total"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" openid "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    detail"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    sceneInfo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    settleInfo\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" params\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 小程序用户侧： description，amount:{total} -> token -> id -> openid")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 参数准备")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" wxParams "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("appid")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AppID"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("mchid")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mchid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    description"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("out_trade_no")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getTradeNo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("time_expire")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("dayjs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'m'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("format")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("attach")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("notify_url")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://test1.toimc.com/public/notify'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("goods_tag")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" goodsTag"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("amount")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("total")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parseInt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("total"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("currency")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'CNY'")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("payer")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      openid\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    detail"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("scene_info")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" sceneInfo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("settle_info")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" settleInfo\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" url "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi'")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 头部签名  ")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" headers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nonceStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" timestamp "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getSignHeaders")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'post'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    wxParams\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" result "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("post")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wxParams"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("headers")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("Authorization")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" headers\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'🚀 ~ file: WxPay.js ~ line 53 ~ wxJSPAY ~ result'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" status"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" result\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("status "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("prepayId")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prepay_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nonceStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" timestamp "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("wxJSPAY error: ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("result"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("wxJSPAY error: ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"用户支付"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#用户支付"}},[t._v("#")]),t._v(" 用户支付")]),t._v(" "),s("h3",{attrs:{id:"支付步骤"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#支付步骤"}},[t._v("#")]),t._v(" 支付步骤")]),t._v(" "),s("p",[t._v("前端步骤：")]),t._v(" "),s("ul",[s("li",[t._v("用户下单 -> 发起请求，让后端生成支付参数")]),t._v(" "),s("li",[t._v("用户支付 -> wx.requestPayment调起支付")])]),t._v(" "),s("p",[t._v("后端步骤：")]),t._v(" "),s("ul",[s("li",[t._v("使用JSAPI统一下单，产生的prepay_id（预支付id）")]),t._v(" "),s("li",[t._v("构造签名串 -> 计算签名")]),t._v(" "),s("li",[t._v("返回前端支付参数")])]),t._v(" "),s("h3",{attrs:{id:"准备支付参数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#准备支付参数"}},[t._v("#")]),t._v(" 准备支付参数")]),t._v(" "),s("p",[t._v("第一步：")]),t._v(" "),s("p",[s("strong",[t._v("造签名串")])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("签名串一共有四行，每一行为一个参数。行尾以\\n（换行符，ASCII编码值为0x0A）结束，包括最后一行。\n如果参数本身以\\n结束，也需要附加一个\\n\n")])])]),s("p",[s("strong",[t._v("参与签名字段及格式：")])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("小程序appId\n时间戳\n随机字符串\n订单详情扩展字符串\n")])])]),s("p",[t._v("第二步：")]),t._v(" "),s("p",[s("strong",[t._v("计算签名：")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-n")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wx8888888888888888'),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("1414561699"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("5K8264ILTKCH16CQ2502SI8ZNMTM67VS"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("prepay_id=wx201410272009395522657a690389285100"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" openssl dgst "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-sha256")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-sign")]),t._v(" apiclient_key.pem "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" openssl base64 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-A")]),t._v("\n")])])]),s("p",[t._v("参数：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"left"}},[t._v("参数名")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("变量")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("类型[长度限制]")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("必填")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("时间戳")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("timeStamp")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("string[1,32]")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("是")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("当前的时间，其他详见"),s("a",{attrs:{href:"https://pay.weixin.qq.com/wiki/doc/api/wxpay_v2/jiekouguize/chapter1_2.shtml#part-5",target:"_blank",rel:"noopener noreferrer"}},[t._v("时间戳规则"),s("OutboundLink")],1),t._v("。 示例值：1414561699")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("随机字符串")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("nonceStr")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("string[1,32]")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("是")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("随机字符串，不长于32位。 示例值：5K8264ILTKCH16CQ2502SI8ZNMTM67VS")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("订单详情扩展字符串")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("package")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("string[1,128]")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("是")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("小程序下单接口返回的prepay_id参数值，提交格式如：prepay_id=*** 示例值：prepay_id=wx201410272009395522657a690389285100")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("签名方式")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("signType")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("string[1,32]")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("是")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("签名类型，默认为RSA，仅支持RSA。 示例值：RSA")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("签名")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("paySign")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("string[1,512]")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("是")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("签名，使用字段appId、timeStamp、nonceStr、package计算得出的签名值 示例值")])])])]),t._v(" "),s("h3",{attrs:{id:"后端接口开发"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#后端接口开发"}},[t._v("#")]),t._v(" 后端接口开发")]),t._v(" "),s("p",[t._v("创建路由：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 微信用户下单")]),t._v("\nrouter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("post")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/wxOrder'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" userController"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wxOrder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("创建"),s("code",[t._v("wxOrder")]),t._v("下单方法：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wxOrder")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" body "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 为什么订单的total即商品的金额信息不能从前端传？")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 从前端传商品的id -> 在后端查询对应id的商品价格")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" description"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" total "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" body\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" user "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" User"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("findByID")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" params "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    description"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    total"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    user\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 发起wxPay -> prepay_id")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" prepayId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nonceStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" timestamp "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wxJSPAY")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("params"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 小程序appId")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 时间戳")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 随机字符串")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 订单详情扩展字符串")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" paySign "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("rsaSign")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AppID"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("timestamp"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("nonceStr"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\nprepay_id=")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("prepayId"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 拼接数据返回前端")]),t._v("\n  ctx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("code")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("appId")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AppID"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      timestamp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      nonceStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("prepay_id=")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("prepayId"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("signType")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'RSA'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      paySign\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"前端模拟下单-支付"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前端模拟下单-支付"}},[t._v("#")]),t._v(" 前端模拟下单&支付")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("order")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" res "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$u"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("api"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("orderGoods")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("description")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'toimc测试商品'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("total")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 单位分")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// console.log('🚀 ~ file: order.vue ~ line 23 ~ order ~ res', res)")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" code"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" res\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("code "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("orderParams "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" data\n    uni"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("showToast")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("icon")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'none'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("title")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'下单成功'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("duration")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2000")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pay")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  uni"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("requestPayment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("provider")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'weixin'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("orderInfo")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("description")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'toimc测试商品'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("total")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 单位分")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("timeStamp")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("orderParams"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("timestamp "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("nonceStr")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("orderParams"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("nonceStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("orderParams"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("package"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("signType")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("orderParams"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("signType"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("paySign")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("orderParams"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("paySign"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("complete")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("res")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'🚀 ~ file: order.vue ~ line 47 ~ pay ~ res'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// errMsg: "requestPayment:ok" -> 支付成功')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// errMsg: "requestPayment:fail cancel" -> 取消')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"订单查询"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#订单查询"}},[t._v("#")]),t._v(" 订单查询")]),t._v(" "),s("p",[t._v("用户支付成功后，需要接受微信平台的被动通知或者是主动查询订单的支付状态。")]),t._v(" "),s("p",[t._v("原因：可能用户支付成功后，微信后台已经给了用户侧反馈，但是由于网络问题，商户平台可能未收到通知。")]),t._v(" "),s("img",{staticStyle:{zoom:"50%"},attrs:{src:a(985),alt:"image-20210830173043224"}}),t._v(" "),s("h3",{attrs:{id:"微信主动通知"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#微信主动通知"}},[t._v("#")]),t._v(" 微信主动通知")]),t._v(" "),s("p",[t._v("frp转发通知，只需要创建对应的接口，然后在JSAPI统一下单的接口中指定回调的域名即可。")]),t._v(" "),s("p",[t._v("**请求方式：**POST")]),t._v(" "),s("p",[t._v("**回调URL：**该链接是通过基础下单接口中的请求参数“notify_url”来设置的，要求必须为https地址。请确保回调URL是外部可正常访问的，且不能携带后缀参数，否则可能导致商户无法接收到微信的回调通知信息。回调URL示例： “https://pay.weixin.qq.com/wxpay/pay.action”")]),t._v(" "),s("p",[s("strong",[t._v("通知规则")])]),t._v(" "),s("p",[t._v("用户支付完成后，微信会把相关支付结果和用户信息发送给商户，商户需要接收处理该消息，并返回应答。")]),t._v(" "),s("p",[t._v("对后台通知交互时，如果微信收到商户的应答不符合规范或超时，微信认为通知失败，微信会通过一定的策略定期重新发起通知，尽可能提高通知的成功率，但微信不保证通知最终能成功。（通知频率为15s/15s/30s/3m/10m/20m/30m/30m/30m/60m/3h/3h/3h/6h/6h - 总计 24h4m）")]),t._v(" "),s("p",[s("strong",[t._v("通知报文")])]),t._v(" "),s("p",[t._v("支付结果通知是以POST 方法访问商户设置的通知url，通知的数据以JSON 格式通过请求主体（BODY）传输。通知的数据包括了加密的支付结果详情。")]),t._v(" "),s("p",[t._v("下面详细描述对通知数据进行解密的流程：")]),t._v(" "),s("ol",[s("li",[t._v("用商户平台上设置的APIv3密钥【"),s("a",{attrs:{href:"https://pay.weixin.qq.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信商户平台"),s("OutboundLink")],1),t._v("—>账户设置—>API安全—>设置APIv3密钥】，记为key；")]),t._v(" "),s("li",[t._v("针对resource.algorithm中描述的算法（目前为AEAD_AES_256_GCM），取得对应的参数nonce和associated_data；")]),t._v(" "),s("li",[t._v("使用key、nonce和associated_data，对数据密文resource.ciphertext进行解密，得到JSON形式的资源对象；")])]),t._v(" "),s("p",[s("strong",[t._v("注：")]),t._v(" AEAD_AES_256_GCM算法的接口细节，请参考"),s("a",{attrs:{href:"https://tools.ietf.org/html/rfc5116",target:"_blank",rel:"noopener noreferrer"}},[t._v("rfc5116"),s("OutboundLink")],1),t._v("。微信支付使用的密钥key长度为32个字节，随机串nonce长度12个字节，associated_data长度小于16个字节并可能为空。")]),t._v(" "),s("h3",{attrs:{id:"主动通知后端接口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#主动通知后端接口"}},[t._v("#")]),t._v(" 主动通知后端接口")]),t._v(" "),s("p",[t._v("解密方法：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" decryptByApiV3 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  associate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 加密参数 - 类型")]),t._v("\n  nonce"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 加密参数 - 随机数")]),t._v("\n  ciphertext "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 加密密文")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  ciphertext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("decodeURIComponent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ciphertext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  ciphertext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Buffer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("from")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ciphertext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'base64'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" authTag "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ciphertext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ciphertext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" data "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ciphertext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ciphertext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" decipher "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" crypto"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createDecipheriv")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'aes-256-gcm'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("apiV3Key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    nonce\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  decipher"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setAuthTag")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("authTag"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  decipher"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setAAD")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Buffer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("from")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("associate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" decryptedText "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" decipher"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("update")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'utf8'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  decryptedText "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" decipher"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("final")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" decryptedText\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("创建接口：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("// 获取支付通知\nrouter.post('/notify', adminController.wxNotify)\n")])])]),s("p",[t._v("接口详情"),s("code",[t._v("wxNotify")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 微信支付回调通知")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wxNotify")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" body "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("resource_type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" resource "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" body\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'encrypt-resource'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" ciphertext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("associated_data")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" associate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nonce "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" resource\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" str "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("decryptByApiV3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      associate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      nonce"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      ciphertext\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'🚀 ~ file: AdminController.js ~ line 326 ~ AdminController ~ wxNotify ~ str'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" str"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// todo 入库，并修改订单的支付成功的状态")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'🚀 ~ file: AdminController.js ~ line 294 ~ AdminController ~ wxNotify ~ body'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    body\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  ctx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("code")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("收到订单通知后，需要保存通知中的状态与数据（微信订单号）。")])]),t._v(" "),s("h3",{attrs:{id:"订单查询接口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#订单查询接口"}},[t._v("#")]),t._v(" 订单查询接口")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_2.shtml",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方文档"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("有两种方案：")]),t._v(" "),s("ul",[s("li",[t._v("微信支付订单号查询")]),t._v(" "),s("li",[t._v("商户订单号查询（一般采用这种）")])]),t._v(" "),s("p",[s("strong",[t._v("请求URL：")]),t._v(" "),s("code",[t._v("https://api.mch.weixin.qq.com/v3/pay/transactions/out-trade-no/{out_trade_no}")])]),t._v(" "),s("p",[t._v("**请求方式：**GET")]),t._v(" "),s("p",[s("strong",[t._v("请求参数")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"left"}},[t._v("参数名")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("变量")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("类型[长度限制]")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("必填")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("直连商户号")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("mchid")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("string[1,32]")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("是")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("query 直连商户的商户号，由微信支付生成并下发。 示例值：1230000109")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("商户订单号")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("out_trade_no")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("string[6,32]")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("是")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("path 商户系统内部订单号，只能是数字、大小写字母_-*且在同一个商户号下唯一。 特殊规则：最小字符长度为6 示例值：1217752501201407033233368018")])])])]),t._v(" "),s("p",[t._v("示例：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("https://api.mch.weixin.qq.com/v3/pay/transactions/out-trade-no/1217752501201407033233368018?mchid=1230000109\n")])])]),s("blockquote",[s("p",[t._v("这里要特别注意，url中有路径参数与query参数")])]),t._v(" "),s("p",[t._v("后端代码：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" qs "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'qs'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 微信支付订单查询 out_trade_no")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//  https://api.mch.weixin.qq.com/v3/pay/transactions/out-trade-no/{out_trade_no}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("getNofityByTradeNo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("id")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" url "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("https://api.mch.weixin.qq.com/v3/pay/transactions/out-trade-no/")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" params "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("mchid")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mchid\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    url "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" qs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("stringify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("params"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" headers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nonceStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" timestamp "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getSignHeaders")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'get'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" result "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("headers")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("Authorization")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" headers\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'🚀 ~ file: WxPay.js ~ line 147 ~ getNofityByTradeNo ~ timestamp'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      timestamp\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'🚀 ~ file: WxPay.js ~ line 147 ~ getNofityByTradeNo ~ nonceStr'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      nonceStr\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'🚀 ~ file: WxPay.js ~ line 53 ~ wxJSPAY ~ result'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// todo result.data -> trade_state trade_type -> 存储订单的其他信息")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("getNofityByTradeNo error: ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("至此，完成的小程序支付的一个完整的闭环。")]),t._v(" "),s("blockquote",[s("p",[t._v("关于退款与退款通知与下单&订单通知是类似，不再提供示例。")])])]},proxy:!0}])},[s("h1",{attrs:{id:"支付专题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#支付专题"}},[t._v("#")]),t._v(" 支付专题")]),t._v(" "),s("p",[t._v("支付作为工作中最常见的一个核心业务场景，前端同学其实需要做的东西有限，基本的流程、逻辑与难点都是在服务端。为了让前端同学，也能自己后续开发支付功能（Node.js），在本篇介绍了详细的从企业主体 -> 支付必要条件 ->微信小程序支付完整的闭环。")]),t._v(" "),s("p",[t._v("支付业务支撑：")]),t._v(" "),s("ul",[s("li",[t._v("商城应用")]),t._v(" "),s("li",[t._v("金融产品")]),t._v(" "),s("li",[t._v("充值应用（会员、点券）")]),t._v(" "),s("li",[t._v("...")])]),t._v(" "),s("p",[t._v("支付应用场景：")]),t._v(" "),s("ul",[s("li",[t._v("H5支付 -> 扫码、跳转App")]),t._v(" "),s("li",[t._v("小程序")]),t._v(" "),s("li",[t._v("移动App")])]),t._v(" "),s("p",[t._v("支付的技术难点：")]),t._v(" "),s("ul",[s("li",[t._v("多平台（微信、支付宝、银联）")]),t._v(" "),s("li",[t._v("安全性（HTTPS、全流程日志、交易备案、数据安全性如灾备...）")])]),t._v(" "),s("p",[t._v("常见的问题：")]),t._v(" "),s("ul",[s("li",[t._v("支付的开发流程，是不是前端不用管？只用调接口——是的，举例：小程序前端，其实上只是wx.requestPayment调起支付即可；")]),t._v(" "),s("li",[t._v("支付功能的开通容易吗？——容易，但是针对于个人，无法开通微信支付；个人能开通吗？——不行，但是可以使用第三方服务，比如JSAPI；")]),t._v(" "),s("li",[t._v("服务端对接常见的支付功能的流程是怎样的？——基本步骤如下：\n"),s("ol",[s("li",[t._v("申请微信小程序账号")]),t._v(" "),s("li",[t._v("微信小程序认证")]),t._v(" "),s("li",[t._v("申请商户平台账号")]),t._v(" "),s("li",[t._v("信小程序关联商户号")]),t._v(" "),s("li",[t._v("接入微信支付")])])])]),t._v(" "),s("h2",{attrs:{id:"企业注册与税务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#企业注册与税务"}},[t._v("#")]),t._v(" 企业注册与税务")]),t._v(" "),s("p",[t._v("开办企业需要注意：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("财税问题，如果零报税，则需要企业年报每年需要申报。")]),t._v(" "),s("p",[t._v("开办企业不是玩，一定要负责任。而且，不良的企业负债，可能会影响到个人的征信，最终无法贷款、乘车等。")])]),t._v(" "),s("li",[s("p",[t._v("股份问题：如果多人开办，千万不要对半")]),t._v(" "),s("p",[t._v("多人入股不能均分，不能0资金入股，分股用期权；")]),t._v(" "),s("p",[t._v("设计退股机制，分红机制，以及债务问题解决办法；")]),t._v(" "),s("p",[t._v("股权主要的目的是激励；")])]),t._v(" "),s("li",[s("p",[t._v("利益分配问题：天下熙熙皆为利来，天下攘攘皆为利往；")])])]),t._v(" "),s("p",[t._v("无论是支付宝还是微信，能够支持的支付主体只有企业、个体工商户和政府及事业单位等，共同点是"),s("strong",[t._v("非个人")]),t._v("。")]),t._v(" "),s("blockquote",[s("p",[t._v("个人开发者，如果需要接入支付功能，也可以选择第三方服务商：")]),t._v(" "),s("ul",[s("li",[t._v("PayJS：开通费用300+手续费0.38%+服务费2%")]),t._v(" "),s("li",[t._v("PaysApi：月付手续费30-199+单笔费率从0.3~0.1%不等")]),t._v(" "),s("li",[t._v("PayBob：开通费用300+手续费0.38%+服务费1-2%")]),t._v(" "),s("li",[t._v("xorpay：月付手续费0-60+手续费0.38%+单笔手续费1.2%~0.5%不等")])])]),t._v(" "),s("p",[t._v("了解企业的注册流程及税务相关的知识，有助于学习支付相关的内容，扩展知识面。")]),t._v(" "),s("p",[t._v("企业注册比较麻烦的地方：")]),t._v(" "),s("ul",[s("li",[t._v("设立登记可能要跑几躺")]),t._v(" "),s("li",[t._v("税务登记 + 银行开户 折腾个10几天")]),t._v(" "),s("li",[t._v("报税：有季报+年报（工商年报次年6月前、汇缴清算不定）")])]),t._v(" "),s("p",[t._v("但是，开办企业也是有好处的，举例：")]),t._v(" "),s("ul",[s("li",[t._v("作为团队出去接项目")]),t._v(" "),s("li",[t._v("大多数网上的服务针对的是企业")]),t._v(" "),s("li",[t._v("国家政府对于小微企业现在有大力的扶持")])])])}),[],!1,null,null,null);s.default=e.exports},976:function(t,s,a){t.exports=a.p+"assets/img/image-20210830134004706.f4a99b49.png"},977:function(t,s,a){t.exports=a.p+"assets/img/6_2.39c8c442.png"},978:function(t,s,a){t.exports=a.p+"assets/img/image-20210830135731466.7d34db68.png"},979:function(t,s,a){t.exports=a.p+"assets/img/image-20210830140428900.83fd5ad0.png"},980:function(t,s,a){t.exports=a.p+"assets/img/image-20210830140522534.b857eaea.png"},981:function(t,s,a){t.exports=a.p+"assets/img/image-20210830140648414.f3ff8b55.png"},982:function(t,s,a){t.exports=a.p+"assets/img/image-20210830140722039.310b80f5.png"},983:function(t,s,a){t.exports=a.p+"assets/img/image-20210830141415349.46683708.png"},984:function(t,s,a){t.exports=a.p+"assets/img/image-20210830141622200.32b8bdce.png"},985:function(t,s,a){t.exports=a.p+"assets/img/image-20210830173043224.358bbadb.png"}}]);