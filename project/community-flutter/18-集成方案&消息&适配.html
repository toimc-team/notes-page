<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>集成方案&amp;消息&amp;适配 | 大前端 - 前端高级进阶</title>
    <meta name="generator" content="VuePress 1.9.9">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?8b87000f915d1fe37e079a25c2e12d6b";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
      </script>
    <meta name="description" content="大前端课程电子书">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/notes-page/assets/css/0.styles.0140c62c.css" as="style"><link rel="preload" href="/notes-page/assets/js/app.8b6f2d66.js" as="script"><link rel="preload" href="/notes-page/assets/js/5.5563c583.js" as="script"><link rel="preload" href="/notes-page/assets/js/49.67abcb40.js" as="script"><link rel="prefetch" href="/notes-page/assets/js/10.3114a48a.js"><link rel="prefetch" href="/notes-page/assets/js/100.30ae7d42.js"><link rel="prefetch" href="/notes-page/assets/js/101.aac1ff40.js"><link rel="prefetch" href="/notes-page/assets/js/102.c7ac2257.js"><link rel="prefetch" href="/notes-page/assets/js/103.4d335ee1.js"><link rel="prefetch" href="/notes-page/assets/js/104.b5643210.js"><link rel="prefetch" href="/notes-page/assets/js/105.7cab410a.js"><link rel="prefetch" href="/notes-page/assets/js/106.49788ebe.js"><link rel="prefetch" href="/notes-page/assets/js/107.1318179c.js"><link rel="prefetch" href="/notes-page/assets/js/108.813f466b.js"><link rel="prefetch" href="/notes-page/assets/js/109.840ef33e.js"><link rel="prefetch" href="/notes-page/assets/js/11.e6c83102.js"><link rel="prefetch" href="/notes-page/assets/js/110.9defd4bf.js"><link rel="prefetch" href="/notes-page/assets/js/111.4ae86c84.js"><link rel="prefetch" href="/notes-page/assets/js/112.72ce7a2c.js"><link rel="prefetch" href="/notes-page/assets/js/113.de558ba6.js"><link rel="prefetch" href="/notes-page/assets/js/114.2917302e.js"><link rel="prefetch" href="/notes-page/assets/js/115.372aaa2f.js"><link rel="prefetch" href="/notes-page/assets/js/116.57b10ba3.js"><link rel="prefetch" href="/notes-page/assets/js/117.933fc530.js"><link rel="prefetch" href="/notes-page/assets/js/118.24cadc7c.js"><link rel="prefetch" href="/notes-page/assets/js/119.96308b65.js"><link rel="prefetch" href="/notes-page/assets/js/12.80933a49.js"><link rel="prefetch" href="/notes-page/assets/js/120.9445de44.js"><link rel="prefetch" href="/notes-page/assets/js/121.34a50bd9.js"><link rel="prefetch" href="/notes-page/assets/js/122.6e827084.js"><link rel="prefetch" href="/notes-page/assets/js/123.0c6ec600.js"><link rel="prefetch" href="/notes-page/assets/js/124.2174e02d.js"><link rel="prefetch" href="/notes-page/assets/js/125.92b84c5f.js"><link rel="prefetch" href="/notes-page/assets/js/126.149aa66f.js"><link rel="prefetch" href="/notes-page/assets/js/127.028c24ab.js"><link rel="prefetch" href="/notes-page/assets/js/128.3db2611c.js"><link rel="prefetch" href="/notes-page/assets/js/129.886dc7a8.js"><link rel="prefetch" href="/notes-page/assets/js/13.09758003.js"><link rel="prefetch" href="/notes-page/assets/js/130.d8021a7c.js"><link rel="prefetch" href="/notes-page/assets/js/131.23d85a06.js"><link rel="prefetch" href="/notes-page/assets/js/132.220ff1e0.js"><link rel="prefetch" href="/notes-page/assets/js/133.311d1fb4.js"><link rel="prefetch" href="/notes-page/assets/js/134.189010ed.js"><link rel="prefetch" href="/notes-page/assets/js/135.52debd56.js"><link rel="prefetch" href="/notes-page/assets/js/136.3fb09bec.js"><link rel="prefetch" href="/notes-page/assets/js/137.c0bcf760.js"><link rel="prefetch" href="/notes-page/assets/js/138.60d6d844.js"><link rel="prefetch" href="/notes-page/assets/js/139.81b25606.js"><link rel="prefetch" href="/notes-page/assets/js/14.5d4695bb.js"><link rel="prefetch" href="/notes-page/assets/js/140.a26ddc25.js"><link rel="prefetch" href="/notes-page/assets/js/141.0858da14.js"><link rel="prefetch" href="/notes-page/assets/js/142.1a694307.js"><link rel="prefetch" href="/notes-page/assets/js/143.a4777b71.js"><link rel="prefetch" href="/notes-page/assets/js/144.0da9c166.js"><link rel="prefetch" href="/notes-page/assets/js/145.11f5e01a.js"><link rel="prefetch" href="/notes-page/assets/js/146.da4a2083.js"><link rel="prefetch" href="/notes-page/assets/js/147.b475ac60.js"><link rel="prefetch" href="/notes-page/assets/js/148.14067a7e.js"><link rel="prefetch" href="/notes-page/assets/js/149.47f060ac.js"><link rel="prefetch" href="/notes-page/assets/js/15.0d89d6df.js"><link rel="prefetch" href="/notes-page/assets/js/150.80b76511.js"><link rel="prefetch" href="/notes-page/assets/js/151.de11891f.js"><link rel="prefetch" href="/notes-page/assets/js/152.15aafea2.js"><link rel="prefetch" href="/notes-page/assets/js/153.61a62da1.js"><link rel="prefetch" href="/notes-page/assets/js/154.db1dc446.js"><link rel="prefetch" href="/notes-page/assets/js/155.1dcdd44f.js"><link rel="prefetch" href="/notes-page/assets/js/156.114c73e2.js"><link rel="prefetch" href="/notes-page/assets/js/157.66f91df7.js"><link rel="prefetch" href="/notes-page/assets/js/158.b754b6dd.js"><link rel="prefetch" href="/notes-page/assets/js/159.560738d7.js"><link rel="prefetch" href="/notes-page/assets/js/16.2d3a744c.js"><link rel="prefetch" href="/notes-page/assets/js/160.b65303dd.js"><link rel="prefetch" href="/notes-page/assets/js/161.009e3af3.js"><link rel="prefetch" href="/notes-page/assets/js/162.7abfbf0f.js"><link rel="prefetch" href="/notes-page/assets/js/163.9d00eb47.js"><link rel="prefetch" href="/notes-page/assets/js/164.20f22c0c.js"><link rel="prefetch" href="/notes-page/assets/js/165.2333ecf3.js"><link rel="prefetch" href="/notes-page/assets/js/166.fa3f7a92.js"><link rel="prefetch" href="/notes-page/assets/js/167.00cb1638.js"><link rel="prefetch" href="/notes-page/assets/js/168.939efccb.js"><link rel="prefetch" href="/notes-page/assets/js/169.8e5228e7.js"><link rel="prefetch" href="/notes-page/assets/js/17.09dcedf8.js"><link rel="prefetch" href="/notes-page/assets/js/170.67dfc6cf.js"><link rel="prefetch" href="/notes-page/assets/js/171.2fe1a667.js"><link rel="prefetch" href="/notes-page/assets/js/172.3cf153f4.js"><link rel="prefetch" href="/notes-page/assets/js/173.942612a3.js"><link rel="prefetch" href="/notes-page/assets/js/174.a0296e80.js"><link rel="prefetch" href="/notes-page/assets/js/175.2a2ec4c6.js"><link rel="prefetch" href="/notes-page/assets/js/176.968ec344.js"><link rel="prefetch" href="/notes-page/assets/js/177.4a9dcf4e.js"><link rel="prefetch" href="/notes-page/assets/js/178.3c658f8e.js"><link rel="prefetch" href="/notes-page/assets/js/179.954a0cf8.js"><link rel="prefetch" href="/notes-page/assets/js/18.d2e19b61.js"><link rel="prefetch" href="/notes-page/assets/js/180.6844653c.js"><link rel="prefetch" href="/notes-page/assets/js/181.e0bcb73d.js"><link rel="prefetch" href="/notes-page/assets/js/182.3556ca67.js"><link rel="prefetch" href="/notes-page/assets/js/183.c997f1f4.js"><link rel="prefetch" href="/notes-page/assets/js/184.e7d25cac.js"><link rel="prefetch" href="/notes-page/assets/js/185.52138c81.js"><link rel="prefetch" href="/notes-page/assets/js/186.8d0b07d1.js"><link rel="prefetch" href="/notes-page/assets/js/187.1287296d.js"><link rel="prefetch" href="/notes-page/assets/js/188.f56772c9.js"><link rel="prefetch" href="/notes-page/assets/js/189.38838eda.js"><link rel="prefetch" href="/notes-page/assets/js/19.7994f49d.js"><link rel="prefetch" href="/notes-page/assets/js/190.3ec4e8fe.js"><link rel="prefetch" href="/notes-page/assets/js/191.b5aa3a1a.js"><link rel="prefetch" href="/notes-page/assets/js/192.a74d04af.js"><link rel="prefetch" href="/notes-page/assets/js/193.a24172b6.js"><link rel="prefetch" href="/notes-page/assets/js/194.07e63db6.js"><link rel="prefetch" href="/notes-page/assets/js/195.e125a51c.js"><link rel="prefetch" href="/notes-page/assets/js/196.efbf8c5c.js"><link rel="prefetch" href="/notes-page/assets/js/197.89fbbb4d.js"><link rel="prefetch" href="/notes-page/assets/js/198.b70bca6a.js"><link rel="prefetch" href="/notes-page/assets/js/199.9fa281fc.js"><link rel="prefetch" href="/notes-page/assets/js/20.69ffe5b9.js"><link rel="prefetch" href="/notes-page/assets/js/200.ea582b0e.js"><link rel="prefetch" href="/notes-page/assets/js/21.63bef63d.js"><link rel="prefetch" href="/notes-page/assets/js/22.08119739.js"><link rel="prefetch" href="/notes-page/assets/js/23.f1795ccf.js"><link rel="prefetch" href="/notes-page/assets/js/24.38905c12.js"><link rel="prefetch" href="/notes-page/assets/js/25.98a5d954.js"><link rel="prefetch" href="/notes-page/assets/js/26.23adfebb.js"><link rel="prefetch" href="/notes-page/assets/js/27.cd86a4e5.js"><link rel="prefetch" href="/notes-page/assets/js/28.8ccefd73.js"><link rel="prefetch" href="/notes-page/assets/js/29.3cc9ddea.js"><link rel="prefetch" href="/notes-page/assets/js/30.b7196772.js"><link rel="prefetch" href="/notes-page/assets/js/31.de118eb6.js"><link rel="prefetch" href="/notes-page/assets/js/32.30c6d435.js"><link rel="prefetch" href="/notes-page/assets/js/33.d304c699.js"><link rel="prefetch" href="/notes-page/assets/js/34.15ea351f.js"><link rel="prefetch" href="/notes-page/assets/js/35.9eaa3ce6.js"><link rel="prefetch" href="/notes-page/assets/js/36.3a02b474.js"><link rel="prefetch" href="/notes-page/assets/js/37.db12a2e5.js"><link rel="prefetch" href="/notes-page/assets/js/38.29f156bf.js"><link rel="prefetch" href="/notes-page/assets/js/39.bdda09e5.js"><link rel="prefetch" href="/notes-page/assets/js/40.2cb58e9c.js"><link rel="prefetch" href="/notes-page/assets/js/41.13cf9f35.js"><link rel="prefetch" href="/notes-page/assets/js/42.a57b7fbb.js"><link rel="prefetch" href="/notes-page/assets/js/43.5fde049d.js"><link rel="prefetch" href="/notes-page/assets/js/44.236b3e38.js"><link rel="prefetch" href="/notes-page/assets/js/45.265dbe21.js"><link rel="prefetch" href="/notes-page/assets/js/46.ca20b69c.js"><link rel="prefetch" href="/notes-page/assets/js/47.610eaa2d.js"><link rel="prefetch" href="/notes-page/assets/js/48.53e9fce1.js"><link rel="prefetch" href="/notes-page/assets/js/50.20cf3a2a.js"><link rel="prefetch" href="/notes-page/assets/js/51.0030bad4.js"><link rel="prefetch" href="/notes-page/assets/js/52.41e45f5d.js"><link rel="prefetch" href="/notes-page/assets/js/53.983c2dad.js"><link rel="prefetch" href="/notes-page/assets/js/54.f087409a.js"><link rel="prefetch" href="/notes-page/assets/js/55.dc5be72f.js"><link rel="prefetch" href="/notes-page/assets/js/56.7fe55c6b.js"><link rel="prefetch" href="/notes-page/assets/js/57.4ca8e9dc.js"><link rel="prefetch" href="/notes-page/assets/js/58.831cb39c.js"><link rel="prefetch" href="/notes-page/assets/js/59.99eb9742.js"><link rel="prefetch" href="/notes-page/assets/js/6.dae57aa2.js"><link rel="prefetch" href="/notes-page/assets/js/60.e1047911.js"><link rel="prefetch" href="/notes-page/assets/js/61.628200ff.js"><link rel="prefetch" href="/notes-page/assets/js/62.7e5f6ad6.js"><link rel="prefetch" href="/notes-page/assets/js/63.16d7bc64.js"><link rel="prefetch" href="/notes-page/assets/js/64.6865f630.js"><link rel="prefetch" href="/notes-page/assets/js/65.13f18d1b.js"><link rel="prefetch" href="/notes-page/assets/js/66.24727f85.js"><link rel="prefetch" href="/notes-page/assets/js/67.22e61255.js"><link rel="prefetch" href="/notes-page/assets/js/68.e848cca2.js"><link rel="prefetch" href="/notes-page/assets/js/69.c1c29054.js"><link rel="prefetch" href="/notes-page/assets/js/7.25ea714c.js"><link rel="prefetch" href="/notes-page/assets/js/70.6af4b8ae.js"><link rel="prefetch" href="/notes-page/assets/js/71.23799cf2.js"><link rel="prefetch" href="/notes-page/assets/js/72.6e95ccc4.js"><link rel="prefetch" href="/notes-page/assets/js/73.ff268e7b.js"><link rel="prefetch" href="/notes-page/assets/js/74.007c9819.js"><link rel="prefetch" href="/notes-page/assets/js/75.2e87e202.js"><link rel="prefetch" href="/notes-page/assets/js/76.63748281.js"><link rel="prefetch" href="/notes-page/assets/js/77.85208a09.js"><link rel="prefetch" href="/notes-page/assets/js/78.3c209dc6.js"><link rel="prefetch" href="/notes-page/assets/js/79.e610c1ea.js"><link rel="prefetch" href="/notes-page/assets/js/8.4a954a7c.js"><link rel="prefetch" href="/notes-page/assets/js/80.e745da7f.js"><link rel="prefetch" href="/notes-page/assets/js/81.ae2faeff.js"><link rel="prefetch" href="/notes-page/assets/js/82.4cea293f.js"><link rel="prefetch" href="/notes-page/assets/js/83.6fc09cd4.js"><link rel="prefetch" href="/notes-page/assets/js/84.0e0e8b15.js"><link rel="prefetch" href="/notes-page/assets/js/85.a06e8318.js"><link rel="prefetch" href="/notes-page/assets/js/86.7180824e.js"><link rel="prefetch" href="/notes-page/assets/js/87.896917ff.js"><link rel="prefetch" href="/notes-page/assets/js/88.91fb03ea.js"><link rel="prefetch" href="/notes-page/assets/js/89.6b68d910.js"><link rel="prefetch" href="/notes-page/assets/js/9.1d85530b.js"><link rel="prefetch" href="/notes-page/assets/js/90.0fac492b.js"><link rel="prefetch" href="/notes-page/assets/js/91.34e30cd9.js"><link rel="prefetch" href="/notes-page/assets/js/92.2b4e3271.js"><link rel="prefetch" href="/notes-page/assets/js/93.df708ff0.js"><link rel="prefetch" href="/notes-page/assets/js/94.6f941f36.js"><link rel="prefetch" href="/notes-page/assets/js/95.c41dbfd9.js"><link rel="prefetch" href="/notes-page/assets/js/96.3b364f42.js"><link rel="prefetch" href="/notes-page/assets/js/97.8d5a57a7.js"><link rel="prefetch" href="/notes-page/assets/js/98.6b28571a.js"><link rel="prefetch" href="/notes-page/assets/js/99.4bcc00e4.js"><link rel="prefetch" href="/notes-page/assets/js/vendors~docsearch.e4a575f9.js"><link rel="prefetch" href="/notes-page/assets/js/vendors~photo-swipe.e76bdbac.js"><link rel="prefetch" href="/notes-page/assets/js/vendors~search-page.c8f33af6.js">
    <link rel="stylesheet" href="/notes-page/assets/css/0.styles.0140c62c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes-page/" class="home-link router-link-active"><!----> <span class="site-name">大前端 - 前端高级进阶</span></a> <div class="links"><div id="docsearch"></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>小程序</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-miniapp/" class="sidebar-link">uniapp介绍</a></li><li><a href="/notes-page/project/community-miniapp/01-搭建开发环境.html" class="sidebar-link">搭建开发环境</a></li><li><a href="/notes-page/project/community-miniapp/02-首页模块.html" class="sidebar-link">首页模块</a></li><li><a href="/notes-page/project/community-miniapp/03-登录鉴权.html" class="sidebar-link">小程序鉴权登录</a></li><li><a href="/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html" class="sidebar-link">消息&amp;热门&amp;个人中心</a></li><li><a href="/notes-page/project/community-miniapp/05-RefreshToken机制.html" class="sidebar-link">RefreshToken机制</a></li><li><a href="/notes-page/project/community-miniapp/06-文章详情.html" class="sidebar-link">文章详情</a></li><li><a href="/notes-page/project/community-miniapp/07-安全域名相关.html" class="sidebar-link">安全域名相关</a></li><li><a href="/notes-page/project/community-miniapp/08-订阅消息.html" class="sidebar-link">订阅消息</a></li><li><a href="/notes-page/project/community-miniapp/09-内容安全.html" class="sidebar-link">内容安全</a></li><li><a href="/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html" class="sidebar-link">发贴评论功能</a></li><li><a href="/notes-page/project/community-miniapp/11-发布上线.html" class="sidebar-link">发布上线</a></li><li><a href="/notes-page/project/community-miniapp/12-支付专题.html" class="sidebar-link">支付专题</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Flutter 2.0</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-flutter/" aria-current="page" class="sidebar-link">Flutter</a></li><li><a href="/notes-page/project/community-flutter/01-风格指南.html" class="sidebar-link">风格指南</a></li><li><a href="/notes-page/project/community-flutter/02-Flutter入门.html" class="sidebar-link">Flutter入门案例</a></li><li><a href="/notes-page/project/community-flutter/03-异步编程思想.html" class="sidebar-link">异步编程思想</a></li><li><a href="/notes-page/project/community-flutter/04-状态管理.html" class="sidebar-link">状态管理概览</a></li><li><a href="/notes-page/project/community-flutter/05-状态管理-redux.html" class="sidebar-link">状态管理方案-Redux</a></li><li><a href="/notes-page/project/community-flutter/06-状态管理-scoped_model.html" class="sidebar-link">状态管理方案-ScopedModel</a></li><li><a href="/notes-page/project/community-flutter/07-状态管理-bloc.html" class="sidebar-link">状态管理方案-Bloc</a></li><li><a href="/notes-page/project/community-flutter/08-获取验证码.html" class="sidebar-link">获取验证码</a></li><li><a href="/notes-page/project/community-flutter/09-封装请求.html" class="sidebar-link">封装请求</a></li><li><a href="/notes-page/project/community-flutter/10-网络测试.html" class="sidebar-link">网络调试</a></li><li><a href="/notes-page/project/community-flutter/11-创建短信接口服务.html" class="sidebar-link">创建发送短信验证码服务</a></li><li><a href="/notes-page/project/community-flutter/12-序列化.html" class="sidebar-link">序列化</a></li><li><a href="/notes-page/project/community-flutter/13-自定义toast组件.html" class="sidebar-link">自定义toast组件</a></li><li><a href="/notes-page/project/community-flutter/14-优化短信验证码逻辑.html" class="sidebar-link">优化短信验证码逻辑</a></li><li><a href="/notes-page/project/community-flutter/15-数据持久化-getstorage.html" class="sidebar-link">数据持久化-GetStorage</a></li><li><a href="/notes-page/project/community-flutter/16-数据持久化-sqflite.html" class="sidebar-link">数据持久化-Sqflite</a></li><li><a href="/notes-page/project/community-flutter/17-路由.html" class="sidebar-link">路由</a></li><li><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html" class="active sidebar-link">集成方案&amp;消息&amp;适配</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#集成方案" class="sidebar-link">集成方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#getx" class="sidebar-link">GetX</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#velocity-x" class="sidebar-link">velocity_x</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#websocket消息" class="sidebar-link">WebSocket消息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#安装依赖" class="sidebar-link">安装依赖</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#websocket初始化" class="sidebar-link">websocket初始化</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#发送消息" class="sidebar-link">发送消息</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#心跳检测" class="sidebar-link">心跳检测</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#断线重连" class="sidebar-link">断线重连</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#关闭连接" class="sidebar-link">关闭连接</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#完整代码" class="sidebar-link">完整代码</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#本地消息推送" class="sidebar-link">本地消息推送</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#安装依赖-2" class="sidebar-link">安装依赖</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#基础示例" class="sidebar-link">基础示例</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#如何测试呢" class="sidebar-link">如何测试呢？</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#声音与震动" class="sidebar-link">声音与震动</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#首页导航" class="sidebar-link">首页导航</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#屏幕适配" class="sidebar-link">屏幕适配</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#底部导航" class="sidebar-link">底部导航</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#下拉刷新-上拉加载" class="sidebar-link">下拉刷新（上拉加载）</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html#长列表异步数据方案" class="sidebar-link">长列表异步数据方案</a></li></ul></li></ul></li><li><a href="/notes-page/project/community-flutter/19-苹果开发者.html" class="sidebar-link">苹果开发者</a></li><li><a href="/notes-page/project/community-flutter/20-启动图标与启动图.html" class="sidebar-link">配置应用图标与启动图</a></li><li><a href="/notes-page/project/community-flutter/21-日志收集.html" class="sidebar-link">错误日志收集</a></li><li><a href="/notes-page/project/community-flutter/22-打包.html" class="sidebar-link">移动端打包</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Electron桌面端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-electron/" class="sidebar-link">整体介绍</a></li><li><a href="/notes-page/project/community-electron/01-核心概念.html" class="sidebar-link">核心概念</a></li><li><a href="/notes-page/project/community-electron/02-与主流框架集成.html" class="sidebar-link">与主流的框架集成</a></li><li><a href="/notes-page/project/community-electron/03-社区项目整合.html" class="sidebar-link">业务项目整合</a></li><li><a href="/notes-page/project/community-electron/04-第三方登录扫码登录.html" class="sidebar-link">第三方登录（扫码登录）</a></li><li><a href="/notes-page/project/community-electron/05-原生应用通知.html" class="sidebar-link">原生应用通知</a></li><li><a href="/notes-page/project/community-electron/06-打包与更新.html" class="sidebar-link">Electron打包</a></li><li><a href="/notes-page/project/community-electron/07-多平台打包.html" class="sidebar-link">多平台打包</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React世界</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/react/" class="sidebar-link">React项目</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="集成方案-消息-适配"><a href="#集成方案-消息-适配" class="header-anchor">#</a> 集成方案&amp;消息&amp;适配</h1> <h2 id="集成方案"><a href="#集成方案" class="header-anchor">#</a> 集成方案</h2> <p>Flutter中有一些比较成熟的集成方案，即包含：</p> <ul><li>状态管理</li> <li>依赖管理</li> <li>存储</li> <li>路由</li> <li>国际化</li> <li>过渡效果</li> <li>....</li></ul> <h3 id="getx"><a href="#getx" class="header-anchor">#</a> GetX</h3> <p><img src="/notes-page/assets/img/get.bedebe85.png" alt="img"></p> <p>官方地址：<a href="https://pub.dev/packages/get" target="_blank" rel="noopener noreferrer">https://pub.dev/packages/get<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>特点：</p> <ul><li>状态管理、路由、依赖管理</li> <li>过渡动画、国际化</li> <li>HTTP请求</li> <li>页面导航</li> <li>本地状态、服务、响应、组件管理</li></ul> <h3 id="velocity-x"><a href="#velocity-x" class="header-anchor">#</a> velocity_x</h3> <p><img src="/notes-page/assets/img/GcsbeIW.38ebceb6.png" alt="VelocityX"></p> <p>官方地址：<a href="https://pub.dev/packages/velocity_x" target="_blank" rel="noopener noreferrer">https://pub.dev/packages/velocity_x<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>特点如上图。</p> <h2 id="websocket消息"><a href="#websocket消息" class="header-anchor">#</a> WebSocket消息</h2> <p>Flutter中有两个WS支持的包：</p> <ul><li>web_socket_channel</li> <li>socket_io_client</li></ul> <h3 id="安装依赖"><a href="#安装依赖" class="header-anchor">#</a> 安装依赖</h3> <div class="language-dart extra-class"><pre class="language-dart"><code>dependencies<span class="token punctuation">:</span>
  web_socket_channel<span class="token punctuation">:</span> <span class="token operator">^</span><span class="token number">2.1</span><span class="token number">.0</span>
</code></pre></div><h3 id="websocket初始化"><a href="#websocket初始化" class="header-anchor">#</a> websocket初始化</h3> <p>添加ws连接的配置信息到<code>config.dart</code>：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">enum</span> <span class="token class-name">Env</span> <span class="token punctuation">{</span> <span class="token class-name">Dev</span><span class="token punctuation">,</span> <span class="token class-name">Prod</span> <span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>
  <span class="token comment">// ..</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">String</span> wsUrl <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'ws://192.168.31.132:3001'</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>使用自己本地的IP，注意协议是<code>ws</code>。</p></blockquote> <p>创建文件<code>utils/websocket_utils.dart</code>：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:web_socket_channel/io.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">WebSocketUtils</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Function</span><span class="token operator">?</span> onOpen<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Function</span><span class="token operator">?</span> onMessage<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Function</span><span class="token operator">?</span> onError<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> protocols<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword">dynamic</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> headers<span class="token punctuation">;</span>

  <span class="token comment">// 初始化</span>
  <span class="token class-name">WebSocketUtils</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onOpen<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onMessage<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onError<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>protocols<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里是构造函数的函数体，可以直接完成初始化</span>
    <span class="token function">openSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">IOWebSocketChannel</span><span class="token operator">?</span> _websocket<span class="token punctuation">;</span>
  <span class="token comment">// Function? onOpen;</span>
  <span class="token comment">// Function? onMessage;</span>
  <span class="token comment">// Function? onError;</span>

  <span class="token comment">// void initWebSocket(</span>
  <span class="token comment">//     {Function? onOpen, Function? onMessage, Function? onError}) {</span>
  <span class="token comment">//   this.onOpen = onOpen;</span>
  <span class="token comment">//   this.onMessage = onMessage;</span>
  <span class="token comment">//   this.onError = onError;</span>
  <span class="token comment">//   // 连接 -&gt; 接收消息</span>
  <span class="token comment">//   openSocket();</span>
  <span class="token comment">// }</span>

  <span class="token keyword">void</span> <span class="token function">openSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _websocket <span class="token operator">=</span> <span class="token class-name">IOWebSocketChannel</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>onOpen <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> onOpen<span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取WebSocket的连接消息</span>
    _websocket<span class="token operator">!</span><span class="token punctuation">.</span>stream<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'event is 👉 </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">event</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onMessage <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> onMessage<span class="token operator">!</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> onError<span class="token punctuation">:</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'err is 👉 </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">err</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'close websocket'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// todo 断线重连</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 发送消息</span>
  <span class="token comment">// 关闭连接</span>
  <span class="token comment">// 断线重连</span>
  <span class="token comment">// 心跳检测</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在<code>main.dart</code>中完成初始化：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
  <span class="token function">setupGetIt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  getIt<span class="token punctuation">.</span>registerSingleton<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebSocketUtils</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">WebSocketUtils</span><span class="token punctuation">(</span><span class="token class-name">Config</span><span class="token punctuation">.</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// WebSocketUtils webSocketUtils = getIt&lt;WebSocketUtils&gt;();</span>
  <span class="token function">runApp</span><span class="token punctuation">(</span><span class="token class-name">MyApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="发送消息"><a href="#发送消息" class="header-anchor">#</a> 发送消息</h3> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token comment">// 发送消息</span>
<span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_websocket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _websocket<span class="token operator">!</span><span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="心跳检测"><a href="#心跳检测" class="header-anchor">#</a> 心跳检测</h3> <p>调整<code>openSocket</code>方法：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">void</span> <span class="token function">openSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  _websocket <span class="token operator">=</span> <span class="token class-name">IOWebSocketChannel</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>onOpen <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> onOpen<span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取WebSocket的连接消息</span>
  _websocket<span class="token operator">!</span><span class="token punctuation">.</span>stream<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'event is 👉 </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">event</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword">dynamic</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">as</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword">dynamic</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'event'</span></span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string-literal"><span class="token string">'heartbeat'</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 心跳检测</span>
        <span class="token function">sendMessage</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-literal"><span class="token string">'event'</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'heartbeat'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'message'</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'pong'</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onMessage <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> onMessage<span class="token operator">!</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'err is 👉 </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">err</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// finally {</span>
    <span class="token comment">//   if (onMessage != null) onMessage!(event);</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> onError<span class="token punctuation">:</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'close websocket'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="断线重连"><a href="#断线重连" class="header-anchor">#</a> 断线重连</h3> <p>断线需要每隔一段时间进行重连，这里就需要有一个计时器</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">class</span> <span class="token class-name">WebSocketUtils</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token class-name">Timer</span><span class="token operator">?</span> _reconnectTimer<span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">openSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _websocket <span class="token operator">=</span> <span class="token class-name">IOWebSocketChannel</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_reconnectTimer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _reconnectTimer<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _reconnectTimer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>onOpen <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> onOpen<span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取WebSocket的连接消息</span>
    _websocket<span class="token operator">!</span><span class="token punctuation">.</span>stream<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ..</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> onError<span class="token punctuation">:</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'err is 👉 </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">err</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onError <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> onError<span class="token operator">!</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// onDone</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'close websocket'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 断线重连</span>
  <span class="token keyword">void</span> <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _reconnectTimer <span class="token operator">=</span> <span class="token class-name">Timer</span><span class="token punctuation">.</span><span class="token function">periodic</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">openSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'重新连接中'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><h3 id="关闭连接"><a href="#关闭连接" class="header-anchor">#</a> 关闭连接</h3> <p>其实代码比较简单：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token comment">// 关闭连接</span>
<span class="token keyword">void</span> <span class="token function">closeSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_websocket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	_websocket<span class="token operator">!</span><span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>主要是控制<code>sink</code>进行<code>close</code>（自带方法）即可。</p> <h3 id="完整代码"><a href="#完整代码" class="header-anchor">#</a> 完整代码</h3> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'dart:async'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'dart:convert'</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:web_socket_channel/io.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">enum</span> <span class="token class-name">SocketStatus</span> <span class="token punctuation">{</span>
  connected<span class="token punctuation">,</span>
  error<span class="token punctuation">,</span>
  closed<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">WebSocketUtils</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Function</span><span class="token operator">?</span> onOpen<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Function</span><span class="token operator">?</span> onMessage<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Function</span><span class="token operator">?</span> onError<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> protocols<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword">dynamic</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> headers<span class="token punctuation">;</span>
  <span class="token class-name">Timer</span><span class="token operator">?</span> _reconnectTimer<span class="token punctuation">;</span>
  <span class="token comment">// ignore: close_sinks</span>
  <span class="token class-name">StreamController</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketStatus</span><span class="token punctuation">&gt;</span></span> _controller <span class="token operator">=</span> <span class="token class-name">StreamController</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketStatus</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">SocketStatus</span> _socketStatus <span class="token operator">=</span> <span class="token class-name">SocketStatus</span><span class="token punctuation">.</span>closed<span class="token punctuation">;</span>

  <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketStatus</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">get</span> statusStream <span class="token operator">=</span><span class="token operator">&gt;</span> _controller<span class="token punctuation">.</span>stream<span class="token punctuation">;</span>
  <span class="token class-name">SocketStatus</span> <span class="token keyword">get</span> socketStatus <span class="token operator">=</span><span class="token operator">&gt;</span> _socketStatus<span class="token punctuation">;</span>

  <span class="token comment">// 初始化</span>
  <span class="token class-name">WebSocketUtils</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onOpen<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onMessage<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onError<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>protocols<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">openSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">IOWebSocketChannel</span><span class="token operator">?</span> _websocket<span class="token punctuation">;</span>
  <span class="token comment">// Function? onOpen;</span>
  <span class="token comment">// Function? onMessage;</span>
  <span class="token comment">// Function? onError;</span>

  <span class="token comment">// void initWebSocket(</span>
  <span class="token comment">//     {Function? onOpen, Function? onMessage, Function? onError}) {</span>
  <span class="token comment">//   this.onOpen = onOpen;</span>
  <span class="token comment">//   this.onMessage = onMessage;</span>
  <span class="token comment">//   this.onError = onError;</span>
  <span class="token comment">//   // 连接 -&gt; 接收消息</span>
  <span class="token comment">//   openSocket();</span>
  <span class="token comment">// }</span>

  <span class="token keyword">void</span> <span class="token function">openSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _websocket <span class="token operator">=</span> <span class="token class-name">IOWebSocketChannel</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _controller<span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SocketStatus</span><span class="token punctuation">.</span>connected<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _socketStatus <span class="token operator">=</span> <span class="token class-name">SocketStatus</span><span class="token punctuation">.</span>connected<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_reconnectTimer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _reconnectTimer<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _reconnectTimer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>onOpen <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> onOpen<span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取WebSocket的连接消息</span>
    _websocket<span class="token operator">!</span><span class="token punctuation">.</span>stream<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'event is 👉 </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">event</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword">dynamic</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">as</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword">dynamic</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'event'</span></span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string-literal"><span class="token string">'heartbeat'</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 心跳检测</span>
          <span class="token function">sendMessage</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-literal"><span class="token string">'event'</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'heartbeat'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'message'</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'pong'</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onMessage <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> onMessage<span class="token operator">!</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'err is 👉 </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">err</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// finally {</span>
      <span class="token comment">//   if (onMessage != null) onMessage!(event);</span>
      <span class="token comment">// }</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> onError<span class="token punctuation">:</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'err is 👉 </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">err</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _controller<span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SocketStatus</span><span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      _socketStatus <span class="token operator">=</span> <span class="token class-name">SocketStatus</span><span class="token punctuation">.</span>error<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onError <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> onError<span class="token operator">!</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _controller<span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SocketStatus</span><span class="token punctuation">.</span>closed<span class="token punctuation">)</span><span class="token punctuation">;</span>
      _socketStatus <span class="token operator">=</span> <span class="token class-name">SocketStatus</span><span class="token punctuation">.</span>closed<span class="token punctuation">;</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'close websocket'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 发送消息</span>
  <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_websocket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _websocket<span class="token operator">!</span><span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 关闭连接</span>
  <span class="token keyword">void</span> <span class="token function">closeSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_websocket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _websocket<span class="token operator">!</span><span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 断线重连</span>
  <span class="token keyword">void</span> <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _reconnectTimer <span class="token operator">=</span> <span class="token class-name">Timer</span><span class="token punctuation">.</span><span class="token function">periodic</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">openSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'重新连接中'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 手动销毁controller与socket，帮助回收内存</span>
  <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _controller<span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">closeSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="本地消息推送"><a href="#本地消息推送" class="header-anchor">#</a> 本地消息推送</h2> <p>本地消息推送第三方方案<code>flutter_local_notifications</code>，它是一个跨平台的本地化消息推送方案，官方网址<a href="https://pub.dev/packages/flutter_local_notifications" target="_blank" rel="noopener noreferrer">https://pub.dev/packages/flutter_local_notifications<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>平台支持：</p> <ul><li>安卓4.1以上。使用NotificationCompat APIs，所以可以运行旧的Android设备。</li> <li>iOS 8.0以上。在超过10的iOS版本上，该插件将使用UILocalNotification APIs。UserNotification APIs（又称用户通知框架）在iOS 10或更新的版本上使用。</li> <li>macOS 10.11以上。在10.14之前的macOS版本上，该插件将使用NSUserNotification APIs。UserNotification APIs（又称用户通知框架）在macOS 10.14或更新版本上使用。</li> <li>Linux。使用桌面通知规范。</li></ul> <h3 id="安装依赖-2"><a href="#安装依赖-2" class="header-anchor">#</a> 安装依赖</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">dependencies</span><span class="token punctuation">:</span>
  <span class="token key atrule">flutter_local_notifications</span><span class="token punctuation">:</span> ^9.2.0
</code></pre></div><p>使用<code>flutter pub get</code>安装依赖。</p> <p>iOS配置，在iOS项目的<code>ios/Runner/AppDelegate.m</code>或者<code>ios/Runner/AppDelegate.swift</code>文件中的<code>didFinishLaunchingWithOptions</code>方法中加入以下几行</p> <p>Objective-C:</p> <div class="language-objc extra-class"><pre class="language-objc"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">@</span><span class="token function">available</span><span class="token punctuation">(</span>iOS <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>UNUserNotificationCenter currentNotificationCenter<span class="token punctuation">]</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token operator">&lt;</span>UNUserNotificationCenterDelegate<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Swift:</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">if</span> <span class="token other-directive property">#available</span><span class="token punctuation">(</span>iOS <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">UNUserNotificationCenter</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">UNUserNotificationCenterDelegate</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>以上的代码一定要加在<code>return</code>语句之前。</p></blockquote> <h3 id="基础示例"><a href="#基础示例" class="header-anchor">#</a> 基础示例</h3> <p>初始化需要完成的工作：</p> <ul><li><p>初始化FlutterLocalNotifications插件；</p></li> <li><p>初始化消息</p> <ul><li><p>设置android图标；</p> <blockquote><p>这里要注意，<code>android</code>目录中有一个目录<code>android/app/src/main/res</code>，在res就有图标了。</p></blockquote></li> <li><p>获取权限</p></li> <li><p>接收消息回调</p></li> <li><p>消息初始化（ios与android平台）</p></li></ul></li> <li><p>回调方法定义：显示消息、点击消息</p></li></ul> <p>配置文件<code>config.dart</code>记录通用信息：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">enum</span> <span class="token class-name">Env</span> <span class="token punctuation">{</span> <span class="token class-name">Dev</span><span class="token punctuation">,</span> <span class="token class-name">Prod</span> <span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">String</span> baseUrl <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'http://192.168.31.132:3000'</span></span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">String</span> wsUrl <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'ws://192.168.31.132:3001'</span></span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">Env</span> env <span class="token operator">=</span> <span class="token class-name">Env.Dev</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">String</span> publicDBName <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'public.db'</span></span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">String</span> privateDBName <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'private.db'</span></span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">String</span> channelId <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'com.toimc.community.im'</span></span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">String</span> channelName <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'toimc技术社区'</span></span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">String</span> channelDesc <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'toimc技术社区消息'</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>新建一个工具类文件<code>utils/notifications_utils.dart</code>：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token comment">// ignore_for_file: close_sinks</span>

<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'dart:async'</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_local_notifications/flutter_local_notifications.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/config.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/entity/msg/received_notification.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">NotificationsUtils</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始化plugins</span>
  <span class="token class-name">FlutterLocalNotificationsPlugin</span> flutterLocalNotificationsPlugin <span class="token operator">=</span>
      <span class="token class-name">FlutterLocalNotificationsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">StreamController</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReceivedNotification</span><span class="token punctuation">&gt;</span></span>
      didReceiveLocalNotificationStream <span class="token operator">=</span>
      <span class="token class-name">StreamController</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReceivedNotification</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">StreamController</span> selectNotificationStream <span class="token operator">=</span> <span class="token class-name">StreamController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 初始化消息</span>
  <span class="token function">initNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设置android icon</span>
    <span class="token keyword">const</span> <span class="token class-name">AndroidInitializationSettings</span> initializationSettingsAndroid <span class="token operator">=</span>
        <span class="token class-name">AndroidInitializationSettings</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@mipmap/ic_launcher'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 请求权限</span>
    <span class="token keyword">final</span> <span class="token class-name">IOSInitializationSettings</span> initializationSettingsIOS <span class="token operator">=</span>
        <span class="token class-name">IOSInitializationSettings</span><span class="token punctuation">(</span>
      requestSoundPermission<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      requestBadgePermission<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      requestAlertPermission<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token comment">// 接收消息回调</span>
      onDidReceiveLocalNotification<span class="token punctuation">:</span> onDidReceiveLocalNotification<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">MacOSInitializationSettings</span> initializationSettingsMacOS <span class="token operator">=</span>
        <span class="token class-name">MacOSInitializationSettings</span><span class="token punctuation">(</span>
            requestAlertPermission<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            requestBadgePermission<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            requestSoundPermission<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">InitializationSettings</span> initializationSettings <span class="token operator">=</span>
        <span class="token class-name">InitializationSettings</span><span class="token punctuation">(</span>
            android<span class="token punctuation">:</span> initializationSettingsAndroid<span class="token punctuation">,</span>
            iOS<span class="token punctuation">:</span> initializationSettingsIOS<span class="token punctuation">,</span>
            macOS<span class="token punctuation">:</span> initializationSettingsMacOS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 消息初始化</span>
    <span class="token keyword">await</span> flutterLocalNotificationsPlugin<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>initializationSettings<span class="token punctuation">,</span>
        <span class="token comment">// 点击消息的回调</span>
        onSelectNotification<span class="token punctuation">:</span> onSelectNotification<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">onDidReceiveLocalNotification</span><span class="token punctuation">(</span>
      int id<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">?</span> title<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">?</span> body<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">?</span> payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'onDidReceiveLocalNotification payload is 👉 </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">payload</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    didReceiveLocalNotificationStream<span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
      <span class="token class-name">ReceivedNotification</span><span class="token punctuation">(</span>
        id<span class="token punctuation">:</span> id<span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> title<span class="token punctuation">,</span>
        body<span class="token punctuation">:</span> body<span class="token punctuation">,</span>
        payload<span class="token punctuation">:</span> payload<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">onSelectNotification</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">?</span> payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>payload <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'onSelectNotification payload is 👉 </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">payload</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      selectNotificationStream<span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 单独出来的iOS请求权限</span>
  <span class="token function">requestIOSPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    bool<span class="token operator">?</span> result <span class="token operator">=</span> <span class="token keyword">await</span> flutterLocalNotificationsPlugin
        <span class="token punctuation">.</span>resolvePlatformSpecificImplementation<span class="token generics"><span class="token punctuation">&lt;</span>
            <span class="token class-name">IOSFlutterLocalNotificationsPlugin</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span>
          alert<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          badge<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          sound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 单独出来的MacOS请求权限</span>
  <span class="token function">requestMacOSPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    bool<span class="token operator">?</span> result <span class="token operator">=</span> <span class="token keyword">await</span> flutterLocalNotificationsPlugin
        <span class="token punctuation">.</span>resolvePlatformSpecificImplementation<span class="token generics"><span class="token punctuation">&lt;</span>
            <span class="token class-name">MacOSFlutterLocalNotificationsPlugin</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span>
          alert<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          badge<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          sound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 显示 消息</span>
  <span class="token keyword">show</span><span class="token punctuation">(</span><span class="token class-name">ReceivedNotification</span> receivedNotification<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token class-name">AndroidNotificationDetails</span> androidPlatformChannelSpecifics <span class="token operator">=</span>
        <span class="token class-name">AndroidNotificationDetails</span><span class="token punctuation">(</span><span class="token class-name">Config</span><span class="token punctuation">.</span>channelId<span class="token punctuation">,</span> <span class="token class-name">Config</span><span class="token punctuation">.</span>channelName<span class="token punctuation">,</span>
            channelDescription<span class="token punctuation">:</span> <span class="token class-name">Config</span><span class="token punctuation">.</span>channelDesc<span class="token punctuation">,</span>
            importance<span class="token punctuation">:</span> <span class="token class-name">Importance</span><span class="token punctuation">.</span>max<span class="token punctuation">,</span>
            priority<span class="token punctuation">:</span> <span class="token class-name">Priority</span><span class="token punctuation">.</span>high<span class="token punctuation">,</span>
            ticker<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'ticker'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token class-name">NotificationDetails</span> platformChannelSpecifics <span class="token operator">=</span>
        <span class="token class-name">NotificationDetails</span><span class="token punctuation">(</span>android<span class="token punctuation">:</span> androidPlatformChannelSpecifics<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> flutterLocalNotificationsPlugin<span class="token punctuation">.</span><span class="token keyword">show</span><span class="token punctuation">(</span>
      receivedNotification<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      receivedNotification<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
      receivedNotification<span class="token punctuation">.</span>body<span class="token punctuation">,</span>
      platformChannelSpecifics<span class="token punctuation">,</span>
      payload<span class="token punctuation">:</span> receivedNotification<span class="token punctuation">.</span>payload<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 针对 dart 中的stream进行性能上的优化，回收内存</span>
  <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    didReceiveLocalNotificationStream<span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    selectNotificationStream<span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在全局<code>get_it</code>进行实例化：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token comment">// ...</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/utils/notifications_utils.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">final</span> getIt <span class="token operator">=</span> <span class="token class-name">GetIt</span><span class="token punctuation">.</span>instance<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">setupGetIt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  getIt<span class="token punctuation">.</span>registerSingleton<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NotificationsUtils</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">NotificationsUtils</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="如何测试呢"><a href="#如何测试呢" class="header-anchor">#</a> 如何测试呢？</h3> <p>消息是异步的，可以在<code>main.dart</code>中进行测试：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
  <span class="token function">setupGetIt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// getIt.registerSingleton&lt;WebSocketUtils&gt;(WebSocketUtils(Config.wsUrl));</span>
  <span class="token comment">// WebSocketUtils webSocketUtils = getIt&lt;WebSocketUtils&gt;();</span>
  <span class="token class-name">NotificationsUtils</span> notificationsUtils <span class="token operator">=</span> getIt<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NotificationsUtils</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 请求消息权限</span>
  <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> notificationsUtils<span class="token punctuation">.</span><span class="token function">requestIOSPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> notificationsUtils<span class="token punctuation">.</span><span class="token function">initNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> notificationsUtils<span class="token punctuation">.</span><span class="token keyword">show</span><span class="token punctuation">(</span><span class="token class-name">ReceivedNotification</span><span class="token punctuation">(</span>
        id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'测试消息的title'</span></span><span class="token punctuation">,</span>
        body<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'测试消息的body'</span></span><span class="token punctuation">,</span> <span class="token comment">// payload部分会包含title与body，并且会传递type类型</span>
        <span class="token comment">// 微信 -&gt; 图片 -&gt; [图片]</span>
        <span class="token comment">// 1.type 解析</span>
        <span class="token comment">// 2.download图片 -&gt; 缩略图</span>
        <span class="token comment">// 3.点击图片 -&gt;</span>
        payload<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;{'title':'mytest', 'body': 'mybody'}...&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    notificationsUtils<span class="token punctuation">.</span>selectNotificationStream<span class="token punctuation">.</span>stream<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'event is 👉 </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">event</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">runApp</span><span class="token punctuation">(</span><span class="token class-name">MyApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="声音与震动"><a href="#声音与震动" class="header-anchor">#</a> 声音与震动</h3> <p>震动需要一个第三方库进行支持：</p> <div class="language-dart extra-class"><pre class="language-dart"><code>dependencies<span class="token punctuation">:</span>
  # 震动
  vibration<span class="token punctuation">:</span> <span class="token operator">^</span><span class="token number">1.7</span><span class="token number">.4</span><span class="token operator">-</span>nullsafety<span class="token punctuation">.</span><span class="token number">0</span>
</code></pre></div><p>在Storage中全局存储消息的静音与声音（同理，也可以针对不同的用户进行存储）：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:get_storage/get_storage.dart'</span></span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>

<span class="token keyword">enum</span> <span class="token class-name">StoreKeys</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  isMute<span class="token punctuation">,</span>
  isVibrate<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Storage</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token class-name">Storage</span> _storage <span class="token operator">=</span> <span class="token class-name">Storage</span><span class="token punctuation">.</span><span class="token function">_internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">GetStorage</span> _box <span class="token operator">=</span> <span class="token class-name">GetStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">GetStorage</span> <span class="token keyword">get</span> box <span class="token operator">=</span><span class="token operator">&gt;</span> _box<span class="token punctuation">;</span>

  <span class="token class-name">Storage</span><span class="token punctuation">.</span><span class="token function">_internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">factory</span> <span class="token class-name">Storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _storage<span class="token punctuation">;</span>

  <span class="token comment">// common set &amp; get</span>
  <span class="token keyword">void</span> write<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">StoreKeys</span> key<span class="token punctuation">,</span> <span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _box<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">T</span> read<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">StoreKeys</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _box<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// setToken, getToken</span>
  <span class="token function">setToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _box<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">StoreKeys</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span><span class="token operator">?</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _box<span class="token punctuation">.</span>read<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">StoreKeys</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>需要调整<code>show</code>方法时候的逻辑：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token comment">// 显示 消息</span>
<span class="token keyword">show</span><span class="token punctuation">(</span><span class="token class-name">ReceivedNotification</span> receivedNotification<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
  <span class="token comment">// isMute false-有声音， true-静音</span>
  bool isMute <span class="token operator">=</span> <span class="token class-name">Storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">StoreKeys</span><span class="token punctuation">.</span>isMute<span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// isVibrate 控制震动</span>
  bool isVibrate <span class="token operator">=</span> <span class="token class-name">Storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">StoreKeys</span><span class="token punctuation">.</span>isVibrate<span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token class-name">AndroidNotificationDetails</span> androidPlatformChannelSpecifics <span class="token operator">=</span>
    <span class="token class-name">AndroidNotificationDetails</span><span class="token punctuation">(</span>
    <span class="token class-name">Config</span><span class="token punctuation">.</span>channelId<span class="token punctuation">,</span>
    <span class="token class-name">Config</span><span class="token punctuation">.</span>channelName<span class="token punctuation">,</span>
    channelDescription<span class="token punctuation">:</span> <span class="token class-name">Config</span><span class="token punctuation">.</span>channelDesc<span class="token punctuation">,</span>
    importance<span class="token punctuation">:</span> <span class="token class-name">Importance</span><span class="token punctuation">.</span>max<span class="token punctuation">,</span>
    priority<span class="token punctuation">:</span> <span class="token class-name">Priority</span><span class="token punctuation">.</span>high<span class="token punctuation">,</span>
    ticker<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'ticker'</span></span><span class="token punctuation">,</span>
    playSound<span class="token punctuation">:</span> <span class="token operator">!</span>isMute<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">IOSNotificationDetails</span> iosNotificationDetails <span class="token operator">=</span>
    <span class="token class-name">IOSNotificationDetails</span><span class="token punctuation">(</span>presentSound<span class="token punctuation">:</span> <span class="token operator">!</span>isMute<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">NotificationDetails</span> platformChannelSpecifics <span class="token operator">=</span> <span class="token class-name">NotificationDetails</span><span class="token punctuation">(</span>
    android<span class="token punctuation">:</span> androidPlatformChannelSpecifics<span class="token punctuation">,</span> iOS<span class="token punctuation">:</span> iosNotificationDetails<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> flutterLocalNotificationsPlugin<span class="token punctuation">.</span><span class="token keyword">show</span><span class="token punctuation">(</span>
    receivedNotification<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    receivedNotification<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
    receivedNotification<span class="token punctuation">.</span>body<span class="token punctuation">,</span>
    platformChannelSpecifics<span class="token punctuation">,</span>
    payload<span class="token punctuation">:</span> receivedNotification<span class="token punctuation">.</span>payload<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isVibrate <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token class-name">Vibration</span><span class="token punctuation">.</span><span class="token function">hasVibrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 震动</span>
    <span class="token class-name">Vibration</span><span class="token punctuation">.</span><span class="token function">vibrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="首页导航"><a href="#首页导航" class="header-anchor">#</a> 首页导航</h2> <h3 id="屏幕适配"><a href="#屏幕适配" class="header-anchor">#</a> 屏幕适配</h3> <p><strong>flutter 屏幕适配方案，让UI在不同尺寸的屏幕上都能显示合理的布局!</strong></p> <p>依赖项：</p> <div class="language- extra-class"><pre class="language-text"><code>dependencies:
  flutter_screenutil: ^5.1.1
</code></pre></div><p>官方中文文档：<a href="https://github.com/OpenFlutter/flutter_screenutil/blob/master/README_CN.md" target="_blank" rel="noopener noreferrer">https://github.com/OpenFlutter/flutter_screenutil/blob/master/README_CN.md<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>基础的概念：</p> <table><thead><tr><th>属性</th> <th>类型</th> <th>默认值</th> <th>描述</th></tr></thead> <tbody><tr><td>designSize</td> <td>Size</td> <td>Size(360, 690)</td> <td>设计稿中设备的尺寸(<strong>单位随意,建议dp,但在使用过程中必须保持一致</strong>)</td></tr> <tr><td>builder</td> <td>Widget Function()</td> <td>Container()</td> <td>一般返回一个MaterialApp类型的Function()</td></tr> <tr><td>orientation</td> <td>Orientation</td> <td>portrait</td> <td>屏幕方向</td></tr> <tr><td>splitScreenMode</td> <td>bool</td> <td>true</td> <td>支持分屏尺寸</td></tr> <tr><td>minTextAdapt</td> <td>bool</td> <td>false</td> <td>是否根据宽度/高度中的最小值适配文字</td></tr> <tr><td>context</td> <td>BuildContext</td> <td>null</td> <td>传入context会更灵敏的根据屏幕变化而改变</td></tr></tbody></table> <p>关于设计尺寸，一般是2x的设计尺寸：</p> <p><img src="/notes-page/assets/img/image-20220129105243936.ccc5cf4e.png" alt="image-20220129105243936"></p> <p>初始化，修改<code>main.dart</code>文件：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">class</span> <span class="token class-name">MyApp</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
      debugShowCheckedModeBanner<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      title<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'Flutter_ScreenUtil'</span></span><span class="token punctuation">,</span>
      theme<span class="token punctuation">:</span> <span class="token class-name">ThemeData</span><span class="token punctuation">(</span>
        primarySwatch<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      home<span class="token punctuation">:</span> <span class="token class-name">HomePage</span><span class="token punctuation">(</span>title<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'FlutterScreenUtil Demo'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">HomePage</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token class-name">HomePage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Key</span> key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  _HomePageState <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_HomePageState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> _HomePageState <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HomePage</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//设置尺寸（填写设计中设备的屏幕尺寸）如果设计基于360dp * 690dp的屏幕</span>
    <span class="token class-name">ScreenUtil</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>
        <span class="token class-name">BoxConstraints</span><span class="token punctuation">(</span>
            maxWidth<span class="token punctuation">:</span> <span class="token class-name">MediaQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>size<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
            maxHeight<span class="token punctuation">:</span> <span class="token class-name">MediaQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
        designSize<span class="token punctuation">:</span> <span class="token class-name">Size</span><span class="token punctuation">(</span><span class="token number">360</span><span class="token punctuation">,</span> <span class="token number">690</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        context<span class="token punctuation">:</span> context<span class="token punctuation">,</span>
        minTextAdapt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        orientation<span class="token punctuation">:</span> <span class="token class-name">Orientation</span><span class="token punctuation">.</span>portrait<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Scaffold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>ScreenUtil.init只需在home或者根路由（即第一个flutter页面）中调用一次即可。</strong></p> <blockquote><p>注意：不支持在<code>MaterialApp</code>的<code>theme</code>的<code>textTheme</code>中使用字体适配。——非常好理解，那时候该插件还未初始化完成。</p></blockquote> <p>大前端的项目中如何初始化：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token comment">// ...</span>
<span class="token keyword">return</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">.</span><span class="token function">router</span><span class="token punctuation">(</span>
  routeInformationParser<span class="token punctuation">:</span> _rootRouter<span class="token punctuation">.</span><span class="token function">defaultRouteParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  routerDelegate<span class="token punctuation">:</span> _rootRouter<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ScreenUtil</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>
      <span class="token class-name">BoxConstraints</span><span class="token punctuation">(</span>
        maxWidth<span class="token punctuation">:</span> <span class="token class-name">MediaQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">.</span>size<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
        maxHeight<span class="token punctuation">:</span> <span class="token class-name">MediaQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">.</span>size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
      designSize<span class="token punctuation">:</span> <span class="token class-name">Size</span><span class="token punctuation">(</span><span class="token number">750</span><span class="token punctuation">,</span> <span class="token number">1334</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 默认的屏幕方向</span>
      orientation<span class="token punctuation">:</span> <span class="token class-name">Orientation</span><span class="token punctuation">.</span>portrait<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 示例，防止返回null</span>
    <span class="token keyword">return</span> child <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> child <span class="token punctuation">:</span> <span class="token class-name">Container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用方法：</p> <p>传入设计稿的dp尺寸</p> <div class="language- extra-class"><pre class="language-text"><code>    ScreenUtil().setWidth(540)  (sdk&gt;=2.6 : 540.w)   //根据屏幕宽度适配尺寸
    ScreenUtil().setHeight(200) (sdk&gt;=2.6 : 200.h)   //根据屏幕高度适配尺寸(一般根据宽度适配即可)
    ScreenUtil().radius(200)    (sdk&gt;=2.6 : 200.r)   //根据宽度或高度中的较小者进行调整
    ScreenUtil().setSp(24)      (sdk&gt;=2.6 : 24.sp)   //适配字体
    12.sm   // 取12和12.sp中的最小值

    ScreenUtil.pixelRatio       //设备的像素密度
    ScreenUtil.screenWidth   (sdk&gt;=2.6 : 1.sw)   //设备宽度
    ScreenUtil.screenHeight  (sdk&gt;=2.6 : 1.sh)   //设备高度
    ScreenUtil.bottomBarHeight  //底部安全区距离，适用于全面屏下面有按键的
    ScreenUtil.statusBarHeight  //状态栏高度 刘海屏会更高
    ScreenUtil.textScaleFactor //系统字体缩放比例

    ScreenUtil().scaleWidth  // 实际宽度设计稿宽度的比例
    ScreenUtil().scaleHeight // 实际高度与设计稿高度度的比例

    ScreenUtil().orientation  //屏幕方向

    0.2.sw  //屏幕宽度的0.2倍
    0.5.sh  //屏幕高度的50%
</code></pre></div><p>如果Flutter的sdk是大于等于2.6（sdk&gt;=2.6）的，可以使用扩展函数：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token class-name">Container</span><span class="token punctuation">(</span>
  width<span class="token punctuation">:</span> <span class="token number">50.</span>w<span class="token punctuation">,</span>
  height<span class="token punctuation">:</span><span class="token number">200.</span>h
<span class="token punctuation">)</span>
</code></pre></div><p>等价：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token class-name">Container</span><span class="token punctuation">(</span>
  width<span class="token punctuation">:</span> <span class="token class-name">ScreenUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setWidth</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  height<span class="token punctuation">:</span><span class="token class-name">ScreenUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHeight</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre></div><p>简洁了好多。</p> <h3 id="底部导航"><a href="#底部导航" class="header-anchor">#</a> 底部导航</h3> <p>本节完成的最终效果：</p> <p><img src="/notes-page/assets/img/image-20220129110146158.d2ef885c.png" alt="image-20220129110146158"></p> <p>步骤：</p> <ul><li><p>升级auto_route至3.x的版本：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">dependencies</span><span class="token punctuation">:</span>
  <span class="token comment"># ...</span>
  <span class="token comment"># 自动路由</span>
  <span class="token key atrule">auto_route</span><span class="token punctuation">:</span> ^3.0.1

<span class="token key atrule">dev_dependencies</span><span class="token punctuation">:</span>
  <span class="token comment"># ...</span>
  <span class="token comment"># 自动路由</span>
  <span class="token key atrule">auto_route_generator</span><span class="token punctuation">:</span> ^3.0.1
</code></pre></div></li> <li><p>新建4个测试页面首页、消息、热门、我的：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/material.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HomePage</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token class-name">HomePage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Container</span><span class="token punctuation">(</span>
      child<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'HomePage'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>创建首页的<code>routes.dart</code>页面</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:auto_route/auto_route.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/pages/home/detail_page.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/pages/home/home_page.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> homeTab <span class="token operator">=</span> <span class="token class-name">AutoRoute</span><span class="token punctuation">(</span>
  path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'home'</span></span><span class="token punctuation">,</span>
  page<span class="token punctuation">:</span> <span class="token class-name">EmptyRouterPage</span><span class="token punctuation">,</span>
  name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'HomeTab'</span></span><span class="token punctuation">,</span>
  initial<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token class-name">AutoRoute</span><span class="token punctuation">(</span>
      path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">,</span>
      page<span class="token punctuation">:</span> <span class="token class-name">HomePage</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">AutoRoute</span><span class="token punctuation">(</span>
      path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">':id'</span></span><span class="token punctuation">,</span>
      page<span class="token punctuation">:</span> <span class="token class-name">DetailPage</span><span class="token punctuation">,</span>
      meta<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string-literal"><span class="token string">'hideBottomNav'</span></span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>说明：多页面的路由，可以写在统一的文件夹下，也可以写在各个文件中，根据自己的喜好来定。</p></blockquote> <p><img src="/notes-page/assets/img/image-20220129112421209.faf10800.png" alt="image-20220129112421209"></p></li> <li><p>总路由文件<code>routes/routes.dart</code>：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:auto_route/auto_route.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/pages/center/center_page.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/pages/center/routes.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/pages/center/settings_page.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/pages/home/home_page.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/pages/home/routes.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/pages/hot/hot_page.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/pages/hot/routes.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/pages/login_view.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/pages/msg/msg_page.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/pages/msg/routes.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/pages/root_view.dart'</span></span><span class="token punctuation">;</span>

<span class="token metadata function">@AdaptiveAutoRouter</span><span class="token punctuation">(</span>
  routes<span class="token punctuation">:</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AutoRoute</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>
    <span class="token class-name">AutoRoute</span><span class="token punctuation">(</span>
      page<span class="token punctuation">:</span> <span class="token class-name">RootView</span><span class="token punctuation">,</span>
      path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;/&quot;</span></span><span class="token punctuation">,</span>
      children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        homeTab<span class="token punctuation">,</span> <span class="token comment">// 这个其实有点像嵌套路由？是吧！</span>
        msgTab<span class="token punctuation">,</span>
        hotTab<span class="token punctuation">,</span>
        centerTab<span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">AutoRoute</span><span class="token punctuation">(</span>page<span class="token punctuation">:</span> <span class="token class-name">LoginView</span><span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;/login&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// AutoRoute(page: HomeView, path: &quot;/home-view/:id&quot;, guards: [AuthGuard]),</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">class</span> $<span class="token class-name">AppRouter</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div></li> <li><p>修改<code>root_view.dart</code>文件：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:auto_route/auto_route.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/material.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_screenutil/flutter_screenutil.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/routes/routes.gr.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">RootView</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token class-name">RootView</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">WillPopScope</span><span class="token punctuation">(</span>
      onWillPop<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token class-name">AutoTabsScaffold</span><span class="token punctuation">(</span>
        appBarBuilder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> tabsRouter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 这里的AutoBackButton也是一个auto_route的组件</span>
          <span class="token keyword">return</span> <span class="token class-name">AppBar</span><span class="token punctuation">(</span>
              title<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>topRoute<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> leading<span class="token punctuation">:</span> <span class="token class-name">AutoBackButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        routes<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token class-name">HomeTab</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">MsgTab</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">HotTab</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">CenterTab</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        bottomNavigationBuilder<span class="token punctuation">:</span> buildBottomNav<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Widget</span> <span class="token function">buildBottomNav</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">,</span> <span class="token class-name">TabsRouter</span> tabsRouter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 控制底部是否显示 -&gt; 有点像企业微信、钉钉等应用</span>
    <span class="token keyword">final</span> hideBottomNav <span class="token operator">=</span> context<span class="token punctuation">.</span>topRouteMatch<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'hideBottomNav'</span></span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> hideBottomNav
        <span class="token operator">?</span> <span class="token class-name">SizedBox</span><span class="token punctuation">.</span><span class="token function">shrink</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token class-name">BottomNavigationBar</span><span class="token punctuation">(</span>
            currentIndex<span class="token punctuation">:</span> tabsRouter<span class="token punctuation">.</span>activeIndex<span class="token punctuation">,</span>
            onTap<span class="token punctuation">:</span> tabsRouter<span class="token punctuation">.</span>setActiveIndex<span class="token punctuation">,</span>
            <span class="token comment">// 这里是控制切换的缩放效果</span>
            type<span class="token punctuation">:</span> <span class="token class-name">BottomNavigationBarType</span><span class="token punctuation">.</span>fixed<span class="token punctuation">,</span>
            <span class="token comment">// 使用前置的适配方案screenutil</span>
            selectedFontSize<span class="token punctuation">:</span> <span class="token number">22.</span>sp<span class="token punctuation">,</span>
            unselectedFontSize<span class="token punctuation">:</span> <span class="token number">22.</span>sp<span class="token punctuation">,</span>
            selectedItemColor<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>red<span class="token punctuation">,</span>
            items<span class="token punctuation">:</span> <span class="token punctuation">[</span>
              <span class="token class-name">BottomNavigationBarItem</span><span class="token punctuation">(</span>
                icon<span class="token punctuation">:</span> <span class="token class-name">Icon</span><span class="token punctuation">(</span><span class="token class-name">Icons</span><span class="token punctuation">.</span>home<span class="token punctuation">)</span><span class="token punctuation">,</span>
                backgroundColor<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>black<span class="token punctuation">,</span>
                label<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'首页'</span></span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token class-name">BottomNavigationBarItem</span><span class="token punctuation">(</span>
                icon<span class="token punctuation">:</span> <span class="token class-name">Icon</span><span class="token punctuation">(</span><span class="token class-name">Icons</span><span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span>
                label<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'消息'</span></span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token class-name">BottomNavigationBarItem</span><span class="token punctuation">(</span>
                icon<span class="token punctuation">:</span> <span class="token class-name">Icon</span><span class="token punctuation">(</span><span class="token class-name">Icons</span><span class="token punctuation">.</span>hot_tub<span class="token punctuation">)</span><span class="token punctuation">,</span>
                label<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'热门'</span></span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token class-name">BottomNavigationBarItem</span><span class="token punctuation">(</span>
                icon<span class="token punctuation">:</span> <span class="token class-name">Icon</span><span class="token punctuation">(</span><span class="token class-name">Icons</span><span class="token punctuation">.</span>person<span class="token punctuation">)</span><span class="token punctuation">,</span>
                label<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'我的'</span></span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="下拉刷新-上拉加载"><a href="#下拉刷新-上拉加载" class="header-anchor">#</a> 下拉刷新（上拉加载）</h3> <p>下拉刷新是移动端应用中最普通、最常见的场景，推荐的第三方库有：</p> <ul><li>pull_to_refresh（推荐）</li> <li>flutter_easyrefresh</li></ul> <p>它们都有中文的文档，下面来看看如何实现首页列表的下拉刷新：</p> <p>安装依赖</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">dependencies</span><span class="token punctuation">:</span>
  <span class="token comment"># 下拉刷新 + 上拉加载</span>
  <span class="token key atrule">pull_to_refresh</span><span class="token punctuation">:</span> ^2.0.0
</code></pre></div><p>基本使用，调整<code>lib/pages/home/home_page.dart</code></p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'dart:async'</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/cupertino.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/material.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/entity/content/post.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/services/content_service.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:my_app/setup_get_it.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:pull_to_refresh/pull_to_refresh.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HomePage</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token class-name">HomePage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HomePage</span><span class="token punctuation">&gt;</span></span> <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_HomePageState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> _HomePageState <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HomePage</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token class-name">ContentService</span> contentService <span class="token operator">=</span> getIt<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ContentService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-literal"><span class="token string">&quot;1&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;2&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;3&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;4&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;5&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;6&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;7&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;8&quot;</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token class-name">RefreshController</span> _refreshController <span class="token operator">=</span>
      <span class="token class-name">RefreshController</span><span class="token punctuation">(</span>initialRefresh<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> _lists<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 方法一：Timer</span>
    <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span>zero<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
      _lists <span class="token operator">=</span> <span class="token keyword">await</span> contentService<span class="token punctuation">.</span><span class="token function">getPostList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Widget</span><span class="token operator">?</span> body<span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">_onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token comment">// 往头部加数据</span>
    <span class="token comment">// newData数据库请求回来的数据</span>
    <span class="token comment">// _lists = &lt;Post&gt;[]</span>
    <span class="token comment">//   ..addAll(newData)</span>
    <span class="token comment">//   ..addAll(_lists??[]);</span>
    <span class="token comment">// monitor network fetch</span>
    <span class="token keyword">await</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">(</span>milliseconds<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// if failed,use refreshFailed()</span>
    <span class="token comment">// 告诉插件已经刷新完成</span>
    _refreshController<span class="token punctuation">.</span><span class="token function">refreshCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">_onLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token comment">// monitor network fetch</span>
    <span class="token keyword">await</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">(</span>milliseconds<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断,返回的数组长度与length的关系来去决定执行loadNoDat还是loadComplete</span>
    <span class="token comment">// length &lt; limit loadNoData</span>
    <span class="token comment">// length == limit loadComplete</span>
    <span class="token comment">// if failed,use loadFailed(),if no data return,use LoadNodata()</span>
    items<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mounted<span class="token punctuation">)</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _refreshController<span class="token punctuation">.</span><span class="token function">loadNoData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// pull_to_refresh的自带组件：</span>
    <span class="token keyword">return</span> <span class="token class-name">SmartRefresher</span><span class="token punctuation">(</span>
      enablePullDown<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      enablePullUp<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      header<span class="token punctuation">:</span> <span class="token class-name">WaterDropHeader</span><span class="token punctuation">(</span>
        complete<span class="token punctuation">:</span> <span class="token class-name">Container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 关闭过渡效果</span>
        completeDuration<span class="token punctuation">:</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span>zero<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      footer<span class="token punctuation">:</span> <span class="token class-name">CustomFooter</span><span class="token punctuation">(</span>
        <span class="token comment">// 自定义脚部显示的文字</span>
        builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token class-name">LoadStatus</span><span class="token punctuation">.</span>idle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            body <span class="token operator">=</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;上拉加载&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token class-name">LoadStatus</span><span class="token punctuation">.</span>loading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            body <span class="token operator">=</span> <span class="token class-name">CupertinoActivityIndicator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token class-name">LoadStatus</span><span class="token punctuation">.</span>failed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            body <span class="token operator">=</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;加载失败！点击重试！&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token class-name">LoadStatus</span><span class="token punctuation">.</span>canLoading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            body <span class="token operator">=</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;松手,加载更多!&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            body <span class="token operator">=</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;没有更多数据了!&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token class-name">Container</span><span class="token punctuation">(</span>
            height<span class="token punctuation">:</span> <span class="token number">55.0</span><span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>child<span class="token punctuation">:</span> body<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      controller<span class="token punctuation">:</span> _refreshController<span class="token punctuation">,</span>
      onRefresh<span class="token punctuation">:</span> _onRefresh<span class="token punctuation">,</span>
      onLoading<span class="token punctuation">:</span> _onLoading<span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token class-name">ListView</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
        itemBuilder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
            <span class="token class-name">Card</span><span class="token punctuation">(</span>child<span class="token punctuation">:</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>child<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>_lists<span class="token operator">!</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        itemExtent<span class="token punctuation">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
        itemCount<span class="token punctuation">:</span> _lists<span class="token operator">?</span><span class="token punctuation">.</span>length <span class="token operator">?</span><span class="token operator">?</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>需要注意，sqflite如果是一直插入数据，可能会导致数据重复，如何避免？</p> <p>调整<code>content_provider.dart</code>：</p> <div class="language-dart extra-class"><pre class="language-dart"><code>  <span class="token function">addPostBatch</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span></span> lists<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> db <span class="token operator">=</span> <span class="token keyword">await</span> database<span class="token punctuation">;</span>
      <span class="token class-name">Batch</span> batch <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">batch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      lists<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        batch<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>
          <span class="token string-literal"><span class="token string">'posts'</span></span><span class="token punctuation">,</span>
          element<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token comment">// 如果主键冲突，直接忽略即可</span>
          conflictAlgorithm<span class="token punctuation">:</span> <span class="token class-name">ConflictAlgorithm</span><span class="token punctuation">.</span>ignore<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token keyword">await</span> batch<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'err is 👉 </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">err</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="长列表异步数据方案"><a href="#长列表异步数据方案" class="header-anchor">#</a> 长列表异步数据方案</h3> <p>上面的章节，介绍了下拉刷新与上拉加载，但是对于异步大量的数据，使用数组的方案，效率低下，而且可能会带来性能问题。如果是长列表异步数据，就需要借助原生组件 <code>StreamBuilder</code>和<code>FutureBuilder</code> 了。</p> <p>首先，需要调整接口服务，返回特定的<code>Post</code>性能数据：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">class</span> <span class="token class-name">ContentService</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取文章列表</span>
  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPostList</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token class-name">ListQuery</span><span class="token operator">?</span> query<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword">dynamic</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> query<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Response</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token class-name">DioHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'/public/list'</span></span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>statusCode <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">HttpResponse</span> httpResponse <span class="token operator">=</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>httpResponse<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span></span> lists <span class="token operator">=</span>
            httpResponse<span class="token punctuation">.</span>data<span class="token punctuation">.</span>map<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Post</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// print('lists is 👉 $lists');</span>
        <span class="token keyword">await</span> <span class="token class-name">ContentProvider</span><span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">addPostBatch</span><span class="token punctuation">(</span>lists<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> lists<span class="token punctuation">;</span>
        <span class="token comment">// var res2 = await ContentProvider.db.getPost('5fde262d7f2fcb6844ada5a9');</span>
        <span class="token comment">// print('res is 👉 $res1');</span>
        <span class="token comment">// print('res is 👉 $res2');</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在<code>home_page.dart</code>中使用：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token metadata function">@override</span>
<span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token class-name">FutureBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
    future<span class="token punctuation">:</span> <span class="token function">_getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// FutureBuilder -&gt; future -&gt; 执行一次</span>
    <span class="token comment">// StreamBuilder -&gt; stream -&gt; 执行多次 -&gt; streamControler.sink.add</span>
    builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>snapshot<span class="token punctuation">.</span>hasData<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token class-name">SmartRefresher</span><span class="token punctuation">(</span>
        enablePullDown<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        enablePullUp<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        header<span class="token punctuation">:</span> <span class="token class-name">WaterDropHeader</span><span class="token punctuation">(</span>
          complete<span class="token punctuation">:</span> <span class="token class-name">Container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          completeDuration<span class="token punctuation">:</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span>zero<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        footer<span class="token punctuation">:</span> <span class="token class-name">CustomFooter</span><span class="token punctuation">(</span>
          builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token class-name">LoadStatus</span><span class="token punctuation">.</span>idle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              body <span class="token operator">=</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;上拉加载&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token class-name">LoadStatus</span><span class="token punctuation">.</span>loading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              body <span class="token operator">=</span> <span class="token class-name">CupertinoActivityIndicator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token class-name">LoadStatus</span><span class="token punctuation">.</span>failed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              body <span class="token operator">=</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;加载失败！点击重试！&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token class-name">LoadStatus</span><span class="token punctuation">.</span>canLoading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              body <span class="token operator">=</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;松手,加载更多!&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              body <span class="token operator">=</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;没有更多数据了!&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">Container</span><span class="token punctuation">(</span>
              height<span class="token punctuation">:</span> <span class="token number">55.0</span><span class="token punctuation">,</span>
              child<span class="token punctuation">:</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>child<span class="token punctuation">:</span> body<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        controller<span class="token punctuation">:</span> _refreshController<span class="token punctuation">,</span>
        onRefresh<span class="token punctuation">:</span> _onRefresh<span class="token punctuation">,</span>
        onLoading<span class="token punctuation">:</span> _onLoading<span class="token punctuation">,</span>
        child<span class="token punctuation">:</span> <span class="token class-name">ListView</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
          itemBuilder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
          <span class="token class-name">Card</span><span class="token punctuation">(</span>child<span class="token punctuation">:</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>child<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>_lists<span class="token operator">!</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          itemExtent<span class="token punctuation">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
          itemCount<span class="token punctuation">:</span> _lists<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">CupertinoActivityIndicator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的<code>_getData()</code>如下：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token class-name">ContentService</span> contentService <span class="token operator">=</span> getIt<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ContentService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 定义页面数据</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span></span> _lists <span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">_getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
  _lists <span class="token operator">=</span> <span class="token keyword">await</span> contentService<span class="token punctuation">.</span><span class="token function">getPostList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> _lists<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <!----> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notes-page/project/community-flutter/17-路由.html" class="prev">
        路由
      </a></span> <span class="next"><a href="/notes-page/project/community-flutter/19-苹果开发者.html">
        苹果开发者
      </a>
      →
    </span></p></div>  <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="dialog" class="el-dialog" style="margin-top:15vh;width:420px;"><div class="el-dialog__header"><span class="el-dialog__title"></span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><div class="el-dialog__footer"><span class="dialog-footer"><button type="button" class="el-button el-button--default"><!----><!----><span>取 消</span></button> <button type="button" class="el-button el-button--primary"><!----><!----><span>确 定</span></button></span></div></div></div></main> <!----></div><div class="global-ui"><!----><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button title="Close" aria-label="Close" class="pswp__button pswp__button--close"></button> <button title="Share" aria-label="Share" class="pswp__button pswp__button--share"></button> <button title="Switch to full screen" aria-label="Switch to full screen" class="pswp__button pswp__button--fs"></button> <button title="Zoom in/out" aria-label="Zoom in/out" class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button title="Prev (Arrow Left)" aria-label="Prev (Arrow Left)" class="pswp__button pswp__button--arrow--left"></button> <button title="Next (Arrow Right)" aria-label="Next (Arrow Right)" class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/notes-page/assets/js/app.8b6f2d66.js" defer></script><script src="/notes-page/assets/js/5.5563c583.js" defer></script><script src="/notes-page/assets/js/49.67abcb40.js" defer></script>
  </body>
</html>
