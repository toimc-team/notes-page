<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>å°ç¨‹åºé‰´æƒç™»å½• | å¤§å‰ç«¯ - å‰ç«¯é«˜çº§è¿›é˜¶</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="å¤§å‰ç«¯è¯¾ç¨‹ç”µå­ä¹¦">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/notes-page/assets/css/0.styles.7630b5f8.css" as="style"><link rel="preload" href="/notes-page/assets/js/app.6a272afa.js" as="script"><link rel="preload" href="/notes-page/assets/js/4.89a9d4d5.js" as="script"><link rel="preload" href="/notes-page/assets/js/5.fc017d19.js" as="script"><link rel="preload" href="/notes-page/assets/js/18.d4ed5ee7.js" as="script"><link rel="prefetch" href="/notes-page/assets/js/10.7d814253.js"><link rel="prefetch" href="/notes-page/assets/js/11.72055179.js"><link rel="prefetch" href="/notes-page/assets/js/12.97b894b8.js"><link rel="prefetch" href="/notes-page/assets/js/13.3ac1c362.js"><link rel="prefetch" href="/notes-page/assets/js/14.62c3cbf8.js"><link rel="prefetch" href="/notes-page/assets/js/15.b3a9cc05.js"><link rel="prefetch" href="/notes-page/assets/js/16.9cbef76a.js"><link rel="prefetch" href="/notes-page/assets/js/17.8dcce186.js"><link rel="prefetch" href="/notes-page/assets/js/19.4e8316e6.js"><link rel="prefetch" href="/notes-page/assets/js/2.031fd3f3.js"><link rel="prefetch" href="/notes-page/assets/js/20.c9dfd849.js"><link rel="prefetch" href="/notes-page/assets/js/21.e88dbd8f.js"><link rel="prefetch" href="/notes-page/assets/js/22.57351e6e.js"><link rel="prefetch" href="/notes-page/assets/js/23.913c8273.js"><link rel="prefetch" href="/notes-page/assets/js/24.436381c1.js"><link rel="prefetch" href="/notes-page/assets/js/25.0515d2de.js"><link rel="prefetch" href="/notes-page/assets/js/26.0a3edca5.js"><link rel="prefetch" href="/notes-page/assets/js/27.3ab22b95.js"><link rel="prefetch" href="/notes-page/assets/js/28.09572890.js"><link rel="prefetch" href="/notes-page/assets/js/29.aa753e0b.js"><link rel="prefetch" href="/notes-page/assets/js/3.f555fc76.js"><link rel="prefetch" href="/notes-page/assets/js/30.8fb313ad.js"><link rel="prefetch" href="/notes-page/assets/js/31.d70e450f.js"><link rel="prefetch" href="/notes-page/assets/js/32.6b3375a2.js"><link rel="prefetch" href="/notes-page/assets/js/33.b753be4a.js"><link rel="prefetch" href="/notes-page/assets/js/34.63390339.js"><link rel="prefetch" href="/notes-page/assets/js/35.34b8a032.js"><link rel="prefetch" href="/notes-page/assets/js/36.11d326f2.js"><link rel="prefetch" href="/notes-page/assets/js/37.25539fd0.js"><link rel="prefetch" href="/notes-page/assets/js/38.467a3ea4.js"><link rel="prefetch" href="/notes-page/assets/js/39.e5cb65bd.js"><link rel="prefetch" href="/notes-page/assets/js/40.2fca0a5f.js"><link rel="prefetch" href="/notes-page/assets/js/41.c6e7de9b.js"><link rel="prefetch" href="/notes-page/assets/js/42.9de21078.js"><link rel="prefetch" href="/notes-page/assets/js/43.82b5e6ef.js"><link rel="prefetch" href="/notes-page/assets/js/44.a7f07f9b.js"><link rel="prefetch" href="/notes-page/assets/js/45.3779588e.js"><link rel="prefetch" href="/notes-page/assets/js/46.f7804bc4.js"><link rel="prefetch" href="/notes-page/assets/js/47.85f4011b.js"><link rel="prefetch" href="/notes-page/assets/js/48.658925e7.js"><link rel="prefetch" href="/notes-page/assets/js/49.04706b70.js"><link rel="prefetch" href="/notes-page/assets/js/50.6251c4c1.js"><link rel="prefetch" href="/notes-page/assets/js/51.0d7b8697.js"><link rel="prefetch" href="/notes-page/assets/js/52.2423f6a0.js"><link rel="prefetch" href="/notes-page/assets/js/53.a184eb44.js"><link rel="prefetch" href="/notes-page/assets/js/54.898de1e6.js"><link rel="prefetch" href="/notes-page/assets/js/55.b9cedb06.js"><link rel="prefetch" href="/notes-page/assets/js/56.4340f249.js"><link rel="prefetch" href="/notes-page/assets/js/57.ad824942.js"><link rel="prefetch" href="/notes-page/assets/js/58.e71fa6ca.js"><link rel="prefetch" href="/notes-page/assets/js/59.e748b143.js"><link rel="prefetch" href="/notes-page/assets/js/6.74707500.js"><link rel="prefetch" href="/notes-page/assets/js/60.3861ef5c.js"><link rel="prefetch" href="/notes-page/assets/js/61.bc0b5449.js"><link rel="prefetch" href="/notes-page/assets/js/62.69afa7bb.js"><link rel="prefetch" href="/notes-page/assets/js/63.35f7ac3a.js"><link rel="prefetch" href="/notes-page/assets/js/64.f7ea2362.js"><link rel="prefetch" href="/notes-page/assets/js/65.edc06c87.js"><link rel="prefetch" href="/notes-page/assets/js/66.bcd6526c.js"><link rel="prefetch" href="/notes-page/assets/js/67.96f1428b.js"><link rel="prefetch" href="/notes-page/assets/js/68.d483ab2d.js"><link rel="prefetch" href="/notes-page/assets/js/69.e600924e.js"><link rel="prefetch" href="/notes-page/assets/js/7.5ab2d19b.js"><link rel="prefetch" href="/notes-page/assets/js/70.d221e362.js"><link rel="prefetch" href="/notes-page/assets/js/71.f4ced374.js"><link rel="prefetch" href="/notes-page/assets/js/72.40f94fbb.js"><link rel="prefetch" href="/notes-page/assets/js/73.8dc831dc.js"><link rel="prefetch" href="/notes-page/assets/js/74.96bbf503.js"><link rel="prefetch" href="/notes-page/assets/js/75.f2c926d3.js"><link rel="prefetch" href="/notes-page/assets/js/76.2f937ff9.js"><link rel="prefetch" href="/notes-page/assets/js/77.e84b344b.js"><link rel="prefetch" href="/notes-page/assets/js/78.fb34d21a.js"><link rel="prefetch" href="/notes-page/assets/js/79.1cf4b658.js"><link rel="prefetch" href="/notes-page/assets/js/8.18ba11b5.js"><link rel="prefetch" href="/notes-page/assets/js/80.fe8cf80d.js"><link rel="prefetch" href="/notes-page/assets/js/81.fb7098e1.js"><link rel="prefetch" href="/notes-page/assets/js/82.446cf7e5.js"><link rel="prefetch" href="/notes-page/assets/js/83.dc3e6792.js"><link rel="prefetch" href="/notes-page/assets/js/84.b3ccbbf5.js"><link rel="prefetch" href="/notes-page/assets/js/85.96f66112.js"><link rel="prefetch" href="/notes-page/assets/js/86.0475e589.js"><link rel="prefetch" href="/notes-page/assets/js/87.a8f796bd.js"><link rel="prefetch" href="/notes-page/assets/js/88.d2d1b185.js"><link rel="prefetch" href="/notes-page/assets/js/89.80f87d37.js"><link rel="prefetch" href="/notes-page/assets/js/9.6fb9e220.js"><link rel="prefetch" href="/notes-page/assets/js/90.5b0a6c7e.js"><link rel="prefetch" href="/notes-page/assets/js/91.4813d2b1.js">
    <link rel="stylesheet" href="/notes-page/assets/css/0.styles.7630b5f8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes-page/" class="home-link router-link-active"><!----> <span class="site-name">å¤§å‰ç«¯ - å‰ç«¯é«˜çº§è¿›é˜¶</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>ç¤¾åŒºPC</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-pc/" class="sidebar-link">PC</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>ç¤¾åŒºç®¡ç†åå°</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-admin/" class="sidebar-link">ç®¡ç†åå°</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>ç¤¾åŒºWebApp</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-webapp/" class="sidebar-link">webapp</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>å°ç¨‹åº</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-miniapp/" aria-current="page" class="sidebar-link">uniappä»‹ç»</a></li><li><a href="/notes-page/project/community-miniapp/1-æ­å»ºå¼€å‘ç¯å¢ƒ.html" class="sidebar-link">æ­å»ºå¼€å‘ç¯å¢ƒ</a></li><li><a href="/notes-page/project/community-miniapp/2-é¦–é¡µæ¨¡å—.html" class="sidebar-link">é¦–é¡µæ¨¡å—</a></li><li><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html" class="active sidebar-link">å°ç¨‹åºé‰´æƒç™»å½•</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#éœ€æ±‚åˆ†æ" class="sidebar-link">éœ€æ±‚åˆ†æ</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#vuexé›†æˆuniapp" class="sidebar-link">Vuexé›†æˆuniapp</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#åˆå§‹åŒ–store" class="sidebar-link">åˆå§‹åŒ–store</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#å¦‚ä½•è¿›è¡Œè°ƒè¯•" class="sidebar-link">å¦‚ä½•è¿›è¡Œè°ƒè¯•</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#å¾®ä¿¡å®˜æ–¹æœåŠ¡ç›¸å…³" class="sidebar-link">å¾®ä¿¡å®˜æ–¹æœåŠ¡ç›¸å…³</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#è·å–appidä¸appsecret" class="sidebar-link">è·å–AppIDä¸AppSecret</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#unionidä¸openid" class="sidebar-link">unionidä¸openid</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#è·å–ç”¨æˆ·opendata" class="sidebar-link">è·å–ç”¨æˆ·OpenData</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#é‰´æƒé¡µé¢æ ·å¼" class="sidebar-link">é‰´æƒé¡µé¢æ ·å¼</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#è§£å¯†å¾®ä¿¡æ•°æ®" class="sidebar-link">è§£å¯†å¾®ä¿¡æ•°æ®</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#ç”¨æˆ·ä¿¡æ¯çš„è§£å¯†" class="sidebar-link">ç”¨æˆ·ä¿¡æ¯çš„è§£å¯†</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#ç”¨æˆ·ç™»å½•å‡­è¯ç»´æŠ¤" class="sidebar-link">ç”¨æˆ·ç™»å½•å‡­è¯ç»´æŠ¤</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#ç”¨æˆ·ç™»å½•æ¥å£" class="sidebar-link">ç”¨æˆ·ç™»å½•æ¥å£</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#æ‰‹æœºç™»å½•" class="sidebar-link">æ‰‹æœºç™»å½•</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#å¦‚ä½•é€‰æ‹©çŸ­ä¿¡æœåŠ¡å•†" class="sidebar-link">å¦‚ä½•é€‰æ‹©çŸ­ä¿¡æœåŠ¡å•†</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#ç™»å½•é¡µé¢æ ·å¼" class="sidebar-link">ç™»å½•é¡µé¢æ ·å¼</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#å°ç¨‹åºè·å–æ‰‹æœºå·" class="sidebar-link">å°ç¨‹åºè·å–æ‰‹æœºå·</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/3-ç™»å½•é‰´æƒ.html#å‰åç«¯é€»è¾‘-è”è°ƒ" class="sidebar-link">å‰åç«¯é€»è¾‘&amp;è”è°ƒ</a></li></ul></li></ul></li><li><a href="/notes-page/project/community-miniapp/4-å‘è´´åŠŸèƒ½.html" class="sidebar-link">å‘è´´åŠŸèƒ½</a></li><li><a href="/notes-page/project/community-miniapp/5-æ–‡ç« è¯¦æƒ….html" class="sidebar-link">æ–‡ç« è¯¦æƒ…</a></li><li><a href="/notes-page/project/community-miniapp/6-æ¶ˆæ¯æ¨¡å—.html" class="sidebar-link">æ¶ˆæ¯æ¨¡å—</a></li><li><a href="/notes-page/project/community-miniapp/7-çƒ­é—¨æ¨¡å—.html" class="sidebar-link">çƒ­é—¨æ¨¡å—</a></li><li><a href="/notes-page/project/community-miniapp/8-ä¸ªäººä¸­å¿ƒ.html" class="sidebar-link">ä¸ªäººä¸­å¿ƒ</a></li><li><a href="/notes-page/project/community-miniapp/9-å‘å¸ƒä¸Šçº¿.html" class="sidebar-link">å‘å¸ƒä¸Šçº¿</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Flutter 2.0</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-flutter/" class="sidebar-link">flutter</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Electronæ¡Œé¢ç«¯</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-electron/" class="sidebar-link">electron</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Reactä¸–ç•Œ</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/react/" class="sidebar-link">Reacté¡¹ç›®</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="å°ç¨‹åºé‰´æƒç™»å½•"><a href="#å°ç¨‹åºé‰´æƒç™»å½•" class="header-anchor">#</a> å°ç¨‹åºé‰´æƒç™»å½•</h1> <h2 id="éœ€æ±‚åˆ†æ"><a href="#éœ€æ±‚åˆ†æ" class="header-anchor">#</a> éœ€æ±‚åˆ†æ</h2> <p>æµç¨‹åˆ†æï¼š</p> <p><img src="/notes-page/assets/img/api-login.2fcc9f35.2fcc9f35.jpg" alt="img"></p> <p>è¯´æ˜ï¼š</p> <ul><li>æ—¶åºå›¾çš„é˜…è¯»æ–¹å¼ï¼š
<ul><li>ææ¸…æ¥šæœ‰å‡ æ–¹ï¼Œå“ªå‡ ä¸ªé‡è¦çš„äº¤äº’éƒ¨åˆ†ï¼Œæ¯”å¦‚ï¼šä¸Šé¢æœ‰å°ç¨‹åºã€å¼€å‘æœåŠ¡å™¨ã€å°ç¨‹åºå®˜æ–¹åå°ï¼›</li> <li>ä»ä¸Šè‡³ä¸‹ï¼Œä»å·¦è‡³å³ï¼Œè·Ÿéšç®­å¤´çš„æ–¹å‘èµ°ï¼›</li> <li>æ—¶åºå›¾ä¸­ï¼Œä»»ä½•ä¸€ä¸ªæµç¨‹ä¸­æ–­ï¼Œåç»­çš„ç›¸å…³æµç¨‹ä¸ä¼šç»§ç»­è¿›è¡Œï¼›</li></ul></li></ul> <p>é€šè¿‡åˆ†æï¼Œæˆ‘ä»¬è·å–ç”¨æˆ·çš„ä¿¡æ¯ç”¨äºåˆ›å»ºç”¨æˆ·ï¼Œå¹¶é€šè¿‡è‡ªå·±çš„æœåŠ¡å™¨è¿”å›ç”¨æˆ·çš„ç™»å½•æ€ï¼Œå³tokenä¿¡æ¯ä¸ç”¨æˆ·ä¿¡æ¯ã€‚</p> <p>ç”¨æˆ·ä¿¡æ¯éœ€è¦è·¨é¡µé¢è¿›è¡Œå…±äº«ï¼ŒåŒæ—¶ï¼Œä¹Ÿéœ€è¦æŒä¹…åŒ–ï¼Œæ‰€ä»¥æƒ¯æ€§çš„æ€è€ƒåˆ°äº† vuex + æœ¬åœ°ç¼“å­˜çš„æ–¹æ¡ˆã€‚</p> <h2 id="vuexé›†æˆuniapp"><a href="#vuexé›†æˆuniapp" class="header-anchor">#</a> Vuexé›†æˆuniapp</h2> <h3 id="åˆå§‹åŒ–store"><a href="#åˆå§‹åŒ–store" class="header-anchor">#</a> åˆå§‹åŒ–store</h3> <p>é‡è¦ï¼šuniappä¸­å†…ç½®vuexï¼Œæ‰€ä»¥ç›´æ¥æŒ‰ç…§vueä¸­ä½¿ç”¨vuexçš„æ­¥éª¤è¿›è¡Œé›†æˆã€‚</p> <p>åˆ›å»ºæ–‡ä»¶<code>store/index.js</code>ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//vueçš„æ’ä»¶æœºåˆ¶</span>

<span class="token comment">//Vuex.Store æ„é€ å™¨é€‰é¡¹</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    state<span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token comment">//å­˜æ”¾çŠ¶æ€</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> store
</code></pre></div><p>åœ¨ <code>main.js</code> ä¸­å¯¼å…¥æ–‡ä»¶ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'./store'</span>

<span class="token comment">// æŠŠ store å¯¹è±¡æä¾›ç»™ â€œstoreâ€ é€‰é¡¹ï¼Œè¿™å¯ä»¥æŠŠ store çš„å®ä¾‹æ³¨å…¥æ‰€æœ‰çš„å­ç»„ä»¶</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    store<span class="token punctuation">,</span>
    <span class="token operator">...</span>App
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>stateä½¿ç”¨ä¸Šçš„åŒºåˆ«ï¼š</p> <ul><li>ç›´æ¥åœ¨templateä¸­ä¸èƒ½ä½¿ç”¨<code>$store</code>å–å€¼ï¼›</li> <li>åœ¨dataä¸­æ— æ³•ä½¿ç”¨<code>this.$store.state</code>å–å¯¹åº”çš„åˆå§‹å€¼ï¼›</li></ul> <p>æ­£ç¡®çš„æ‰“å¼€å§¿åŠ¿ï¼š</p> <ul><li>è¾…åŠ©å‡½æ•°ï¼ˆæ¨èï¼‰</li> <li>computedæ–¹æ³•</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// store.js</span>
<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
  count<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  msg<span class="token operator">:</span> <span class="token string">'hello Vuex'</span>
<span class="token punctuation">}</span>


<span class="token comment">// ç»„ä»¶ä¸­</span>
computed<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ–¹æ³•ä¸€ï¼šè¾…åŠ©å‡½æ•°</span>
  <span class="token comment">// ...mapState(['count']),</span>
  <span class="token comment">// ...mapState({</span>
  <span class="token comment">//   msg2: (state) =&gt; state.msg</span>
  <span class="token comment">// }),</span>
  <span class="token comment">// æ–¹æ³•äºŒï¼šcomputed</span>
  <span class="token function">count1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>count
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="å¦‚ä½•è¿›è¡Œè°ƒè¯•"><a href="#å¦‚ä½•è¿›è¡Œè°ƒè¯•" class="header-anchor">#</a> å¦‚ä½•è¿›è¡Œè°ƒè¯•</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span>
<span class="token keyword">import</span> createLogger <span class="token keyword">from</span> <span class="token string">'vuex/dist/logger'</span>

<span class="token comment">// è·å–æ‰§è¡Œç¯å¢ƒå˜é‡</span>
<span class="token keyword">const</span> debug <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span>
<span class="token comment">// console.log('ğŸš€ ~ file: index.js ~ line 5 ~ debug', debug)</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span>

<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
  count<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  msg<span class="token operator">:</span> <span class="token string">'hello Vuex'</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> mutations <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// æµ‹è¯•Mutation</span>
  <span class="token function">add</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>count <span class="token operator">+=</span> payload
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> actions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> getters <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// æ·»åŠ vuexæ—¥å¿—æ’ä»¶</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> debug <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token function">createLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  state<span class="token punctuation">,</span>
  mutations<span class="token punctuation">,</span>
  actions<span class="token punctuation">,</span>
  getters<span class="token punctuation">,</span>
  plugins
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> store
</code></pre></div><p>å½“æˆ‘ä»¬åœ¨é¡µé¢è§¦å‘mutationçš„æ—¶å€™ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'add'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
  <span class="token comment">// console.log(this.$store)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>å³å¯ä»¥æ”¶åˆ°consoleä¸­çš„æ‰“å°æ—¥å¿—ï¼š</p> <p><img src="/notes-page/assets/img/image-20210723135408789.c89a35bf.png" alt="image-20210723135408789"></p> <h2 id="å¾®ä¿¡å®˜æ–¹æœåŠ¡ç›¸å…³"><a href="#å¾®ä¿¡å®˜æ–¹æœåŠ¡ç›¸å…³" class="header-anchor">#</a> å¾®ä¿¡å®˜æ–¹æœåŠ¡ç›¸å…³</h2> <h3 id="è·å–appidä¸appsecret"><a href="#è·å–appidä¸appsecret" class="header-anchor">#</a> è·å–AppIDä¸AppSecret</h3> <p>ç™»å½•å°ç¨‹åºçš„åå° <a href="https://mp.weixin.qq.com/" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="/notes-page/assets/img/image-20210724102639423.71ad0747.png" alt="image-20210724102639423"></p> <h3 id="unionidä¸openid"><a href="#unionidä¸openid" class="header-anchor">#</a> unionidä¸openid</h3> <ul><li><p>ä»€ä¹ˆæ˜¯unionidï¼Œopenidï¼Ÿ</p> <p>openidæ˜¯ç”¨æˆ·åœ¨å½“å‰å°ç¨‹åºçš„å”¯ä¸€æ ‡è¯†ï¼›</p> <p>unionidæ˜¯ç”¨æˆ·åœ¨å¼€æ”¾å¹³å°çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œè‹¥å½“å‰å°ç¨‹åºå·²ç»‘å®šåˆ°å¾®ä¿¡å¼€æ”¾å¹³å°å¸å·ä¸‹ä¼šè¿”å›ï¼›</p></li> <li><p>ä¸¤è€…çš„åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿunionidçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p> <p>éƒ½æ˜¯å”¯ä¸€æ ‡è¯†ï¼Œé’ˆå¯¹çš„å¹³å°ä¸ä¸€æ ·ï¼Œopenidé’ˆå¯¹å°ç¨‹åºï¼Œunionidé’ˆå¯¹å¼€æ”¾å¹³å°ï¼›</p> <p>å¼€æ”¾å¹³å°æ˜¯æŒ‡ï¼š<a href="https://open.weixin.qq.com/" target="_blank" rel="noopener noreferrer">https://open.weixin.qq.com/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>å¦‚æœå¼€å‘è€…æ‹¥æœ‰å¤šä¸ªç§»åŠ¨åº”ç”¨ã€ç½‘ç«™åº”ç”¨ã€å’Œå…¬ä¼—å¸å·ï¼ˆåŒ…æ‹¬å°ç¨‹åºï¼‰ï¼Œå¯é€šè¿‡ UnionID æ¥åŒºåˆ†ç”¨æˆ·çš„å”¯ä¸€æ€§ï¼Œå› ä¸ºåªè¦æ˜¯åŒä¸€ä¸ªå¾®ä¿¡å¼€æ”¾å¹³å°å¸å·ä¸‹çš„ç§»åŠ¨åº”ç”¨ã€ç½‘ç«™åº”ç”¨å’Œå…¬ä¼—å¸å·ï¼ˆåŒ…æ‹¬å°ç¨‹åºï¼‰ï¼Œç”¨æˆ·çš„ UnionID æ˜¯å”¯ä¸€çš„ã€‚</p> <p><strong>æ¢å¥è¯è¯´ï¼ŒåŒä¸€ç”¨æˆ·ï¼Œå¯¹åŒä¸€ä¸ªå¾®ä¿¡å¼€æ”¾å¹³å°ä¸‹çš„ä¸åŒåº”ç”¨ï¼ŒUnionIDæ˜¯ç›¸åŒçš„ã€‚</strong></p> <p><strong>å¦‚æœæ²¡æœ‰å¾®ä¿¡ä¾§å¤šåº”ç”¨åœºæ™¯ï¼ˆå…¬ä¼—å·ã€å°ç¨‹åºã€ç½‘é¡µäº’é€šçš„éœ€æ±‚ï¼‰ï¼Œå¯ä»¥ä¸ç”¨å¼„è¿™ä¸ªå¼€æ”¾å¹³å°çš„è´¦å·ã€‚</strong></p></li> <li><p>unionIDå¦‚ä½•è·å–ï¼Ÿ</p> <p>ç»‘å®šäº†å¼€æ”¾å¹³å°å¼€å‘è€…å¸å·çš„å°ç¨‹åºï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹é€”å¾„è·å– UnionIDã€‚</p> <ol><li>å¼€å‘è€…å¯ä»¥ç›´æ¥é€šè¿‡ <a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html" target="_blank" rel="noopener noreferrer">wx.login<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> + <code>code2Session</code> è·å–åˆ°è¯¥ç”¨æˆ· UnionIDï¼Œæ— é¡»ç”¨æˆ·æˆæƒã€‚</li> <li>å°ç¨‹åºç«¯è°ƒç”¨äº‘å‡½æ•°æ—¶ï¼Œå¯åœ¨äº‘å‡½æ•°ä¸­é€šè¿‡ <a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/utils/Cloud.getWXContext.html" target="_blank" rel="noopener noreferrer">Cloud.getWXContext<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> è·å– UnionIDã€‚</li></ol></li> <li><p>å¼€æ”¾å¹³å°å¦‚ä½•æ³¨å†Œä¸ä½¿ç”¨ï¼Ÿ</p> <p>å¼€æ”¾å¹³å°éœ€è¦åœ¨<a href="https://open.weixin.qq.com/" target="_blank" rel="noopener noreferrer">å¼€æ”¾å¹³å°åœ°å€<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>æ³¨å†Œï¼ŒåŒæ—¶éœ€è¦è®¤è¯åæ‰èƒ½ä½¿ç”¨ã€‚</p> <p><img src="/notes-page/assets/img/image-20210724102333624.d28d20ad.png" alt="image-20210724102333624"></p> <p>è®¤è¯è´¹ç”¨300å…ƒï¼ˆxxxxé©¬xè…¾ï¼‰</p></li></ul> <h3 id="è·å–ç”¨æˆ·opendata"><a href="#è·å–ç”¨æˆ·opendata" class="header-anchor">#</a> è·å–ç”¨æˆ·OpenData</h3> <p>ç™»å½•å‡­è¯æ ¡éªŒï¼Œé€šè¿‡ <a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html" target="_blank" rel="noopener noreferrer">wx.login<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> æ¥å£è·å¾—ä¸´æ—¶ç™»å½•å‡­è¯ code åä¼ åˆ°å¼€å‘è€…æœåŠ¡å™¨è°ƒç”¨æ­¤æ¥å£å®Œæˆç™»å½•æµç¨‹ã€‚æ›´å¤šä½¿ç”¨æ–¹æ³•è¯¦è§ <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html" target="_blank" rel="noopener noreferrer">å°ç¨‹åºç™»å½•<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// è®°å½•å¾®ä¿¡ç›¸å…³çš„æ¥å£ï¼Œ APIé¡¹ç›® -&gt; å¾®ä¿¡å®˜æ–¹æœåŠ¡å™¨</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>
<span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">'@/config'</span>

<span class="token keyword">const</span> instance <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  timeout<span class="token operator">:</span> <span class="token number">10000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">wxGetOpenData</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> instance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.weixin.qq.com/sns/jscode2session?appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>AppID<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>AppSecret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;js_code=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;grant_type=authorization_code</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ğŸš€ ~ file: WxUtils.js ~ line 11 ~ wxGetOpenData ~ res'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="é‰´æƒé¡µé¢æ ·å¼"><a href="#é‰´æƒé¡µé¢æ ·å¼" class="header-anchor">#</a> é‰´æƒé¡µé¢æ ·å¼</h2> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>auth<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/images/logo.jpg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aspectFill<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>toimcæŠ€æœ¯ç¤¾åŒº<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>login<span class="token punctuation">&quot;</span></span> <span class="token attr-name">hover-class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>none<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-icon</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>weixin-fill<span class="token punctuation">&quot;</span></span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>32<span class="token punctuation">&quot;</span></span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#fff<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-icon</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>å¾®ä¿¡ç™»å½•<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-button</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-button</span> <span class="token attr-name">plain</span> <span class="token attr-name">:custom-style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>customStyle<span class="token punctuation">&quot;</span></span> <span class="token attr-name">hover-class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>none<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>goto<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>æ‰‹æœºå·ç™»å½•<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>forbid<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>leave<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>æš‚ä¸ç™»å½•<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-toast</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uToast<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> mapMutations<span class="token punctuation">,</span> mapGetters <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>
<span class="token keyword">import</span> auth <span class="token keyword">from</span> <span class="token string">'@/mixins/auth'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">data</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    customStyle<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'margin-top'</span><span class="token operator">:</span> <span class="token string">'40rpx'</span><span class="token punctuation">,</span>
      <span class="token string">'background-color'</span><span class="token operator">:</span> <span class="token string">'#fff'</span><span class="token punctuation">,</span>
      color<span class="token operator">:</span> <span class="token string">'#02d199'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  mixins<span class="token operator">:</span> <span class="token punctuation">[</span>auth<span class="token punctuation">]</span><span class="token punctuation">,</span>
  computed<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token function">mapGetters</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'isLogin'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token function">mapMutations</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'setIsLogin'</span><span class="token punctuation">,</span> <span class="token string">'setWxInfo'</span><span class="token punctuation">,</span> <span class="token string">'setToken'</span><span class="token punctuation">,</span> <span class="token string">'setUserInfo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">goto</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      uni<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url<span class="token operator">:</span> <span class="token string">'/subcom-pkg/auth/mobile-login'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">login</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è·å–ç”¨æˆ·ä¿¡æ¯</span>
      <span class="token comment">// todo</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">leave</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// todo</span>
      uni<span class="token punctuation">.</span><span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  watch<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>scss<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.title</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  <span class="token property">flex-flow</span><span class="token punctuation">:</span> column nowrap<span class="token punctuation">;</span>
  <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">justify-content</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 500rpx<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100vw<span class="token selector">;
  image</span> <span class="token punctuation">{</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 168rpx<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 168rpx<span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
    <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 0 10px <span class="token function">rgba</span><span class="token punctuation">(</span>$<span class="token property">color</span><span class="token punctuation">:</span> #000000<span class="token punctuation">,</span> $<span class="token property">alpha</span><span class="token punctuation">:</span> 0.1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">text</span> <span class="token punctuation">{</span>
    <span class="token property">margin-top</span><span class="token punctuation">:</span> 32rpx<span class="token punctuation">;</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 32rpx<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>
    <span class="token property">font-weight</span><span class="token punctuation">:</span> 500<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token selector">.container</span> <span class="token punctuation">{</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 32rpx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.forbid</span> <span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>
  <span class="token property">bottom</span><span class="token punctuation">:</span> 60px<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 28rpx<span class="token punctuation">;</span>
  <span class="token property">text-decoration</span><span class="token punctuation">:</span> underline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="è§£å¯†å¾®ä¿¡æ•°æ®"><a href="#è§£å¯†å¾®ä¿¡æ•°æ®" class="header-anchor">#</a> è§£å¯†å¾®ä¿¡æ•°æ®</h2> <h3 id="ç”¨æˆ·ä¿¡æ¯çš„è§£å¯†"><a href="#ç”¨æˆ·ä¿¡æ¯çš„è§£å¯†" class="header-anchor">#</a> ç”¨æˆ·ä¿¡æ¯çš„è§£å¯†</h3> <ul><li><p>å°ç¨‹åºè°ƒç”¨<code>getUserProfile</code>ï¼Œè·å–ç”¨æˆ·åŠ å¯†æ•°æ® + è¯ä¹¦ï¼Œè¯·æ±‚ç”¨æˆ·åå°ï¼›</p></li> <li><p>åå°è¿›è¡ŒåŠ å¯†æ•°æ®çš„æ ¡éªŒï¼Œç¡®å®šç”¨æˆ·ä¼ é€’çš„æ•°æ®æ˜¯å¾®ä¿¡ä¾§çš„æ•°æ®ï¼›</p> <p>signature = sha1( rawData + session_key )ç®—æ˜¯æ ¡éªŒæˆåŠŸï¼›</p></li> <li><p>åŠ å¯†æ•°æ®è§£å¯†ï¼Œå‚è€ƒå®˜æ–¹çš„<a href="https://res.wx.qq.com/wxdoc/dist/assets/media/aes-sample.eae1f364.zip" target="_blank" rel="noopener noreferrer">ä»£ç <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ï¼›</p></li></ul> <p>å®˜æ–¹è¯´æ˜<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html#%E5%8A%A0%E5%AF%86%E6%95%B0%E6%8D%AE%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95" target="_blank" rel="noopener noreferrer">é“¾æ¥<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="/notes-page/assets/img/signature.8a30a825.8a30a825.jpg" alt="img"></p> <p>ä»£ç ç¤ºä¾‹ï¼š</p> <p>å¾®ä¿¡è§£å¯†å·¥å…·jsï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> crypto <span class="token keyword">from</span> <span class="token string">'crypto'</span>

<span class="token keyword">function</span> <span class="token function">WXBizDataCrypt</span> <span class="token punctuation">(</span><span class="token parameter">appId<span class="token punctuation">,</span> sessionKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>appId <span class="token operator">=</span> appId
  <span class="token keyword">this</span><span class="token punctuation">.</span>sessionKey <span class="token operator">=</span> sessionKey
<span class="token punctuation">}</span>

<span class="token class-name">WXBizDataCrypt</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">decryptData</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">encryptedData<span class="token punctuation">,</span> iv</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// base64 decode</span>
  <span class="token keyword">let</span> sessionKey <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionKey<span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span>
  encryptedData <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>encryptedData<span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span>
  iv <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> decoded
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// è§£å¯†</span>
    <span class="token keyword">let</span> decipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createDecipheriv</span><span class="token punctuation">(</span><span class="token string">'aes-128-cbc'</span><span class="token punctuation">,</span> sessionKey<span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
    <span class="token comment">// è®¾ç½®è‡ªåŠ¨ padding ä¸º trueï¼Œåˆ é™¤å¡«å……è¡¥ä½</span>
    decipher<span class="token punctuation">.</span><span class="token function">setAutoPadding</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    decoded <span class="token operator">=</span> decipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>encryptedData<span class="token punctuation">,</span> <span class="token string">'binary'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
    decoded <span class="token operator">+=</span> decipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>

    decoded <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Illegal Buffer'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>decoded<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span>appid <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Illegal Buffer'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> decoded
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> WXBizDataCrypt
</code></pre></div><p>å¾®ä¿¡å·¥å…·jsçš„å°è£…ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// è®°å½•å¾®ä¿¡ç›¸å…³çš„æ¥å£ï¼Œ APIé¡¹ç›® -&gt; å¾®ä¿¡å®˜æ–¹æœåŠ¡å™¨</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>
<span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">'@/config'</span>
<span class="token keyword">import</span> crypto <span class="token keyword">from</span> <span class="token string">'crypto'</span>
<span class="token keyword">import</span> WXBizDataCrypt <span class="token keyword">from</span> <span class="token string">'./WXBizDataCrypt'</span>

<span class="token keyword">const</span> instance <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  timeout<span class="token operator">:</span> <span class="token number">10000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// è·å–session_keyï¼Œopenid ç­‰OpenDataæ•°æ®</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">wxGetOpenData</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// sessin_key, openid, unoinid</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> instance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.weixin.qq.com/sns/jscode2session?appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>AppID<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>AppSecret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;js_code=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;grant_type=authorization_code</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token comment">// console.log('ğŸš€ ~ file: WxUtils.js ~ line 11 ~ wxGetOpenData ~ res', res)</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span>data
<span class="token punctuation">}</span>

<span class="token comment">// è·å–è§£å¯†ç”¨æˆ·çš„ä¿¡æ¯</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">wxGetUserInfo</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.è·å–ç”¨æˆ·çš„openData -&gt; session_key</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">wxGetOpenData</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
  <span class="token keyword">const</span> sessionKey <span class="token operator">=</span> data<span class="token punctuation">.</span>session_key
  <span class="token comment">// 2.ç”¨æˆ·æ•°æ®è¿›è¡Œç­¾åæ ¡éªŒ -&gt; sha1 -&gt; session_key + rawData + signature</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> rawData<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> encryptedData<span class="token punctuation">,</span> iv <span class="token punctuation">}</span> <span class="token operator">=</span> user
  <span class="token keyword">const</span> sha1 <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">)</span>
  sha1<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>rawData<span class="token punctuation">)</span>
  sha1<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>sessionKey<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ ¡éªŒå¤±è´¥</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        code<span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">'ç­¾åæ ¡éªŒå¤±è´¥'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> wxBizDataCrypt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WXBizDataCrypt</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>AppID<span class="token punctuation">,</span> sessionKey<span class="token punctuation">)</span>
  <span class="token comment">// 3.ç”¨æˆ·åŠ å¯†æ•°æ®çš„è§£å¯†</span>
  <span class="token keyword">const</span> userInfo <span class="token operator">=</span> wxBizDataCrypt<span class="token punctuation">.</span><span class="token function">decryptData</span><span class="token punctuation">(</span>encryptedData<span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>userInfo<span class="token punctuation">,</span> <span class="token operator">...</span>data <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å°ç¨‹åºä¾§ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">login</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  uni<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> e<span class="token punctuation">.</span>code
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  uni<span class="token punctuation">.</span><span class="token function">getUserProfile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    lang<span class="token operator">:</span> <span class="token string">'zh_CN'</span><span class="token punctuation">,</span>
    desc<span class="token operator">:</span> <span class="token string">'ç”¨äºå®Œå–„ä¼šå‘˜èµ„æ–™'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ğŸš€ ~ file: auth.vue ~ line 37 ~ test ~ e'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$u<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">wxLogin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        code<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span>
        user<span class="token operator">:</span> e
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ğŸš€ ~ file: auth.vue ~ line 40 ~ test ~ e'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>éœ€è¦æ³¨æ„çš„ç‚¹ï¼š</p> <ul><li>uni.loginä¸éœ€è¦ç”¨æˆ·æ„ŸçŸ¥çš„è§¦å‘ä¸uni.getUserProfileéœ€è¦tapï¼ˆç”¨æˆ·ç‚¹å‡»ï¼‰äº‹ä»¶è§¦å‘ï¼›</li> <li>uni.loginä¸uni.getUserProfileå¦‚æœéœ€è¦åŒæ—¶ä½¿ç”¨ï¼Œå¯ä»¥éƒ½ä½¿ç”¨callbackå›è°ƒçš„å½¢å¼æ¥ä½¿ç”¨ï¼›</li></ul> <h3 id="ç”¨æˆ·ç™»å½•å‡­è¯ç»´æŠ¤"><a href="#ç”¨æˆ·ç™»å½•å‡­è¯ç»´æŠ¤" class="header-anchor">#</a> ç”¨æˆ·ç™»å½•å‡­è¯ç»´æŠ¤</h3> <p>é˜²æ­¢codeå¤±æ•ˆï¼Œè€Œè¯·æ±‚å¤±è´¥ã€‚</p> <p>è§£å†³åŠæ³•ï¼šå‰ç«¯è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”&lt;5åˆ†é’Ÿçš„æ—¶é—´ï¼Œè¯·æ±‚ä¸€æ¬¡<code>uni.login</code>åˆ·æ–°ç™»å½•å‡­è¯ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">data</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    code<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    ctrl<span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  computed<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">created</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNewCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCron</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onShow</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNewCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCron</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onHide</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctrl<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ç”¨æˆ·ç¦»å¼€å½“å‰é¡µé¢</span>
  <span class="token function">onUnload</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctrl<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–code</span>
    <span class="token function">getNewCode</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      uni<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> e<span class="token punctuation">.</span>code
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// è®¾ç½®å®šæ—¶ä»»åŠ¡</span>
    <span class="token function">setCron</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctrl<span class="token punctuation">)</span>
      <span class="token comment">// å®šæ—¶åˆ·æ–°codeçš„æ–¹æ³•</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctrl <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNewCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// é‡æ–°è¿›è¡Œcronï¼Œä¿è¯codeçš„æœ‰æ•ˆæ€§</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCron</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><h3 id="ç”¨æˆ·ç™»å½•æ¥å£"><a href="#ç”¨æˆ·ç™»å½•æ¥å£" class="header-anchor">#</a> ç”¨æˆ·ç™»å½•æ¥å£</h3> <p><strong>æ¥å£éƒ¨åˆ†:</strong></p> <p>äº§ç”Ÿtokenï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ç”Ÿæˆ token è¿”å›ç»™å®¢æˆ·ç«¯</span>
<span class="token keyword">const</span> generateToken <span class="token operator">=</span> <span class="token punctuation">(</span>payload<span class="token punctuation">,</span> expire <span class="token operator">=</span> <span class="token string">'1h'</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        <span class="token operator">...</span>payload<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      config<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> expiresIn<span class="token operator">:</span> expire <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'ç”Ÿæˆtokenå¤±è´¥ï¼'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>éšæœºç”¨æˆ·åï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">rand</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">len <span class="token operator">=</span> <span class="token number">8</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> possible <span class="token operator">=</span> <span class="token string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'</span>
  <span class="token keyword">let</span> text <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    text <span class="token operator">+=</span> possible<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> possible<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> text
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">getTempName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿”å›ç”¨æˆ·é‚®ç®±</span>
  <span class="token keyword">return</span> <span class="token string">'toimc_'</span> <span class="token operator">+</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'@toimc.com'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¾®ä¿¡è§£å¯†ç”¨æˆ·ä¿¡æ¯çš„<code>wxUtils.js</code>ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// è·å–è§£å¯†ç”¨æˆ·çš„ä¿¡æ¯</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">wxGetUserInfo</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.è·å–ç”¨æˆ·çš„openData -&gt; session_key</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">wxGetOpenData</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> session_key<span class="token operator">:</span> sessionKey <span class="token punctuation">}</span> <span class="token operator">=</span> data
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2.ç”¨æˆ·æ•°æ®è¿›è¡Œç­¾åæ ¡éªŒ -&gt; sha1 -&gt; session_key + rawData + signature</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> rawData<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> encryptedData<span class="token punctuation">,</span> iv <span class="token punctuation">}</span> <span class="token operator">=</span> user
    <span class="token keyword">const</span> sha1 <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">)</span>
    sha1<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>rawData<span class="token punctuation">)</span>
    sha1<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>sessionKey<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ ¡éªŒå¤±è´¥</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          code<span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
          msg<span class="token operator">:</span> <span class="token string">'ç­¾åæ ¡éªŒå¤±è´¥'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> wxBizDataCrypt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WXBizDataCrypt</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>AppID<span class="token punctuation">,</span> sessionKey<span class="token punctuation">)</span>
    <span class="token comment">// 3.ç”¨æˆ·åŠ å¯†æ•°æ®çš„è§£å¯†</span>
    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> wxBizDataCrypt<span class="token punctuation">.</span><span class="token function">decryptData</span><span class="token punctuation">(</span>encryptedData<span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>userInfo<span class="token punctuation">,</span> <span class="token operator">...</span>data<span class="token punctuation">,</span> errcode<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// data -&gt; errcodeé0 ï¼Œè¯·æ±‚å¤±è´¥</span>
    <span class="token keyword">return</span> data
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æŸ¥è¯¢å¹¶åˆ›å»ºç”¨æˆ·<code>User.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">findOrCreateByUnionid</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    unionid<span class="token operator">:</span> user<span class="token punctuation">.</span>unionid
    <span class="token comment">// openid: user.openid</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    unionid<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">obj</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      obj <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        openid<span class="token operator">:</span> user<span class="token punctuation">.</span>openid<span class="token punctuation">,</span>
        unionid<span class="token operator">:</span> user<span class="token punctuation">.</span>unionid<span class="token punctuation">,</span>
        username<span class="token operator">:</span> <span class="token function">getTempName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> user<span class="token punctuation">.</span>nickName<span class="token punctuation">,</span>
        roles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        gender<span class="token operator">:</span> user<span class="token punctuation">.</span>gender<span class="token punctuation">,</span>
        pic<span class="token operator">:</span> user<span class="token punctuation">.</span>avatarUrl<span class="token punctuation">,</span>
        location<span class="token operator">:</span> user<span class="token punctuation">.</span>city
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p><code>LoginController.js</code>å¾®ä¿¡ç™»å½•æ¥å£ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// å¾®ä¿¡ç™»å½•</span>
<span class="token keyword">async</span> <span class="token function">wxLogin</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.è§£å¯†ç”¨æˆ·ä¿¡æ¯</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> body <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request
  <span class="token comment">// console.log('ğŸš€ ~ file: LoginController.js ~ line 223 ~ LoginController ~ wxLogin ~ body', body)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> user<span class="token punctuation">,</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> body
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      code<span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token string">'æ²¡æœ‰è¶³å¤Ÿå‚æ•°'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">wxGetUserInfo</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>errcode <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2.æŸ¥è¯¢æ•°æ®åº“ -&gt; åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span>
    <span class="token comment">// 3.å¦‚æœä¸å­˜åœ¨ â€”&gt; åˆ›å»ºç”¨æˆ·</span>
    <span class="token comment">// 4.å¦‚æœå­˜åœ¨ -&gt; è·å–ç”¨æˆ·ä¿¡æ¯</span>
    <span class="token keyword">const</span> tmpUser <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOrCreateByUnionid</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token comment">// 5.äº§ç”Ÿtokenï¼Œè·å–ç”¨æˆ·çš„ç­¾åˆ°çŠ¶æ€</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id<span class="token operator">:</span> tmpUser<span class="token punctuation">.</span>_id <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">addSign</span><span class="token punctuation">(</span>tmpUser<span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      code<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> userInfo<span class="token punctuation">,</span>
      token
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">501</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>errcode <span class="token operator">===</span> <span class="token number">40163</span> <span class="token operator">?</span> <span class="token string">'codeå·²å¤±æ•ˆï¼Œè¯·åˆ·æ–°åé‡è¯•'</span> <span class="token operator">:</span> <span class="token string">'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è·å–access_tokenï¼Œå¹¶æŒ‰ä¸¤å°æ—¶ç»´æŠ¤ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">wxGetAccessToken</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">flag <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET</span>
  <span class="token keyword">let</span> accessToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">'accessToken'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>accessToken <span class="token operator">||</span> flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> instance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>AppID<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>AppSecret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¯´æ˜è¯·æ±‚æˆåŠŸ</span>
        <span class="token keyword">await</span> <span class="token function">setValue</span><span class="token punctuation">(</span>
          <span class="token string">'accessToken'</span><span class="token punctuation">,</span>
          result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>access_token<span class="token punctuation">,</span>
          result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>expires_in
        <span class="token punctuation">)</span>
        accessToken <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>access_token
        <span class="token comment">// {&quot;errcode&quot;:40013,&quot;errmsg&quot;:&quot;invalid appid&quot;}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>errcode <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>errmsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Wx-GetAccessToken Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>errcode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>errmsg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">GetAccessToken Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> accessToken
<span class="token punctuation">}</span>
</code></pre></div><p>ç»´æŠ¤<code>access_token</code>æ•°æ®ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> CronJob <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'cron'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> wxGetAccessToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./WxUtils'</span>

<span class="token keyword">const</span> job <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CronJob</span><span class="token punctuation">(</span><span class="token string">'* 55 */1 * * *'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">wxGetAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

job<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="æ‰‹æœºç™»å½•"><a href="#æ‰‹æœºç™»å½•" class="header-anchor">#</a> æ‰‹æœºç™»å½•</h2> <h3 id="å¦‚ä½•é€‰æ‹©çŸ­ä¿¡æœåŠ¡å•†"><a href="#å¦‚ä½•é€‰æ‹©çŸ­ä¿¡æœåŠ¡å•†" class="header-anchor">#</a> å¦‚ä½•é€‰æ‹©çŸ­ä¿¡æœåŠ¡å•†</h3> <p>æ¨èè…¾è®¯äº‘ã€é˜¿é‡Œäº‘ï¼Œä¸‹é¢ä»¥è…¾è®¯äº‘ä¸ºç¤ºä¾‹ï¼š</p> <p><img src="/notes-page/assets/img/image-20210726203051548.4d7929a2.png" alt="image-20210726203051548"></p> <p>åŸºæœ¬çš„ä½¿ç”¨æ­¥éª¤ï¼š</p> <ol><li>åˆ›å»ºäº‘å¹³å°è´¦å· -&gt; å®å -&gt; æ¨èå…¬å¸å®å</li> <li>å¤Ÿä¹°çŸ­ä¿¡åŒ… -&gt; æ·»åŠ çŸ­ä¿¡æ¨¡æ¿</li> <li>é›†æˆSDKå‘é€çŸ­ä¿¡</li></ol> <p>è…¾è®¯äº‘çš„ä¸¤ç§é›†æˆæ–¹å¼ï¼š</p> <ol><li>qcloudsms_jsï¼Œå‚è€ƒ<a href="https://github.com/qcloudsms/qcloudsms_js" target="_blank" rel="noopener noreferrer">githubä»“åº“<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Tencentcloud-sdk-nodejsï¼Œå‚è€ƒ<a href="https://cloud.tencent.com/document/product/382/43197" target="_blank" rel="noopener noreferrer">å®˜æ–¹æ–‡æ¡£<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <h3 id="ç™»å½•é¡µé¢æ ·å¼"><a href="#ç™»å½•é¡µé¢æ ·å¼" class="header-anchor">#</a> ç™»å½•é¡µé¢æ ·å¼</h3> <p><code>auth/mobile-login.vue</code>é¡µé¢</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>wrapper<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>ç™»å½•æ³¨å†Œæ›´ç²¾å½©<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>info<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>æœªæ³¨å†Œçš„æ‰‹æœºå·éªŒè¯åè‡ªåŠ¨åˆ›å»ºè´¦å·<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>form<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-form</span> <span class="token attr-name">label-width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>120<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-form-item</span> <span class="token attr-name">label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>æ‰‹æœºå·<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-input</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mobile<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>è¯·è¾“å…¥æ‰‹æœºå·<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-input</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name"><span class="token namespace">v-slot:</span>right</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">shape</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>circle<span class="token punctuation">&quot;</span></span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mini<span class="token punctuation">&quot;</span></span> <span class="token attr-name">hover-class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>none<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>è·å–æ‰‹æœºå·<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-button</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-form-item</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-form</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{<span class="token punctuation">'</span>deactive<span class="token punctuation">'</span>: !/^1[3-9]\d{9}$/.test(mobile)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">hover-class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>none<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getCode<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>è·å–éªŒè¯ç <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-button</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>navigator</span> <span class="token attr-name">open-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>navigateBack<span class="token punctuation">&quot;</span></span> <span class="token attr-name">hover-class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>none<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>footer u-flex u-col-center u-row-center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-icon</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>weixin-circle-fill<span class="token punctuation">&quot;</span></span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>120<span class="token punctuation">&quot;</span></span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#1BB723<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-icon</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>å¾®ä¿¡ç™»å½•<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>navigator</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> auth <span class="token keyword">from</span> <span class="token string">'@/mixins/auth'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  mixins<span class="token operator">:</span> <span class="token punctuation">[</span>auth<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">data</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    mobile<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    phoneNumber<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    loading<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">getCode</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å‘é€çŸ­ä¿¡éªŒè¯ç </span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>scss<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.wrapper</span> <span class="token punctuation">{</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 32rpx<span class="token selector">;
  .title</span> <span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 48rpx<span class="token punctuation">;</span>
    <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 50rpx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.info</span> <span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #666<span class="token punctuation">;</span>
    <span class="token property">line-height</span><span class="token punctuation">:</span> 28rpx<span class="token punctuation">;</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 24rpx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.form</span> <span class="token punctuation">{</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 40rpx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">::v-deep .btn</span> <span class="token punctuation">{</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 80rpx<span class="token selector">;
    &amp;.deactive</span> <span class="token punctuation">{</span>
      <span class="token selector">.u-btn--primary</span> <span class="token punctuation">{</span>
        <span class="token property">background-color</span><span class="token punctuation">:</span> #ccc<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token selector">.footer</span> <span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token property">bottom</span><span class="token punctuation">:</span> 120rpx<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100vw<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token selector">;
  text</span> <span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #666<span class="token punctuation">;</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 28rpx<span class="token punctuation">;</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 14rpx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>mobile-code.vue</code>é¡µé¢ï¼š</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>wrapper<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>è¾“å…¥éªŒè¯ç <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>info<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>éªŒè¯ç å·²å‘é€è‡³ {{mobile.substr(0,3)}}****{{mobile.substr(7,10)}} <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>inputs<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-message-input</span> <span class="token attr-name">:maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>6<span class="token punctuation">&quot;</span></span> <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bottomLine<span class="token punctuation">&quot;</span></span> <span class="token attr-name">active-color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#02d199<span class="token punctuation">&quot;</span></span> <span class="token attr-name">inactive-color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#DDD<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>90<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:bold</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:breathe</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:focus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-message-input</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>resend<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{<span class="token punctuation">'</span>disabled<span class="token punctuation">'</span>: sending}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>resend()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{msg}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> mapMutations <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">data</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    mobile<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    count<span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
    ctrl<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    sending<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">onLoad</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log('ğŸš€ ~ file: mobile-code.vue ~ line 15 ~ onLoad ~ options', options)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mobile <span class="token operator">=</span> options<span class="token punctuation">.</span>mobile
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCron</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token function">mapMutations</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'setToken'</span><span class="token punctuation">,</span> <span class="token string">'setUserInfo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">setCron</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctrl<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sending <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctrl <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">--</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">60</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>sending <span class="token operator">=</span> <span class="token boolean">false</span>
          <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctrl<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">resend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sending<span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$u<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        phone<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mobile
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// console.log('ğŸš€ ~ file: mobile-code.vue ~ line 75 ~ resend ~ res', res)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCron</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  computed<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">msg</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">'é‡æ–°è·å–'</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        str <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token string">'('</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'s)'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> str
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>scss<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.wrapper</span> <span class="token punctuation">{</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 32rpx<span class="token selector">;
  .title</span> <span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 48rpx<span class="token punctuation">;</span>
    <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 50rpx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.info</span> <span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #666<span class="token punctuation">;</span>
    <span class="token property">line-height</span><span class="token punctuation">:</span> 28rpx<span class="token punctuation">;</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 24rpx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.inputs</span> <span class="token punctuation">{</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 60rpx 0 40rpx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.resend</span> <span class="token punctuation">{</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 26rpx<span class="token punctuation">;</span>
    <span class="token property">font-weight</span><span class="token punctuation">:</span> 300<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #02d199<span class="token selector">;
    &amp;.disabled</span> <span class="token punctuation">{</span>
      <span class="token property">color</span><span class="token punctuation">:</span> #ddd<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="å°ç¨‹åºè·å–æ‰‹æœºå·"><a href="#å°ç¨‹åºè·å–æ‰‹æœºå·" class="header-anchor">#</a> å°ç¨‹åºè·å–æ‰‹æœºå·</h3> <p>å°ç¨‹åºä¾§é€»è¾‘ï¼š</p> <p>è®¾ç½®open-typeä¸º<code>getPhoneNumber</code>ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>u<span class="token operator">-</span>button type<span class="token operator">=</span><span class="token string">&quot;primary&quot;</span> shape<span class="token operator">=</span><span class="token string">&quot;circle&quot;</span> size<span class="token operator">=</span><span class="token string">&quot;mini&quot;</span> hover<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;none&quot;</span> open<span class="token operator">-</span>type<span class="token operator">=</span><span class="token string">&quot;getPhoneNumber&quot;</span> @getphonenumber<span class="token operator">=</span><span class="token string">&quot;getPhoneNumber&quot;</span><span class="token operator">&gt;</span>è·å–æ‰‹æœºå·<span class="token operator">&lt;</span><span class="token operator">/</span>u<span class="token operator">-</span>button<span class="token operator">&gt;</span>
</code></pre></div><p>getPhoneNumberæ–¹æ³•ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">getPhoneNumber</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> encryptedData<span class="token punctuation">,</span> iv <span class="token punctuation">}</span> <span class="token operator">=</span> value<span class="token punctuation">.</span>detail
  <span class="token comment">// value.detail + code</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$u<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">getMobile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    code<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span>
    encryptedData<span class="token punctuation">,</span>
    iv
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> phoneNumber<span class="token punctuation">,</span> purePhoneNumber<span class="token punctuation">,</span> countryCode <span class="token punctuation">}</span> <span class="token operator">=</span> data
    <span class="token keyword">if</span> <span class="token punctuation">(</span>countryCode <span class="token operator">!==</span> <span class="token string">'86'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        title<span class="token operator">:</span> <span class="token string">'Please use a cell phone number from mainland China'</span><span class="token punctuation">,</span>
        duration<span class="token operator">:</span> <span class="token number">2000</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>phoneNumber <span class="token operator">=</span> phoneNumber
    <span class="token keyword">this</span><span class="token punctuation">.</span>mobile <span class="token operator">=</span> purePhoneNumber
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      icon<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
      title<span class="token operator">:</span> <span class="token string">'è·å–æ‰‹æœºå·å¤±è´¥ï¼Œè¯·é‡è¯•'</span><span class="token punctuation">,</span>
      duration<span class="token operator">:</span> <span class="token number">2000</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// console.log('ğŸš€ ~ file: mobile-login.vue ~ line 48 ~ getPhoneNumber ~ res', res)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>APIæ¥å£è§£å¯†æ•°æ®ï¼š</p> <p>è®¾ç½®è·¯ç”±ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/getMobile'</span><span class="token punctuation">,</span> loginController<span class="token punctuation">.</span>getMobile<span class="token punctuation">)</span>
</code></pre></div><p>è·å–æ‰‹æœºå·<code>LoginController.js</code>ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// è·å–ç”¨æˆ·æ‰‹æœºå·</span>
<span class="token keyword">async</span> <span class="token function">getMobile</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> body <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request
  <span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> encryptedData<span class="token punctuation">,</span> iv <span class="token punctuation">}</span> <span class="token operator">=</span> body
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      code<span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token string">'æ²¡æœ‰è¶³å¤Ÿå‚æ•°'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> session_key<span class="token operator">:</span> sessionKey <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">wxGetOpenData</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
  <span class="token keyword">const</span> wxBizDataCrypt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WXBizDataCrypt</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>AppID<span class="token punctuation">,</span> sessionKey<span class="token punctuation">)</span>
  <span class="token comment">// 3.ç”¨æˆ·åŠ å¯†æ•°æ®çš„è§£å¯†</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> wxBizDataCrypt<span class="token punctuation">.</span><span class="token function">decryptData</span><span class="token punctuation">(</span>encryptedData<span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
  <span class="token comment">// console.log('ğŸš€ ~ file: LoginController.js ~ line 274 ~ LoginController ~ getMobile ~ data', data)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
    code<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    data<span class="token punctuation">,</span>
    msg<span class="token operator">:</span> <span class="token string">'è·å–æ‰‹æœºå·æˆåŠŸ'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="å‰åç«¯é€»è¾‘-è”è°ƒ"><a href="#å‰åç«¯é€»è¾‘-è”è°ƒ" class="header-anchor">#</a> å‰åç«¯é€»è¾‘&amp;è”è°ƒ</h3> <p>å°ç¨‹åºä¾§æ¥å£ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// è·å–ç”¨æˆ·æ‰‹æœºå·</span>
<span class="token keyword">const</span> <span class="token function-variable function">getMobile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login/getMobile'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

<span class="token comment">// å‘é€çŸ­ä¿¡</span>
<span class="token keyword">const</span> <span class="token function-variable function">sendCode</span> <span class="token operator">=</span> <span class="token parameter">params</span> <span class="token operator">=&gt;</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/public/sendCode'</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span>
</code></pre></div><p>å®Œæˆçš„æ‰‹æœºå‘é€éªŒè¯ç é¡µé¢</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>wrapper<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>ç™»å½•æ³¨å†Œæ›´ç²¾å½©<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>info<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>æœªæ³¨å†Œçš„æ‰‹æœºå·éªŒè¯åè‡ªåŠ¨åˆ›å»ºè´¦å·<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>form<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-form</span> <span class="token attr-name">label-width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>120<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-form-item</span> <span class="token attr-name">label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>æ‰‹æœºå·<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-input</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mobile<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>è¯·è¾“å…¥æ‰‹æœºå·<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-input</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name"><span class="token namespace">v-slot:</span>right</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">shape</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>circle<span class="token punctuation">&quot;</span></span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mini<span class="token punctuation">&quot;</span></span> <span class="token attr-name">hover-class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>none<span class="token punctuation">&quot;</span></span> <span class="token attr-name">open-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getPhoneNumber<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@getphonenumber</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getPhoneNumber<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>è·å–æ‰‹æœºå·<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-button</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-form-item</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-form</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{<span class="token punctuation">'</span>deactive<span class="token punctuation">'</span>: !/^1[3-9]\d{9}$/.test(mobile)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">hover-class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>none<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getCode<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>è·å–éªŒè¯ç <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-button</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>navigator</span> <span class="token attr-name">open-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>navigateBack<span class="token punctuation">&quot;</span></span> <span class="token attr-name">hover-class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>none<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>footer u-flex u-col-center u-row-center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-icon</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>weixin-circle-fill<span class="token punctuation">&quot;</span></span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>120<span class="token punctuation">&quot;</span></span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#1BB723<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-icon</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>å¾®ä¿¡ç™»å½•<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>navigator</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> auth <span class="token keyword">from</span> <span class="token string">'@/mixins/auth'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  mixins<span class="token operator">:</span> <span class="token punctuation">[</span>auth<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">data</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    mobile<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    phoneNumber<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    loading<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">getCode</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å‘é€çŸ­ä¿¡éªŒè¯ç </span>
      <span class="token comment">// é˜²æ­¢ç”¨æˆ·é¢‘ç¹å‘é€</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>loading<span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$u<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          mobile<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mobile
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æç¤ºç”¨æˆ·</span>
          uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            icon<span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
            title<span class="token operator">:</span> <span class="token string">'å‘é€æˆåŠŸ'</span><span class="token punctuation">,</span>
            duration<span class="token operator">:</span> <span class="token number">2000</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token comment">// å»¶è¿Ÿè·³è½¬åˆ°è¾“å…¥éªŒè¯ç çš„é¡µé¢</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            uni<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              url<span class="token operator">:</span> <span class="token string">'/subcom-pkg/auth/mobile-code?mobile='</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mobile
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            icon<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
            title<span class="token operator">:</span> <span class="token string">'çŸ­ä¿¡å‘é€å¤±è´¥'</span><span class="token punctuation">,</span>
            duration<span class="token operator">:</span> <span class="token number">2000</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">getPhoneNumber</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> encryptedData<span class="token punctuation">,</span> iv <span class="token punctuation">}</span> <span class="token operator">=</span> value<span class="token punctuation">.</span>detail
      <span class="token comment">// value.detail + code</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$u<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">getMobile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        code<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span>
        encryptedData<span class="token punctuation">,</span>
        iv
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> phoneNumber<span class="token punctuation">,</span> purePhoneNumber<span class="token punctuation">,</span> countryCode <span class="token punctuation">}</span> <span class="token operator">=</span> data
        <span class="token keyword">if</span> <span class="token punctuation">(</span>countryCode <span class="token operator">!==</span> <span class="token string">'86'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            title<span class="token operator">:</span> <span class="token string">'Please use a cell phone number from mainland China'</span><span class="token punctuation">,</span>
            duration<span class="token operator">:</span> <span class="token number">2000</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>phoneNumber <span class="token operator">=</span> phoneNumber
        <span class="token keyword">this</span><span class="token punctuation">.</span>mobile <span class="token operator">=</span> purePhoneNumber
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          icon<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
          title<span class="token operator">:</span> <span class="token string">'è·å–æ‰‹æœºå·å¤±è´¥ï¼Œè¯·é‡è¯•'</span><span class="token punctuation">,</span>
          duration<span class="token operator">:</span> <span class="token number">2000</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>scss<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.wrapper</span> <span class="token punctuation">{</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 32rpx<span class="token selector">;
  .title</span> <span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 48rpx<span class="token punctuation">;</span>
    <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 50rpx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.info</span> <span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #666<span class="token punctuation">;</span>
    <span class="token property">line-height</span><span class="token punctuation">:</span> 28rpx<span class="token punctuation">;</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 24rpx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.form</span> <span class="token punctuation">{</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 40rpx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">::v-deep .btn</span> <span class="token punctuation">{</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 80rpx<span class="token selector">;
    &amp;.deactive</span> <span class="token punctuation">{</span>
      <span class="token selector">.u-btn--primary</span> <span class="token punctuation">{</span>
        <span class="token property">background-color</span><span class="token punctuation">:</span> #ccc<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token selector">.footer</span> <span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token property">bottom</span><span class="token punctuation">:</span> 120rpx<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100vw<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token selector">;
  text</span> <span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #666<span class="token punctuation">;</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 28rpx<span class="token punctuation">;</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 14rpx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>æ ¡éªŒéªŒè¯ç çš„é¡µé¢ï¼š</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>wrapper<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>è¾“å…¥éªŒè¯ç <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>info<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>éªŒè¯ç å·²å‘é€è‡³ {{mobile.substr(0,3)}}****{{mobile.substr(7,10)}} <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>inputs<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u-message-input</span> <span class="token attr-name">:maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>6<span class="token punctuation">&quot;</span></span> <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bottomLine<span class="token punctuation">&quot;</span></span> <span class="token attr-name">active-color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#02d199<span class="token punctuation">&quot;</span></span> <span class="token attr-name">inactive-color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#DDD<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>90<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:bold</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:breathe</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:focus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@change</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>change<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u-message-input</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>resend<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{<span class="token punctuation">'</span>disabled<span class="token punctuation">'</span>: sending}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>resend()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{msg}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> mapMutations <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">data</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    mobile<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    count<span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
    ctrl<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    sending<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">onLoad</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mobile <span class="token operator">=</span> options<span class="token punctuation">.</span>mobile
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCron</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token function">mapMutations</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'setToken'</span><span class="token punctuation">,</span> <span class="token string">'setUserInfo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">setCron</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctrl<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sending <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctrl <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">--</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">60</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>sending <span class="token operator">=</span> <span class="token boolean">false</span>
          <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctrl<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">change</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\d{6}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$u<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">loginByPhone</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          mobile<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mobile<span class="token punctuation">,</span>
          code<span class="token operator">:</span> val
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            icon<span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
            title<span class="token operator">:</span> <span class="token string">'ç™»å½•æˆåŠŸï¼Œ2såè·³è½¬'</span><span class="token punctuation">,</span>
            duration<span class="token operator">:</span> <span class="token number">2000</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span> token<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> res
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setUserInfo</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            uni<span class="token punctuation">.</span><span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              delta<span class="token operator">:</span> <span class="token number">3</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            icon<span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
            title<span class="token operator">:</span> res<span class="token punctuation">.</span>msg<span class="token punctuation">,</span>
            duration<span class="token operator">:</span> <span class="token number">2000</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">resend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sending<span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$u<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        mobile<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mobile
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCron</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          icon<span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
          title<span class="token operator">:</span> res<span class="token punctuation">.</span>msg <span class="token operator">||</span> <span class="token string">'çŸ­ä¿¡å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'</span><span class="token punctuation">,</span>
          duration<span class="token operator">:</span> <span class="token number">2000</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  computed<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">msg</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">'é‡æ–°è·å–'</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        str <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token string">'('</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'s)'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> str
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>scss<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.wrapper</span> <span class="token punctuation">{</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 32rpx<span class="token selector">;
  .title</span> <span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 48rpx<span class="token punctuation">;</span>
    <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 50rpx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.info</span> <span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #666<span class="token punctuation">;</span>
    <span class="token property">line-height</span><span class="token punctuation">:</span> 28rpx<span class="token punctuation">;</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 24rpx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.inputs</span> <span class="token punctuation">{</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 60rpx 0 40rpx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">.resend</span> <span class="token punctuation">{</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 26rpx<span class="token punctuation">;</span>
    <span class="token property">font-weight</span><span class="token punctuation">:</span> 300<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #02d199<span class="token selector">;
    &amp;.disabled</span> <span class="token punctuation">{</span>
      <span class="token property">color</span><span class="token punctuation">:</span> #ddd<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>åç«¯æ¥å£<code>LoginController.js</code>ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// æ‰‹æœºå·ç™»å½•</span>
<span class="token keyword">async</span> <span class="token function">loginByPhone</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> body <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request
  <span class="token comment">// mobile + code</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> mobile<span class="token punctuation">,</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> body
  <span class="token comment">// éªŒè¯æ‰‹æœºå·ä¸çŸ­ä¿¡éªŒè¯ç çš„æ­£ç¡®æ€§</span>
  <span class="token keyword">const</span> sms <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getValue</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sms <span class="token operator">&amp;&amp;</span> sms <span class="token operator">===</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">delValue</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span>
    <span class="token comment">// æŸ¥è¯¢å¹¶åˆ›å»ºç”¨æˆ·</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOrCreateByMobile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      mobile
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦ç­¾åˆ°</span>
    <span class="token keyword">const</span> userObj <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">addSign</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token comment">// å“åº”ç”¨æˆ·</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      code<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
      token<span class="token operator">:</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id<span class="token operator">:</span> userObj<span class="token punctuation">.</span>_id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> userObj
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      code<span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
      msg<span class="token operator">:</span> <span class="token string">'æ‰‹æœºå·ä¸éªŒè¯ç ä¸åŒ¹é…'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æŸ¥è¯¢å¹¶åˆ›å»ºæ‰‹æœºç”¨æˆ·<code>User.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">findOrCreateByMobile</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mobile<span class="token operator">:</span> user<span class="token punctuation">.</span>mobile <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    unionid<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      mobile<span class="token operator">:</span> user<span class="token punctuation">.</span>mobile<span class="token punctuation">,</span>
      username<span class="token operator">:</span> <span class="token function">getTempName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token function">getTempName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      roles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>å‘é€éªŒè¯ç é€»è¾‘<code>PublicController.js</code>ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// å‘é€æ‰‹æœºéªŒè¯ç </span>
<span class="token keyword">async</span> <span class="token function">sendCode</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.è·å–æ‰‹æœºå· phone</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> mobile <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query
  <span class="token comment">// 2.æŸ¥è¯¢redis -&gt; åˆ¤æ–­æ˜¯å¦éªŒè¯ç è¿‡æœŸ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">getValue</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      code<span class="token operator">:</span> <span class="token number">501</span><span class="token punctuation">,</span>
      msg<span class="token operator">:</span> <span class="token string">'çŸ­ä¿¡æ­£åœ¨å‘é€ä¸­ï¼Œè¯·å‹¿é‡æ–°å‘é€'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 3.äº§ç”Ÿéšæœºçš„6ä½æ•°å­—</span>
  <span class="token keyword">const</span> sms <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span>
  <span class="token comment">// 4.å‘é€çŸ­ä¿¡ -&gt; è®¾ç½®redis -&gt; sms, expire -&gt; key:phone</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sendSms</span><span class="token punctuation">(</span>mobile<span class="token punctuation">,</span> sms<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>result <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setValue</span><span class="token punctuation">(</span>mobile<span class="token punctuation">,</span> sms<span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span>
    <span class="token comment">// 5.å“åº”</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      code<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
      msg<span class="token operator">:</span> <span class="token string">'å‘é€æˆåŠŸ'</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> res
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">'å‘é€çŸ­ä¿¡å¤±è´¥'</span> <span class="token operator">+</span> res<span class="token punctuation">.</span>errmsg <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>éœ€è¦æ³¨æ„çš„ç‚¹ï¼š</p> <ul><li><p>çŸ­ä¿¡å‘é€å¤±è´¥æ—¶ï¼š</p> <ul><li>é™åˆ¶ç”¨æˆ·é¢‘ç¹å‘é€-&gt; ä¸å½±å“é‡å‘ï¼›</li> <li>ç”¨æˆ·æç¤º -&gt; çŸ­ä¿¡å¤±è´¥åŸå›  -&gt; è¿™é‡Œå¤§éƒ¨åˆ†æ˜¯ç¬¬ä¸‰æ–¹æœåŠ¡å•†çš„é”™è¯¯æç¤ºï¼Œæ‰€ä»¥éœ€è¦ä¸“é—¨è¿›è¡Œå¤„ç†ï¼›</li> <li>çŸ­ä¿¡é™åˆ¶å‘é€æœºåˆ¶è®¾è®¡ï¼šä¸è®©æˆåŠŸå‘é€çŸ­ä¿¡ä¹‹åï¼Œè¿˜è®©ç”¨æˆ·é‡å¤å‘é€ -&gt; redisè®°å½•çŸ­ä¿¡æ•°æ®ï¼›</li></ul></li> <li><p>æ‰‹æœºç™»å½•æ¥å£ï¼š</p> <ul><li>å‘é€æˆåŠŸçŸ­ä¿¡åˆ™å“åº”ï¼Œå¹¶è®¾ç½®redisï¼Œå¦åˆ™ç›´æ¥throwé”™è¯¯ï¼›</li> <li>åˆ›å»ºç”¨æˆ·éœ€è¦ä½¿ç”¨findOneæ¥è¿›è¡ŒæŸ¥é‡ï¼›</li> <li>æ¥å£å‚æ•°éœ€è¦ä¸å‰ç«¯è¿›è¡Œä¸€ä¸€å¯¹åº”ï¼Œæœ€å¥½ä½¿ç”¨æ–‡æ¡£è¿›è¡Œçº¦å®šï¼›</li></ul></li></ul> <p>:::</p></div> <!----> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/notes-page/project/community-miniapp/2-é¦–é¡µæ¨¡å—.html" class="prev">
        é¦–é¡µæ¨¡å—
      </a></span> <span class="next"><a href="/notes-page/project/community-miniapp/4-å‘è´´åŠŸèƒ½.html">
        å‘è´´åŠŸèƒ½
      </a>
      â†’
    </span></p></div>  <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="dialog" class="el-dialog" style="margin-top:15vh;width:420px;"><div class="el-dialog__header"><span class="el-dialog__title"></span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><div class="el-dialog__footer"><span class="dialog-footer"><button type="button" class="el-button el-button--default"><!----><!----><span>å– æ¶ˆ</span></button> <button type="button" class="el-button el-button--primary"><!----><!----><span>ç¡® å®š</span></button></span></div></div></div></main> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/notes-page/assets/js/app.6a272afa.js" defer></script><script src="/notes-page/assets/js/4.89a9d4d5.js" defer></script><script src="/notes-page/assets/js/5.fc017d19.js" defer></script><script src="/notes-page/assets/js/18.d4ed5ee7.js" defer></script>
  </body>
</html>
